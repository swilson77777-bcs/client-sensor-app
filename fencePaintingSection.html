<!-- fencePaintingSection.html -->
<div id="fencingPaintingSection" style="display:block;">
    <div style="display: flex; gap: 5%; margin-top: 20px;">
        <!-- Fencing Information -->
        <div style="background-color: #d7ebf9; padding: 20px; border-radius: 10px; width: 45%;">
            <h3><strong>Fencing Information</strong></h3>
            <hr style="border: 2px solid #000000; width: 95%;">
            <input type="hidden" id="hiddenFpFirstName" name="fpFirstName" value="">
            <input type="hidden" id="hiddenFpLastName" name="fpLastName" value="">
            <input type="hidden" id="hiddenFpPhoneNumber" name="fpPhoneNumber" value="">
            <input type="hidden" id="hiddenFpEmail" name="fpEmail" value="">

            <label>Fence Type:</label><br>
            <select id="fenceType">
                <option value="">Select...</option>
                <option value="Privacy">Privacy</option>
                <option value="Picket">Picket</option>
                <option value="Chain Link">Chain Link</option>
                <option value="Wrought Iron">Wrought Iron</option>
                <option value="Vinyl">Vinyl</option>
                <option value="Aluminum">Aluminum</option>
                <option value="Composite">Composite</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Material:</label><br>
            <select id="fenceMaterial">
                <option value="">Select...</option>
                <option value="Wood">Wood</option>
                <option value="Vinyl">Vinyl</option>
                <option value="Metal">Metal</option>
                <option value="Composite">Composite</option>
                <option value="Stone">Stone</option>
                <option value="Concrete">Concrete</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Height:</label><br>
            <select id="fenceHeight">
                <option value="">Select...</option>
                <option value="3 ft">3 ft</option>
                <option value="4 ft">4 ft</option>
                <option value="5 ft">5 ft</option>
                <option value="6 ft">6 ft</option>
                <option value="7 ft">7 ft</option>
                <option value="8 ft">8 ft</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Color:</label><br>
            <select id="fenceColor">
                <option value="">Select...</option>
                <option value="Natural">Natural</option>
                <option value="White">White</option>
                <option value="Brown">Brown</option>
                <option value="Black">Black</option>
                <option value="Gray">Gray</option>
                <option value="Green">Green</option>
                <option value="Custom">Custom</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Style:</label><br>
            <select id="fenceStyle">
                <option value="">Select...</option>
                <option value="Traditional">Traditional</option>
                <option value="Modern">Modern</option>
                <option value="Rustic">Rustic</option>
                <option value="Decorative">Decorative</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Owner Status:</label><br>
            <select id="fenceOwnerStatus">
                <option value="">Select...</option>
                <option value="Primary">Primary</option>
                <option value="Secondary">Secondary</option>
                <option value="Tertiary">Tertiary</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Install Date:</label><br>
            <input type="date" id="fenceInstallDate"><br><br>
            
            <label>Warranty Expiration:</label><br>
            <input type="date" id="fenceWarrantyExp"><br><br>
            
            <label>Sales Rep:</label><br>
            <select id="fenceSalesRep">
                <option value="">Select Sales Rep</option>
                <option value="Angel Alvarez">Angel Alvarez</option>
                <option value="Esteban Alexander">Esteban Alexander</option>
                <option value="Lewis Robertson">Lewis Robertson</option>
                <option value="Scott Wilson">Scott Wilson</option>
                <option value="other">Other</option>
            </select>
            <input type="text" id="fenceSalesRepOther" style="display: none; margin-top: 5px;" placeholder="Enter Sales Rep Name">
        </div>
        
        <!-- Painting Information -->
        <div style="background-color: #d7ebf9; padding: 20px; border-radius: 10px; width: 45%;">
            <h3><strong>Painting Information</strong></h3>
            <hr style="border: 2px solid #000000; width: 95%;">
            
            <label>Paint Type:</label><br>
            <select id="paintingType">
                <option value="">Select...</option>
                <option value="Latex">Latex</option>
                <option value="Oil-based">Oil-based</option>
                <option value="Acrylic">Acrylic</option>
                <option value="Enamel">Enamel</option>
                <option value="Chalk">Chalk</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Color:</label><br>
            <select id="paintingColor">
                <option value="">Select...</option>
                <option value="White">White</option>
                <option value="Off-White">Off-White</option>
                <option value="Beige">Beige</option>
                <option value="Gray">Gray</option>
                <option value="Blue">Blue</option>
                <option value="Green">Green</option>
                <option value="Red">Red</option>
                <option value="Yellow">Yellow</option>
                <option value="Brown">Brown</option>
                <option value="Black">Black</option>
                <option value="Custom">Custom</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Brand:</label><br>
            <select id="paintingBrand">
                <option value="">Select...</option>
                <option value="Behr">Behr</option>
                <option value="Sherwin-Williams">Sherwin-Williams</option>
                <option value="Benjamin Moore">Benjamin Moore</option>
                <option value="Valspar">Valspar</option>
                <option value="PPG">PPG</option>
                <option value="Glidden">Glidden</option>
                <option value="Dunn-Edwards">Dunn-Edwards</option>
                <option value="Dutch Boy">Dutch Boy</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Finish:</label><br>
            <select id="paintingFinish">
                <option value="">Select...</option>
                <option value="Flat">Flat</option>
                <option value="Matte">Matte</option>
                <option value="Eggshell">Eggshell</option>
                <option value="Satin">Satin</option>
                <option value="Semi-Gloss">Semi-Gloss</option>
                <option value="Gloss">Gloss</option>
                <option value="High-Gloss">High-Gloss</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Area Painted:</label><br>
            <select id="paintingAreaPainted">
                <option value="">Select...</option>
                <option value="Exterior">Exterior</option>
                <option value="Interior">Interior</option>
                <option value="Both">Both</option>
                <option value="Specific Rooms">Specific Rooms</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Owner Status:</label><br>
            <select id="paintingOwnerStatus">
                <option value="">Select...</option>
                <option value="Primary">Primary</option>
                <option value="Secondary">Secondary</option>
                <option value="Tertiary">Tertiary</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Paint Date:</label><br>
            <input type="date" id="paintingDate"><br><br>
            
            <label>Warranty Expiration:</label><br>
            <input type="date" id="paintingWarrantyExp"><br><br>
            
            <label>Sales Rep:</label><br>
            <select id="paintingSalesRep">
                <option value="">Select Sales Rep</option>
                <option value="Angel Alvarez">Angel Alvarez</option>
                <option value="Esteban Alexander">Esteban Alexander</option>
                <option value="Lewis Robertson">Lewis Robertson</option>
                <option value="Scott Wilson">Scott Wilson</option>
                <option value="other">Other</option>
            </select>
            <input type="text" id="paintingSalesRepOther" style="display: none; margin-top: 5px;" placeholder="Enter Sales Rep Name">
        </div>
    </div>
    
    <!-- Referral Section -->
   <form id="fpForm" onsubmit="return false;">
   <div style="background-color: #f0f8ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd;">
    <h3 style="margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px;">Fence/Painting Referral</h3>
    
    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <div style="width: 48%;">
            <label for="fpFirstName">First Name:</label>
            <input type="text" id="fpFirstName" name="fpFirstName" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="width: 48%;">
            <label for="fpLastName">Last Name:</label>
            <input type="text" id="fpLastName" name="fpLastName" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
    </div>
    
    <div style="display: flex; justify-content: space-between;">
        <div style="width: 48%;">
            <label for="fpPhoneNumber">Phone:</label>
            <input type="tel" id="fpPhoneNumber" name="fpPhoneNumber" placeholder="(xxx) xxx-xxxx" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="width: 48%;">
            <label for="fpEmail">Email:</label>
            <input type="email" id="fpEmail" name="fpEmail" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
    </div>
</div>
</form>

    
    <!-- Notes Section -->
    <div style="margin-bottom: 20px;">
        <div style="margin-bottom: 10px;">
            <label for="fpNotes">Notes:</label>
            <textarea id="fpNotes" placeholder="Enter notes here..." style="width: 100%; height: 100px; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
            <div style="display: flex; justify-content: flex-end; margin-top: 5px;">
                <button id="fpAddNote" style="padding: 5px 10px; background-color: #f8f9fa; border: 1px solid #ccc; border-radius: 4px;">Add Note</button>
            </div>
        </div>
        
        <div>
            <p>Previous Notes:</p>
            <div id="fpPreviousNotes" style="background-color: #ffebee; padding: 10px; border-radius: 4px; min-height: 40px; margin-bottom: 10px;"></div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="fpSubmit" style="padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Submit</button>
                <button id="fpNewRecord" style="padding: 10px 20px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">New Record</button>
            </div>
        </div>
    </div>
    
    <!-- Documents/Images/Videos Section -->
    <div style="background-color: #f0f8ff; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
        <h3 style="margin-top: 0; margin-bottom: 15px;">Documents/Images/Videos</h3>
        
        <div>
            <button id="fpUpload" style="padding: 8px 20px; background-color: #f8f9fa; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px;">Upload</button>
            <button id="fpViewDownload" style="padding: 8px 20px; background-color: #f8f9fa; border: 1px solid #ccc; border-radius: 4px;">View/Download</button>
        </div>
        <div id="filesList"></div>
    </div>
    
   

    <script>

    const inputField = document.getElementById('fpFirstName');
    // Add event listener for input event
inputField.addEventListener('input', function() {
    console.log('Current fpFirstName value:', inputField.value);
});


    // Initialize the Fencing/Painting section
    document.addEventListener('DOMContentLoaded', function() {
        // Check if the user has the required license
        if (sessionStorage.getItem('keys2Valid') !== '1') {
            // If not, show a notification and hide the section
            showNotification('License required for Fencing/Painting feature', 'error');
            document.getElementById('fencingPaintingSection').style.display = 'none';
            return;
        }
        
        // Set up event listeners for the new UI elements
        setupFencingPaintingUI();
        
        // Initialize the original event handlers if they're still needed
        if (document.getElementById('fenceSalesRep')) {
            initializeFencingPaintingHandlers();
        }
    });
    
    function setupFencingPaintingUI() {
    // Debug logging on page load
    console.log('Checking referral fields on page load:');
    console.log('fpFirstName element:', document.getElementById('fpFirstName'));
    console.log('fpLastName element:', document.getElementById('fpLastName'));
    console.log('fpPhoneNumber element:', document.getElementById('fpPhoneNumber'));
    console.log('fpEmail element:', document.getElementById('fpEmail'));

    // Add event listeners to update hidden fields in the main form when user enters values
    const fpFirstNameInput = document.getElementById('fpFirstName');
    const fpLastNameInput = document.getElementById('fpLastName');
    const fpPhoneNumberInput = document.getElementById('fpPhoneNumber');
    const fpEmailInput = document.getElementById('fpEmail');

    // Function to update the currentRecordData hidden field
    function updateCurrentRecordData() {
        const recordDataField = document.getElementById('currentRecordData');
        if (recordDataField) {
            try {
                const currentData = recordDataField.value ? JSON.parse(recordDataField.value) : {};
                currentData.fpFirstName = fpFirstNameInput.value || '';
                currentData.fpLastName = fpLastNameInput.value || '';
                currentData.fpPhoneNumber = fpPhoneNumberInput.value || '';
                currentData.fpEmail = fpEmailInput.value || '';
                recordDataField.value = JSON.stringify(currentData);
                console.log('Updated currentRecordData with new values:', currentData);
            } catch (error) {
                console.error('Error updating currentRecordData:', error);
            }
        }
    }

    // Load values from sessionStorage on page load
    if (fpFirstNameInput && sessionStorage.getItem('fpFirstName')) {
        fpFirstNameInput.value = sessionStorage.getItem('fpFirstName');
        console.log('Loaded fpFirstName from sessionStorage:', sessionStorage.getItem('fpFirstName'));
    }
    if (fpLastNameInput && sessionStorage.getItem('fpLastName')) {
        fpLastNameInput.value = sessionStorage.getItem('fpLastName');
        console.log('Loaded fpLastName from sessionStorage:', sessionStorage.getItem('fpLastName'));
    }
    if (fpPhoneNumberInput && sessionStorage.getItem('fpPhoneNumber')) {
        fpPhoneNumberInput.value = sessionStorage.getItem('fpPhoneNumber');
        console.log('Loaded fpPhoneNumber from sessionStorage:', sessionStorage.getItem('fpPhoneNumber'));
    }
    if (fpEmailInput && sessionStorage.getItem('fpEmail')) {
        fpEmailInput.value = sessionStorage.getItem('fpEmail');
        console.log('Loaded fpEmail from sessionStorage:', sessionStorage.getItem('fpEmail'));
    }

    if (fpFirstNameInput) {
        fpFirstNameInput.addEventListener('input', function() {
            // Save to sessionStorage
            sessionStorage.setItem('fpFirstName', this.value);
            console.log('Saved fpFirstName to sessionStorage:', this.value);
            
            // Update hidden field for form submission
            const hiddenField = document.getElementById('hiddenFpFirstName');
            if (hiddenField) hiddenField.value = this.value;
            console.log('Updated hidden field hiddenFpFirstName with value:', this.value);
            
            // Update the currentRecordData hidden field
            updateCurrentRecordData();
        });
    }

    if (fpLastNameInput) {
        fpLastNameInput.addEventListener('input', function() {
            // Save to sessionStorage
            sessionStorage.setItem('fpLastName', this.value);
            console.log('Saved fpLastName to sessionStorage:', this.value);
            
            // Update hidden field for form submission
            const hiddenField = document.getElementById('hiddenFpLastName');
            if (hiddenField) hiddenField.value = this.value;
            console.log('Updated hidden field hiddenFpLastName with value:', this.value);
            
            // Update the currentRecordData hidden field
            updateCurrentRecordData();
        });
    }

    if (fpPhoneNumberInput) {
        fpPhoneNumberInput.addEventListener('input', function() {
            // Save to sessionStorage
            sessionStorage.setItem('fpPhoneNumber', this.value);
            console.log('Saved fpPhoneNumber to sessionStorage:', this.value);
            
            // Update hidden field for form submission
            const hiddenField = document.getElementById('hiddenFpPhoneNumber');
            if (hiddenField) hiddenField.value = this.value;
            console.log('Updated hidden field hiddenFpPhoneNumber with value:', this.value);
            
            // Update the currentRecordData hidden field
            updateCurrentRecordData();
        });
    }

    if (fpEmailInput) {
        fpEmailInput.addEventListener('input', function() {
            // Save to sessionStorage
            sessionStorage.setItem('fpEmail', this.value);
            console.log('Saved fpEmail to sessionStorage:', this.value);
            
            // Update hidden field for form submission
            const hiddenField = document.getElementById('hiddenFpEmail');
            if (hiddenField) hiddenField.value = this.value;
            console.log('Updated hidden field hiddenFpEmail with value:', this.value);
            
            // Update the currentRecordData hidden field
            updateCurrentRecordData();
        });
    }

    const submitBtn = document.getElementById('fpSubmit');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(event) {
            // CRITICAL: Prevent default form submission behavior
            event.preventDefault();
            
            // Get the current record ID
            const recordId = document.getElementById('recordId').value;
            
            if (!recordId) {
                showNotification('No record selected. Please search for a record first.', 'error');
                return false;
            }
            
            // Direct approach to get referral data - get values directly from input fields
            const fpFirstName = document.getElementById('fpFirstName').value;
            const fpLastName = document.getElementById('fpLastName').value;
            const fpPhoneNumber = document.getElementById('fpPhoneNumber').value;
            const fpEmail = document.getElementById('fpEmail').value;
            
            console.log('Direct referral values from input fields:');
            console.log('fpFirstName:', fpFirstName);
            console.log('fpLastName:', fpLastName);
            console.log('fpPhoneNumber:', fpPhoneNumber);
            console.log('fpEmail:', fpEmail);
            
            // Validate the data
            if (!fpFirstName || !fpLastName) {
                showNotification('Please enter referral first and last name', 'error');
                return false;
            }
            
            // Create a separate API call just for the referral data
            const referralData = {
                recordId: recordId,
                fpFirstName: fpFirstName,
                fpLastName: fpLastName,
                fpPhoneNumber: fpPhoneNumber,
                fpEmail: fpEmail
            };
            
            console.log('Sending referral data:', referralData);
            
            // Send just the referral data to a new endpoint
            fetch('/api/update-fp-referral', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(referralData)
            })
            .then(response => response.json())
            .then(result => {
                console.log('Referral update result:', result);
                if (result.success) {
                    showNotification('Referral data saved successfully', 'success');
                    
                    // IMPORTANT: Restore the values to the form fields
                    // This ensures they don't get reset
                    setTimeout(() => {
                        document.getElementById('fpFirstName').value = fpFirstName;
                        document.getElementById('fpLastName').value = fpLastName;
                        document.getElementById('fpPhoneNumber').value = fpPhoneNumber;
                        document.getElementById('fpEmail').value = fpEmail;
                        console.log('Restored form values after submission');
                    }, 100);
                    
                    // Update searchResults for consistency
                    if (window.searchResults && window.currentResultIndex >= 0) {
                        window.searchResults[window.currentResultIndex].fpFirstName = fpFirstName;
                        window.searchResults[window.currentResultIndex].fpLastName = fpLastName;
                        window.searchResults[window.currentResultIndex].fpPhoneNumber = fpPhoneNumber;
                        window.searchResults[window.currentResultIndex].fpEmail = fpEmail;
                        console.log('Updated searchResults with new referral values');
                    }
                    
                    // Update the currentRecordData hidden field with the new values
                    const recordDataField = document.getElementById('currentRecordData');
                    if (recordDataField) {
                        try {
                            const currentData = recordDataField.value ? JSON.parse(recordDataField.value) : {};
                            currentData.fpFirstName = fpFirstName;
                            currentData.fpLastName = fpLastName;
                            currentData.fpPhoneNumber = fpPhoneNumber;
                            currentData.fpEmail = fpEmail;
                            recordDataField.value = JSON.stringify(currentData);
                            console.log('Updated currentRecordData after successful submission');
                        } catch (error) {
                            console.error('Error updating currentRecordData:', error);
                        }
                    }
                } else {
                    showNotification('Error saving referral data: ' + result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving referral data:', error);
                showNotification('Error saving referral data', 'error');
            });
            
            // Prevent form submission
            return false;
        });
    }
    
    // New Record button functionality
    const newRecordBtn = document.getElementById('fpNewRecord');
    if (newRecordBtn) {
        newRecordBtn.addEventListener('click', function() {
            // Clear all form fields
            const formFields = [
                'fpFirstName', 
                'fpLastName', 
                'fpPhoneNumber', 
                'fpEmail', 
                'fpNotes'
            ];
            
            formFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            // Clear fence and painting fields
            const fenceFields = [
                'fenceType', 'fenceMaterial', 'fenceHeight', 'fenceColor', 
                'fenceStyle', 'fenceOwnerStatus', 'fenceInstallDate', 'fenceWarrantyExp'
            ];
            
            fenceFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            const paintingFields = [
                'paintingType', 'paintingColor', 'paintingBrand', 'paintingFinish',
                'paintingAreaPainted', 'paintingOwnerStatus', 'paintingDate', 'paintingWarrantyExp'
            ];
            
            paintingFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            // Reset sales rep fields
            const salesRepFields = ['fenceSalesRep', 'paintingSalesRep'];
            salesRepFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            const otherFields = ['fenceSalesRepOther', 'paintingSalesRepOther'];
            otherFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.value = '';
                    field.style.display = 'none';
                }
            });
            
            // Clear the notes list
            const notesList = document.getElementById('fpPreviousNotes');
            if (notesList) notesList.innerHTML = '';
            
            // Clear the files list
            const filesList = document.getElementById('filesList');
            if (filesList) filesList.innerHTML = '';
            
            // Also clear the hidden fields
            const hiddenFields = ['hiddenFpFirstName', 'hiddenFpLastName', 'hiddenFpPhoneNumber', 'hiddenFpEmail'];
            hiddenFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            // Clear sessionStorage
            sessionStorage.removeItem('fpFirstName');
            sessionStorage.removeItem('fpLastName');
            sessionStorage.removeItem('fpPhoneNumber');
            sessionStorage.removeItem('fpEmail');
            
            // Update the currentRecordData hidden field
            updateCurrentRecordData();
            
            showNotification('Form cleared for new record', 'success');
        });
    }
    
    // View/Download button functionality
    const viewDownloadBtn = document.getElementById('fpViewDownload');
    if (viewDownloadBtn) {
        viewDownloadBtn.addEventListener('click', function() {
            // In a real application, this would show a list of uploaded files
            if (document.getElementById('filesList').children.length === 0) {
                showNotification('No files have been uploaded yet', 'info');
            } else {
                showNotification('Viewing uploaded files', 'success');
            }
        });
    }
    
    // Set up file upload button
    const uploadBtn = document.getElementById('fpUpload');
    if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
            // Create a file input element if it doesn't exist
            let fileUpload = document.getElementById('fileUpload');
            if (!fileUpload) {
                fileUpload = document.createElement('input');
                fileUpload.type = 'file';
                fileUpload.id = 'fileUpload';
                fileUpload.style.display = 'none';
                fileUpload.multiple = true;
                document.body.appendChild(fileUpload);
                
                fileUpload.addEventListener('change', function() {
                    uploadFiles();
                });
            }
            
            // Trigger the file input click
            fileUpload.click();
        });
    }
    
    // Set up existing file upload input if it exists
    const fileUpload = document.getElementById('fileUpload');
    if (fileUpload) {
        fileUpload.addEventListener('change', function() {
            uploadFiles();
        });
    }
    
    // Add event listener for the Add Note button if it exists
    const addNoteBtn = document.getElementById('fpAddNote');
    if (addNoteBtn) {
        addNoteBtn.addEventListener('click', function() {
            addNote();
        });
    }
}




    // Helper function to update the currentRecordData hidden field
    function updateCurrentRecordDataField() {
        const recordDataField = document.getElementById('currentRecordData');
        if (recordDataField) {
            try {
                const currentData = recordDataField.value ? JSON.parse(recordDataField.value) : {};
                currentData.fpFirstName = fpFirstNameInput.value || '';
                currentData.fpLastName = fpLastNameInput.value || '';
                currentData.fpPhoneNumber = fpPhoneNumberInput.value || '';
                currentData.fpEmail = fpEmailInput.value || '';
                recordDataField.value = JSON.stringify(currentData);
                console.log('Updated currentRecordData with user-entered values');
            } catch (error) {
                console.error('Error updating currentRecordData:', error);
            }
        }
    }

    // Modify the MutationObserver to respect user input
    if (window.observer) {
        window.observer.disconnect();
        console.log('Disconnected existing MutationObserver');
    }

    window.observer = new MutationObserver((mutationsList, observer) => {
        for (const mutation of mutationsList) {
            if (mutation.type === 'childList') {
                const fencePaintingSection = document.getElementById('fencingPaintingSection');
                if (fencePaintingSection && fencePaintingSection.style.display !== 'none') {
                    console.log('Fence/Painting section loaded, checking if fields need population');
                    
                    // Wait a short moment for all elements to be fully rendered
                    setTimeout(() => {
                        // Only populate fields if user hasn't modified them
                        if (!userHasModifiedFields) {
                            const recordDataField = document.getElementById('currentRecordData');
                            if (recordDataField && recordDataField.value) {
                                try {
                                    const data = JSON.parse(recordDataField.value);
                                    console.log('Record data from hidden field:', data);
                                    
                                    // Populate the referral fields only if they're empty
                                    const setFieldValueIfEmpty = (id, value) => {
                                        const element = document.getElementById(id);
                                        if (element && (!element.value || element.value.trim() === '')) {
                                            element.value = value || '';
                                            console.log(`Set value for ${id}: ${value}`);
                                        } else if (element) {
                                            console.log(`Field ${id} already has value: ${element.value}, not overwriting`);
                                        } else {
                                            console.warn(`Element with ID ${id} not found`);
                                        }
                                    };
                                    
                                    setFieldValueIfEmpty('fpFirstName', data.fpFirstName);
                                    setFieldValueIfEmpty('fpLastName', data.fpLastName);
                                    setFieldValueIfEmpty('fpPhoneNumber', data.fpPhoneNumber);
                                    setFieldValueIfEmpty('fpEmail', data.fpEmail);
                                    
                                    console.log('Successfully populated empty referral fields from hidden field data');
                                } catch (error) {
                                    console.error('Error parsing record data:', error);
                                }
                            } else {
                                console.log('No record data available in hidden field or field not found');
                            }
                        } else {
                            console.log('User has modified fields, not overwriting with data from hidden field');
                        }
                    }, 100);
                    
                    break;
                }
            }
        }
    });

    // Start observing the body for added nodes
    window.observer.observe(document.body, { childList: true, subtree: true });
    console.log('Started new MutationObserver that respects user input');

    const submitBtn = document.getElementById('fpSubmit');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(event) {
            // Prevent default form submission behavior
            event.preventDefault();
            
            // Get the current record ID
            const recordId = document.getElementById('recordId').value;
            
            if (!recordId) {
                showNotification('No record selected. Please search for a record first.', 'error');
                return;
            }
            
            // Direct approach to get referral data
            const fpFirstName = document.getElementById('fpFirstName')?.value || '';
            const fpLastName = document.getElementById('fpLastName')?.value || '';
            const fpPhoneNumber = document.getElementById('fpPhoneNumber')?.value || '';
            const fpEmail = document.getElementById('fpEmail')?.value || '';
            
            console.log('Direct referral values:');
            console.log('fpFirstName:', fpFirstName);
            console.log('fpLastName:', fpLastName);
            console.log('fpPhoneNumber:', fpPhoneNumber);
            console.log('fpEmail:', fpEmail);
            
            // Validate the data
            if (!fpFirstName || !fpLastName) {
                showNotification('Please enter referral first and last name', 'error');
                return;
            }
            
            // Create a separate API call just for the referral data
            const referralData = {
                recordId: recordId,
                fpFirstName: fpFirstName,
                fpLastName: fpLastName,
                fpPhoneNumber: fpPhoneNumber,
                fpEmail: fpEmail
            };
            
            console.log('Sending referral data:', referralData);
            
            // Send just the referral data to a new endpoint
            fetch('/api/update-fp-referral', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(referralData)
            })
            .then(response => response.json())
            .then(result => {
                console.log('Referral update result:', result);
                if (result.success) {
                    showNotification('Referral data saved successfully', 'success');
                    
                    // Update the hidden fields in the main form
                    const hiddenFpFirstName = document.getElementById('hiddenFpFirstName');
                    const hiddenFpLastName = document.getElementById('hiddenFpLastName');
                    const hiddenFpPhoneNumber = document.getElementById('hiddenFpPhoneNumber');
                    const hiddenFpEmail = document.getElementById('hiddenFpEmail');
                    
                    if (hiddenFpFirstName) hiddenFpFirstName.value = fpFirstName;
                    if (hiddenFpLastName) hiddenFpLastName.value = fpLastName;
                    if (hiddenFpPhoneNumber) hiddenFpPhoneNumber.value = fpPhoneNumber;
                    if (hiddenFpEmail) hiddenFpEmail.value = fpEmail;
                    
                    // Also update the currentRecordData hidden field
                    const recordDataField = document.getElementById('currentRecordData');
                    if (recordDataField) {
                        const currentData = recordDataField.value ? JSON.parse(recordDataField.value) : {};
                        currentData.fpFirstName = fpFirstName;
                        currentData.fpLastName = fpLastName;
                        currentData.fpPhoneNumber = fpPhoneNumber;
                        currentData.fpEmail = fpEmail;
                        recordDataField.value = JSON.stringify(currentData);
                        console.log('Updated currentRecordData with new referral values');
                    }
                    
                    // If we have searchResults, update the current record there too
                    if (window.searchResults && window.currentResultIndex >= 0) {
                        window.searchResults[window.currentResultIndex].fpFirstName = fpFirstName;
                        window.searchResults[window.currentResultIndex].fpLastName = fpLastName;
                        window.searchResults[window.currentResultIndex].fpPhoneNumber = fpPhoneNumber;
                        window.searchResults[window.currentResultIndex].fpEmail = fpEmail;
                        console.log('Updated searchResults with new referral values');
                    }
                    
                    // Reset the userHasModifiedFields flag after successful save
                    userHasModifiedFields = false;
                } else {
                    showNotification('Error saving referral data: ' + result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving referral data:', error);
                showNotification('Error saving referral data', 'error');
            });
        });
    }
    
    // New Record button functionality
    const newRecordBtn = document.getElementById('fpNewRecord');
    if (newRecordBtn) {
        newRecordBtn.addEventListener('click', function() {
            // Clear all form fields
            const formFields = [
                'fpFirstName', 
                'fpLastName', 
                'fpPhoneNumber', 
                'fpEmail', 
                'fpNotes'
            ];
            
            formFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            // Clear fence and painting fields
            const fenceFields = [
                'fenceType', 'fenceMaterial', 'fenceHeight', 'fenceColor', 
                'fenceStyle', 'fenceOwnerStatus', 'fenceInstallDate', 'fenceWarrantyExp'
            ];
            
            fenceFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            const paintingFields = [
                'paintingType', 'paintingColor', 'paintingBrand', 'paintingFinish',
                'paintingAreaPainted', 'paintingOwnerStatus', 'paintingDate', 'paintingWarrantyExp'
            ];
            
            paintingFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            // Reset sales rep fields
            const salesRepFields = ['fenceSalesRep', 'paintingSalesRep'];
            salesRepFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            const otherFields = ['fenceSalesRepOther', 'paintingSalesRepOther'];
            otherFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.value = '';
                    field.style.display = 'none';
                }
            });
            
            // Clear the notes list
            const notesList = document.getElementById('fpPreviousNotes');
            if (notesList) notesList.innerHTML = '';
            
            // Clear the files list
            const filesList = document.getElementById('filesList');
            if (filesList) filesList.innerHTML = '';
            
            // Also clear the hidden fields
            const hiddenFields = ['hiddenFpFirstName', 'hiddenFpLastName', 'hiddenFpPhoneNumber', 'hiddenFpEmail'];
            hiddenFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            // Reset the userHasModifiedFields flag
            userHasModifiedFields = false;
            
            showNotification('Form cleared for new record', 'success');
        });
    }
    
    // View/Download button functionality
    const viewDownloadBtn = document.getElementById('fpViewDownload');
    if (viewDownloadBtn) {
        viewDownloadBtn.addEventListener('click', function() {
            // In a real application, this would show a list of uploaded files
            if (document.getElementById('filesList').children.length === 0) {
                showNotification('No files have been uploaded yet', 'info');
            } else {
                showNotification('Viewing uploaded files', 'success');
            }
        });
    }
    
    // Set up file upload button
    const uploadBtn = document.getElementById('fpUpload');
    if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
            // Create a file input element if it doesn't exist
            let fileUpload = document.getElementById('fileUpload');
            if (!fileUpload) {
                fileUpload = document.createElement('input');
                fileUpload.type = 'file';
                fileUpload.id = 'fileUpload';
                fileUpload.style.display = 'none';
                fileUpload.multiple = true;
                document.body.appendChild(fileUpload);
                
                fileUpload.addEventListener('change', function() {
                    uploadFiles();
                });
            }
            
            // Trigger the file input click
            fileUpload.click();
        });
    }
    
    // Set up existing file upload input if it exists
    const fileUpload = document.getElementById('fileUpload');
    if (fileUpload) {
        fileUpload.addEventListener('change', function() {
            uploadFiles();
        });
    }
    
    // Add event listener for the Add Note button if it exists
    const addNoteBtn = document.getElementById('fpAddNote');
    if (addNoteBtn) {
        addNoteBtn.addEventListener('click', function() {
            addNote();
        });
    }
}





    
    // Initialize event handlers for the Fencing/Painting section
    function initializeFencingPaintingHandlers() {
        // Handle "Other" option for Sales Reps
        document.getElementById('fenceSalesRep').addEventListener('change', function() {
            const otherInput = document.getElementById('fenceSalesRepOther');
            otherInput.style.display = this.value === 'other' ? 'block' : 'none';
        });
        
        document.getElementById('paintSalesRep').addEventListener('change', function() {
            const otherInput = document.getElementById('paintSalesRepOther');
            otherInput.style.display = this.value === 'other' ? 'block' : 'none';
        });
        
        // Initialize date fields with today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fenceInstallDate').value = today;
        document.getElementById('paintDate').value = today;
        
        // Calculate warranty expiration dates (assuming 1 year warranty)
        calculateWarrantyDates();
    }
    
    // Calculate warranty expiration dates
    function calculateWarrantyDates() {
        const fenceInstallDate = document.getElementById('fenceInstallDate');
        const fenceWarrantyExpiration = document.getElementById('fenceWarrantyExpiration');
        const paintDate = document.getElementById('paintDate');
        const paintWarrantyExpiration = document.getElementById('paintWarrantyExp');
        
        fenceInstallDate.addEventListener('change', function() {
            if (this.value) {
                const date = new Date(this.value);
                date.setFullYear(date.getFullYear() + 1);
                fenceWarrantyExpiration.value = date.toISOString().split('T')[0];
            }
        });
        
        paintDate.addEventListener('change', function() {
            if (this.value) {
                const date = new Date(this.value);
                date.setFullYear(date.getFullYear() + 1);
                paintWarrantyExpiration.value = date.toISOString().split('T')[0];
            }
        });
        
        // Trigger the change event to calculate initial values
        fenceInstallDate.dispatchEvent(new Event('change'));
        paintDate.dispatchEvent(new Event('change'));
    }
    
    // Add a note to the notes list
    function addNote() {
        const notesTextarea = document.getElementById('notesTextarea');
        const notesList = document.getElementById('notesList');
        
        if (notesTextarea.value.trim() === '') {
            showNotification('Please enter a note', 'error');
            return;
        }
        
        const now = new Date();
        const dateString = now.toLocaleDateString();
        const timeString = now.toLocaleTimeString();
        
        const noteDiv = document.createElement('div');
        noteDiv.style.padding = '10px';
        noteDiv.style.marginBottom = '10px';
        noteDiv.style.backgroundColor = '#f8f9fa';
        noteDiv.style.borderRadius = '5px';
        noteDiv.style.border = '1px solid #dee2e6';
        
        noteDiv.innerHTML = `
            <div style="font-weight: bold;">${dateString} ${timeString}</div>
            <div>${notesTextarea.value}</div>
        `;
        
        notesList.appendChild(noteDiv);
        notesTextarea.value = '';
    }
    
    // Upload files
    function uploadFiles() {
        const fileUpload = document.getElementById('fileUpload');
        const filesList = document.getElementById('filesList');
        
        if (fileUpload.files.length === 0) {
            showNotification('Please select files to upload', 'error');
            return;
        }
        
        // In a real application, you would upload the files to a server
        // For this example, we'll just display the file names
        for (let i = 0; i < fileUpload.files.length; i++) {
            const file = fileUpload.files[i];
            
            const fileDiv = document.createElement('div');
            fileDiv.style.padding = '10px';
            fileDiv.style.marginBottom = '10px';
            fileDiv.style.backgroundColor = '#f8f9fa';
            fileDiv.style.borderRadius = '5px';
            fileDiv.style.border = '1px solid #dee2e6';
            fileDiv.style.display = 'flex';
            fileDiv.style.justifyContent = 'space-between';
            fileDiv.style.alignItems = 'center';
            
            // Determine file type icon
            let fileIcon = '📄';
            if (file.type.startsWith('image/')) {
                fileIcon = '🖼️';
            } else if (file.type.startsWith('video/')) {
                fileIcon = '🎬';
            } else if (file.type.startsWith('audio/')) {
                fileIcon = '🔊';
            }
            
            fileDiv.innerHTML = `
                <div>
                    <span style="margin-right: 10px;">${fileIcon}</span>
                    <span>${file.name}</span>
                </div>
                <button type="button" class="btn btn-sm btn-danger" onclick="this.parentNode.remove()">Remove</button>
            `;
            
            filesList.appendChild(fileDiv);
        }
        
        // Clear the file input
        fileUpload.value = '';
        
        showNotification('Files uploaded successfully', 'success');
    }

    // Add this function to fencePaintingSection.html
    function getFencePaintingData() {
      return {
        fenceType: document.getElementById('fenceType').value,
        fenceMaterial: document.getElementById('fenceMaterial').value,
        fenceHeight: document.getElementById('fenceHeight').value,
        fenceColor: document.getElementById('fenceColor').value,
        fenceStyle: document.getElementById('fenceStyle').value,
        fenceOwnerStatus: document.getElementById('fenceOwnerStatus').value,
        fenceInstallDate: document.getElementById('fenceInstallDate').value,
        fenceWarrantyExp: document.getElementById('fenceWarrantyExp').value, // Changed from fenceWarrantyExp
        fenceSalesRep: document.getElementById('fenceSalesRep').value === 'other' 
          ? document.getElementById('fenceSalesRepOther').value 
          : document.getElementById('fenceSalesRep').value,
        
        paintingType: document.getElementById('paintingType').value, // Changed from paintingType
        paintingColor: document.getElementById('paintingColor').value, // Changed from paintingColor
        paintingBrand: document.getElementById('paintingBrand').value, // Changed from paintingBrand
        paintingFinish: document.getElementById('paintingFinish').value, // Changed from paintingFinish
        paintingAreaPainted: document.getElementById('paintingAreaPainted').value, // Changed from paintingAreaPainted
        paintingOwnerStatus: document.getElementById('paintingOwnerStatus').value, // Changed from paintingOwnerStatus
        paintingDate: document.getElementById('paintingDate').value, // Changed from paintingDate
        paintingWarrantyExp: document.getElementById('paintingWarrantyExp').value, // Changed from paintingWarrantyExp
        paintingSalesRep: document.getElementById('paintingSalesRep').value === 'other' // Changed from paintingSalesRep
          ? document.getElementById('paintingSalesRepOther').value // Changed from paintingSalesRepOther
          : document.getElementById('paintingSalesRep').value, // Changed from paintingSalesRep
    
        fpFirstName: document.getElementById('fpFirstName')?.value || '',
        fpLastName: document.getElementById('fpLastName')?.value || '',
        fpPhoneNumber: document.getElementById('fpPhoneNumber')?.value || '',
        fpEmail: document.getElementById('fpEmail')?.value || ''    
      };
    }

    // Make this function accessible globally
    window.getFencePaintingData = getFencePaintingData;

    // Add this function to fencePaintingSection.html
    function setFencePaintingData(data) {
      console.log('Setting fence/painting data:', data);
      console.log('Fence type from data:', data.fenceType);
      console.log('Paint type from data:', data.paintingType);
      
      // Helper function to safely set field values
      const setFieldValue = (id, value) => {
        const element = document.getElementById(id);
        if (!element) {
          console.warn(`Element with ID '${id}' not found.`);
          return;
        }
        
        // For select elements, use the special helper
        if (element.tagName === 'SELECT') {
          setSelectValue(element, value);
        } else {
          // For other elements (like input), just set the value directly
          element.value = value || '';
        }
      };

      // Set fence fields
      setFieldValue('fenceType', data.fenceType);
      setFieldValue('fenceMaterial', data.fenceMaterial);
      setFieldValue('fenceHeight', data.fenceHeight);
      setFieldValue('fenceColor', data.fenceColor);
      setFieldValue('fenceStyle', data.fenceStyle);
      setFieldValue('fenceOwnerStatus', data.fenceOwnerStatus);
      setFieldValue('fenceInstallDate', data.fenceInstallDate);
      setFieldValue('fenceWarrantyExp', data.fenceWarrantyExp);
      
      // Handle fence sales rep with "other" option
      const fenceSalesSelect = document.getElementById('fenceSalesRep');
      const fenceSalesOther = document.getElementById('fenceSalesRepOther');
      
      if (data.fenceSalesRep && fenceSalesSelect) {
        // Check if value exists in dropdown
        let valueExists = false;
        for (let i = 0; i < fenceSalesSelect.options.length; i++) {
          if (fenceSalesSelect.options[i].value === data.fenceSalesRep) {
            fenceSalesSelect.value = data.fenceSalesRep;
            valueExists = true;
            break;
          }
        }
        
        // If not in dropdown, use "other"
        if (!valueExists) {
          fenceSalesSelect.value = 'other';
          if (fenceSalesOther) {
            fenceSalesOther.value = data.fenceSalesRep;
            fenceSalesOther.style.display = 'block';
          }
        } else if (fenceSalesOther) {
          fenceSalesOther.style.display = 'none';
        }
      } else if (fenceSalesSelect) {
        fenceSalesSelect.value = '';
        if (fenceSalesOther) {
          fenceSalesOther.style.display = 'none';
        }
      }
      
      // Set painting fields - note the ID mismatches between HTML and database fields
      setFieldValue('paintingType', data.paintingType);
      setFieldValue('paintingColor', data.paintingColor);
      setFieldValue('paintingBrand', data.paintingBrand);
      setFieldValue('paintingFinish', data.paintingFinish);
      setFieldValue('paintingAreaPainted', data.paintingAreaPainted);
      setFieldValue('paintingOwnerStatus', data.paintingOwnerStatus);
      setFieldValue('paintingDate', data.paintingDate);
      setFieldValue('paintingWarrantyExp', data.paintingWarrantyExp);
      
      // Handle painting sales rep with "other" option
      const paintingSalesSelect = document.getElementById('paintingSalesRep');
      const paintingSalesOther = document.getElementById('paintingSalesRepOther');
      
      if (data.paintingSalesRep && paintingSalesSelect) {
        // Check if value exists in dropdown
        let valueExists = false;
        for (let i = 0; i < paintingSalesSelect.options.length; i++) {
          if (paintingSalesSelect.options[i].value === data.paintingSalesRep) {
            paintingSalesSelect.value = data.paintingSalesRep;
            valueExists = true;
            break;
          }
        }
        
        // If not in dropdown, use "other"
        if (!valueExists) {
          paintingSalesSelect.value = 'other';
          if (paintingSalesOther) {
            paintingSalesOther.value = data.paintingSalesRep;
            paintingSalesOther.style.display = 'block';
          }
        } else if (paintingSalesOther) {
          paintingSalesOther.style.display = 'none';
        }
      } else if (paintingSalesSelect) {
        paintingSalesSelect.value = '';
        if (paintingSalesOther) {
          paintingSalesOther.style.display = 'none';
        }
      }
      
      // Set referral fields
      setFieldValue('fpFirstName', data.fpFirstName);
      setFieldValue('fpLastName', data.fpLastName);
      setFieldValue('fpPhoneNumber', data.fpPhoneNumber);
      setFieldValue('fpEmail', data.fpEmail);
      console.log('FP First Name after setting:', document.getElementById('fpFirstName'));
      console.log('FP Last Name after setting:', document.getElementById('fpLastName'));

      console.log('Fence type element after setting:', document.getElementById('fenceType'));
      console.log('Fence type value after setting:', document.getElementById('fenceType').value);
    }

function setSelectValue(selectElement, value) {
  if (!selectElement) return;
  
  // If no value provided, just set to empty and return
  if (!value) {
    selectElement.value = '';
    return;
  }
  
  // Try to find if the value exists in the options
  let optionFound = false;
  for (let i = 0; i < selectElement.options.length; i++) {
    if (selectElement.options[i].value === value) {
      selectElement.value = value;
      optionFound = true;
      break;
    }
  }
  
  // If not found and value is non-empty, add new option
  if (!optionFound && value) {
    console.log('Adding new option for value:', value);
    let newOption = document.createElement('option');
    newOption.value = value;
    newOption.text = value;
    selectElement.add(newOption);
    
    // Force set the value after adding the option
    setTimeout(() => {
      selectElement.value = value;
      console.log('Value after setting:', selectElement.value);
    }, 0);
  }
}


    // Make this function accessible globally
    window.setFencePaintingData = setFencePaintingData;

    // Add event listener for the Add Note button
    document.getElementById('fpAddNote').addEventListener('click', addNote);
    </script>
</div>
