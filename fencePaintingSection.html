<!-- fencePaintingSection.html -->
<div id="fencingPaintingSection" style="display:block;">
    <div style="display: flex; gap: 5%; margin-top: 20px;">
        <!-- Fencing Information -->
        <div style="background-color: #d7ebf9; padding: 20px; border-radius: 10px; width: 45%;">
            <h3><strong>Fencing Information</strong></h3>
            <hr style="border: 2px solid #000000; width: 95%;">
            
            <label>Fence Type:</label><br>
            <select id="fenceType">
                <option value="">Select...</option>
                <option value="Privacy">Privacy</option>
                <option value="Picket">Picket</option>
                <option value="Chain Link">Chain Link</option>
                <option value="Wrought Iron">Wrought Iron</option>
                <option value="Vinyl">Vinyl</option>
                <option value="Aluminum">Aluminum</option>
                <option value="Composite">Composite</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Material:</label><br>
            <select id="fenceMaterial">
                <option value="">Select...</option>
                <option value="Wood">Wood</option>
                <option value="Vinyl">Vinyl</option>
                <option value="Metal">Metal</option>
                <option value="Composite">Composite</option>
                <option value="Stone">Stone</option>
                <option value="Concrete">Concrete</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Height:</label><br>
            <select id="fenceHeight">
                <option value="">Select...</option>
                <option value="3 ft">3 ft</option>
                <option value="4 ft">4 ft</option>
                <option value="5 ft">5 ft</option>
                <option value="6 ft">6 ft</option>
                <option value="7 ft">7 ft</option>
                <option value="8 ft">8 ft</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Color:</label><br>
            <select id="fenceColor">
                <option value="">Select...</option>
                <option value="Natural">Natural</option>
                <option value="White">White</option>
                <option value="Brown">Brown</option>
                <option value="Black">Black</option>
                <option value="Gray">Gray</option>
                <option value="Green">Green</option>
                <option value="Custom">Custom</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Style:</label><br>
            <select id="fenceStyle">
                <option value="">Select...</option>
                <option value="Traditional">Traditional</option>
                <option value="Modern">Modern</option>
                <option value="Rustic">Rustic</option>
                <option value="Decorative">Decorative</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Owner Status:</label><br>
            <select id="fenceOwnerStatus">
                <option value="">Select...</option>
                <option value="Primary">Primary</option>
                <option value="Secondary">Secondary</option>
                <option value="Tertiary">Tertiary</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Install Date:</label><br>
            <input type="date" id="fenceInstallDate"><br><br>
            
            <label>Warranty Expiration:</label><br>
            <input type="date" id="fenceWarrantyExp"><br><br>
            
            <label>Sales Rep:</label><br>
            <select id="fenceSalesRep">
                <option value="">Select Sales Rep</option>
                <option value="Angel Alvarez">Angel Alvarez</option>
                <option value="Esteban Alexander">Esteban Alexander</option>
                <option value="Lewis Robertson">Lewis Robertson</option>
                <option value="Scott Wilson">Scott Wilson</option>
                <option value="other">Other</option>
            </select>
            <input type="text" id="fenceSalesRepOther" style="display: none; margin-top: 5px;" placeholder="Enter Sales Rep Name">
        </div>
        
        <!-- Painting Information -->
        <div style="background-color: #d7ebf9; padding: 20px; border-radius: 10px; width: 45%;">
            <h3><strong>Painting Information</strong></h3>
            <hr style="border: 2px solid #000000; width: 95%;">
            
            <label>Paint Type:</label><br>
            <select id="paintingType">
                <option value="">Select...</option>
                <option value="Latex">Latex</option>
                <option value="Oil-based">Oil-based</option>
                <option value="Acrylic">Acrylic</option>
                <option value="Enamel">Enamel</option>
                <option value="Chalk">Chalk</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Color:</label><br>
            <select id="paintingColor">
                <option value="">Select...</option>
                <option value="White">White</option>
                <option value="Off-White">Off-White</option>
                <option value="Beige">Beige</option>
                <option value="Gray">Gray</option>
                <option value="Blue">Blue</option>
                <option value="Green">Green</option>
                <option value="Red">Red</option>
                <option value="Yellow">Yellow</option>
                <option value="Brown">Brown</option>
                <option value="Black">Black</option>
                <option value="Custom">Custom</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Brand:</label><br>
            <select id="paintingBrand">
                <option value="">Select...</option>
                <option value="Behr">Behr</option>
                <option value="Sherwin-Williams">Sherwin-Williams</option>
                <option value="Benjamin Moore">Benjamin Moore</option>
                <option value="Valspar">Valspar</option>
                <option value="PPG">PPG</option>
                <option value="Glidden">Glidden</option>
                <option value="Dunn-Edwards">Dunn-Edwards</option>
                <option value="Dutch Boy">Dutch Boy</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Finish:</label><br>
            <select id="paintingFinish">
                <option value="">Select...</option>
                <option value="Flat">Flat</option>
                <option value="Matte">Matte</option>
                <option value="Eggshell">Eggshell</option>
                <option value="Satin">Satin</option>
                <option value="Semi-Gloss">Semi-Gloss</option>
                <option value="Gloss">Gloss</option>
                <option value="High-Gloss">High-Gloss</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Area Painted:</label><br>
            <select id="paintingAreaPainted">
                <option value="">Select...</option>
                <option value="Exterior">Exterior</option>
                <option value="Interior">Interior</option>
                <option value="Both">Both</option>
                <option value="Specific Rooms">Specific Rooms</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Owner Status:</label><br>
            <select id="paintingOwnerStatus">
                <option value="">Select...</option>
                <option value="Primary">Primary</option>
                <option value="Secondary">Secondary</option>
                <option value="Tertiary">Tertiary</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label>Paint Date:</label><br>
            <input type="date" id="paintingDate"><br><br>
            
            <label>Warranty Expiration:</label><br>
            <input type="date" id="paintingWarrantyExp"><br><br>
            
            <label>Sales Rep:</label><br>
            <select id="paintingSalesRep">
                <option value="">Select Sales Rep</option>
                <option value="Angel Alvarez">Angel Alvarez</option>
                <option value="Esteban Alexander">Esteban Alexander</option>
                <option value="Lewis Robertson">Lewis Robertson</option>
                <option value="Scott Wilson">Scott Wilson</option>
                <option value="other">Other</option>
            </select>
            <input type="text" id="paintingSalesRepOther" style="display: none; margin-top: 5px;" placeholder="Enter Sales Rep Name">
        </div>
    </div>
    
    <!-- Referral Section -->
   
   <div style="background-color: #f0f8ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd;">
    <h3 style="margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px;">Fence/Painting Referral</h3>
    
    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <div style="width: 48%;">
            <label for="fpFirstName">First Name:</label>
            <input type="text" id="fpFirstName" name="fpFirstName" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="width: 48%;">
            <label for="fpLastName">Last Name:</label>
            <input type="text" id="fpLastName" name="fpLastName" required style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
    </div>
    
    <div style="display: flex; justify-content: space-between;">
        <div style="width: 48%;">
            <label for="fpPhoneNumber">Phone:</label>
            <input type="tel" id="fpPhoneNumber" name="fpPhoneNumber" placeholder="(xxx) xxx-xxxx" onkeyup="formatPhoneNumber(this)" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="width: 48%;">
            <label for="fpEmail">Email:</label>
            <input type="email" id="fpEmail" name="fpEmail" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
    </div>
</div>


    
    <!-- Notes Section -->
    <div style="margin-bottom: 20px;">
        <div style="margin-bottom: 10px;">
            <label for="fpNotes">Notes:</label>
            <textarea id="fpNotes" placeholder="Enter notes here..." style="width: 100%; height: 100px; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
            <div style="display: flex; justify-content: flex-end; margin-top: 5px;">
                <button id="fpAddNote" style="padding: 5px 10px; background-color: #f8f9fa; border: 1px solid #ccc; border-radius: 4px;">Add Note</button>
            </div>
        </div>
        
        <div>
            <p>Previous Notes:</p>
            <div id="fpPreviousNotes" style="background-color: #ffebee; padding: 10px; border-radius: 4px; min-height: 40px; margin-bottom: 10px;"></div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="fpSubmit" onclick="document.getElementById('clientForm').dispatchEvent(new Event('submit', {bubbles: true, cancelable: true}));" style="padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Submit</button>

                <button id="fpNewRecord" onclick="prepareNextUser()" style="padding: 10px 20px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">New Record</button>
                <button id="fpDeleteRecord" onclick="deleteRecord()" style="padding: 10px 20px; background-color: #FF0000; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">Delete Record</button>
            </div>
        </div>
    </div>
    
    <!-- Documents/Images/Videos Section -->
    <div style="background-color: #f0f8ff; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
        <h3 style="margin-top: 0; margin-bottom: 15px;">Documents/Images/Videos</h3>
        
        <div>
            <button id="fpUpload" onclick="openFpUploadModal()" style="padding: 8px 20px; background-color: #f8f9fa; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px;">Upload</button>
<button id="fpViewDownload" onclick="viewDownloadFpMedia()" style="padding: 8px 20px; background-color: #f8f9fa; border: 1px solid #ccc; border-radius: 4px;">View/Download</button>


        <div id="filesList"></div>
    </div>
    
   

    <script>

    /*  
    const inputField = document.getElementById('fpFirstName');
    // Add event listener for input event
inputField.addEventListener('input', function() {
    console.log('Current fpFirstName value:', inputField.value);
});
*/


    // Initialize the Fencing/Painting section
    document.addEventListener('DOMContentLoaded', function() {
        // Check if the user has the required license
        if (sessionStorage.getItem('keys2Valid') !== '1') {
            // If not, show a notification and hide the section
            showNotification('License required for Fencing/Painting feature', 'error');
            document.getElementById('fencingPaintingSection').style.display = 'none';
            return;
        }
        
        // Preload the fp fields section to avoid delays
        const fpSection = document.getElementById('fencingPaintingSection');
            if (fpSection) {
        // Ensure all fp fields are initialized
            ['fpFirstName', 'fpLastName', 'fpPhoneNumber', 'fpEmail'].forEach(id => {
            const field = document.getElementById(id);
            if (field) {
                // Add a data-loaded attribute to track initialization
                field.setAttribute('data-loaded', 'true');
            }
        });
    }

        // Set up event listeners for the new UI elements
        setupFencingPaintingUI();
        
        // Initialize the original event handlers if they're still needed
        if (document.getElementById('fenceSalesRep')) {
            initializeFencingPaintingHandlers();
        }
    });
    
    function setupFencingPaintingUI() {
    // Debug logging on page load
    console.log('Checking referral fields on page load:');
    console.log('fpFirstName element:', document.getElementById('fpFirstName'));
    console.log('fpLastName element:', document.getElementById('fpLastName'));
    console.log('fpPhoneNumber element:', document.getElementById('fpPhoneNumber'));
    console.log('fpEmail element:', document.getElementById('fpEmail'));

    // Get references to input fields
    const fpFirstNameInput = document.getElementById('fpFirstName');
    const fpLastNameInput = document.getElementById('fpLastName');
    const fpPhoneNumberInput = document.getElementById('fpPhoneNumber');
    const fpEmailInput = document.getElementById('fpEmail');
    
    loadFpNotes();
    
    // Add media upload and view/download buttons event listeners
const fpUploadBtn = document.getElementById('fpUpload');
if (fpUploadBtn) {
    console.log('Found Upload button:', fpUploadBtn);
    fpUploadBtn.addEventListener('click', function() {
        console.log('Upload button clicked');
        openFpUploadModal();
    });
}

const fpViewDownloadBtn = document.getElementById('fpViewDownload');
if (fpViewDownloadBtn) {
    console.log('Found View/Download button:', fpViewDownloadBtn);
    fpViewDownloadBtn.addEventListener('click', function() {
        console.log('View/Download button clicked');
        viewDownloadFpMedia();
    });
}
    
    // Submit button functionality
    const submitBtn = document.getElementById('fpSubmit');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(event) {
            // Prevent default form submission behavior
            event.preventDefault();
            
            // Get the current record ID
            const recordId = document.getElementById('recordId').value;
            
            if (!recordId) {
                showNotification('No record selected. Please search for a record first.', 'error');
                return false;
            }
            
            // Get ALL field values using the same function that gets the painting fields
            const allData = getFencePaintingData();
            
            console.log('Sending all fence/painting data:', allData);

            // Log the data being sent (for debugging)
            console.log('Sending data with fp fields:', {
                fpFirstName: allData.fpFirstName,
                fpLastName: allData.fpLastName,
                fpPhoneNumber: allData.fpPhoneNumber,
                fpEmail: allData.fpEmail
            });
            
            // Send to the main API endpoint
            fetch('/api/client', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    recordId: recordId,
                    username: document.getElementById('username')?.value || '',
                    firstName: document.getElementById('firstName')?.value || '',
                    lastName: document.getElementById('lastName')?.value || '',
                    streetAddress: document.getElementById('streetAddress')?.value || '',
                    city: document.getElementById('city')?.value || '',
                    state: document.getElementById('state')?.value || '',
                    zipCode: document.getElementById('zipCode')?.value || '',
                    phoneNumber: document.getElementById('phoneNumber')?.value || '',
                    email: document.getElementById('email')?.value || '',
                    customerNumber: document.getElementById('customerNumber')?.value || '',
                    customerurl: document.getElementById('customerurl')?.value || '',
                    ...allData
                })
            })
            .then(response => response.json())
            .then(result => {
                console.log('Update result:', result);
                if (result.message) {
                    showNotification('Data saved successfully', 'success');
                    loadFpNotes();
                } else {
                    showNotification('Error saving data: ' + (result.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error saving data:', error);
                showNotification('Error saving data', 'error');
            });
            
            return false;
        });
    }
    
    // New Record button functionality
    const newRecordBtn = document.getElementById('fpNewRecord');
    if (newRecordBtn) {
        newRecordBtn.addEventListener('click', function() {
            // Reset the field population flag when loading a new record
            window.disableFpFieldPopulation = false;
            
            // Clear all form fields
            const formFields = [
                'fpFirstName', 
                'fpLastName', 
                'fpPhoneNumber', 
                'fpEmail', 
                'fpNotes'
            ];
            
            formFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            // Clear fence and painting fields
            const fenceFields = [
                'fenceType', 'fenceMaterial', 'fenceHeight', 'fenceColor', 
                'fenceStyle', 'fenceOwnerStatus', 'fenceInstallDate', 'fenceWarrantyExp'
            ];
            
            fenceFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            const paintingFields = [
                'paintingType', 'paintingColor', 'paintingBrand', 'paintingFinish',
                'paintingAreaPainted', 'paintingOwnerStatus', 'paintingDate', 'paintingWarrantyExp'
            ];
            
            paintingFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            // Reset sales rep fields
            const salesRepFields = ['fenceSalesRep', 'paintingSalesRep'];
            salesRepFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            const otherFields = ['fenceSalesRepOther', 'paintingSalesRepOther'];
            otherFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.value = '';
                    field.style.display = 'none';
                }
            });
            
            // Clear the notes list
            const notesList = document.getElementById('fpPreviousNotes');
            if (notesList) notesList.innerHTML = '';
            
            // Clear the files list
            const filesList = document.getElementById('filesList');
            if (filesList) filesList.innerHTML = '';
            
            // Also clear the hidden fields
            const hiddenFields = ['hiddenFpFirstName', 'hiddenFpLastName', 'hiddenFpPhoneNumber', 'hiddenFpEmail'];
            hiddenFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            // Clear sessionStorage
            sessionStorage.removeItem('fpFirstName');
            sessionStorage.removeItem('fpLastName');
            sessionStorage.removeItem('fpPhoneNumber');
            sessionStorage.removeItem('fpEmail');
            
            // Update the currentRecordData hidden field
            const recordDataField = document.getElementById('currentRecordData');
            if (recordDataField) {
                try {
                    const currentData = recordDataField.value ? JSON.parse(recordDataField.value) : {};
                    currentData.fpFirstName = '';
                    currentData.fpLastName = '';
                    currentData.fpPhoneNumber = '';
                    currentData.fpEmail = '';
                    recordDataField.value = JSON.stringify(currentData);
                } catch (error) {
                    console.error('Error updating currentRecordData:', error);
                }
            }
            
            showNotification('Form cleared for new record', 'success');
        });
    }
    
    // Add event listener for the Add Note button if it exists
    const addNoteBtn = document.getElementById('fpAddNote');
    if (addNoteBtn) {
        addNoteBtn.addEventListener('click', function() {
            addFpNote();
        });
    }
}




    
    // Initialize event handlers for the Fencing/Painting section
    function initializeFencingPaintingHandlers() {
        // Handle "Other" option for Sales Reps
        document.getElementById('fenceSalesRep').addEventListener('change', function() {
            const otherInput = document.getElementById('fenceSalesRepOther');
            otherInput.style.display = this.value === 'other' ? 'block' : 'none';
        });
        
        document.getElementById('paintingSalesRep').addEventListener('change', function() {
            const otherInput = document.getElementById('paintingSalesRepOther');
            otherInput.style.display = this.value === 'other' ? 'block' : 'none';
        });
        
        // Initialize date fields with today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fenceInstallDate').value = today;
        document.getElementById('paintDate').value = today;
        
        // Calculate warranty expiration dates (assuming 1 year warranty)
        calculateWarrantyDates();
    }
    
    // Calculate warranty expiration dates
    function calculateWarrantyDates() {
        const fenceInstallDate = document.getElementById('fenceInstallDate');
        const fenceWarrantyExpiration = document.getElementById('fenceWarrantyExpiration');
        const paintDate = document.getElementById('paintDate');
        const paintWarrantyExpiration = document.getElementById('paintWarrantyExp');
        
        fenceInstallDate.addEventListener('change', function() {
            if (this.value) {
                const date = new Date(this.value);
                date.setFullYear(date.getFullYear() + 1);
                fenceWarrantyExpiration.value = date.toISOString().split('T')[0];
            }
        });
        
        paintDate.addEventListener('change', function() {
            if (this.value) {
                const date = new Date(this.value);
                date.setFullYear(date.getFullYear() + 1);
                paintWarrantyExpiration.value = date.toISOString().split('T')[0];
            }
        });
        
        // Trigger the change event to calculate initial values
        fenceInstallDate.dispatchEvent(new Event('change'));
        paintDate.dispatchEvent(new Event('change'));
    }
    
    // Add a note to the notes list

    // Add a note to the notes list
function addFpNote() {
    const notesTextarea = document.getElementById('fpNotes');
    const notesList = document.getElementById('fpPreviousNotes');
    
    if (!notesTextarea.value.trim()) {
        showNotification('Please enter a note', 'error');
        return;
    }
    
    // Get the current record data
    const recordId = document.getElementById('recordId').value;
    const streetAddress = document.getElementById('streetAddress').value;
    const customerNumber = document.getElementById('customerNumber').value;
    
    if (!streetAddress || !customerNumber) {
        showNotification('No client record selected', 'error');
        return;
    }
    
    const now = new Date();
    const timestamp = now.toISOString();
    const username = document.getElementById('loggedInUser') ? document.getElementById('loggedInUser').textContent : 'Unknown User';
    
    // Create note data
    const noteData = {
        fpStreetAddress: streetAddress,
        fpNote: notesTextarea.value,
        fpTimestamp: timestamp,
        fpAuthor: username,
        fpCreatedAt: timestamp,
        fpCustomerNumber: customerNumber
    };
    
    // Send note to server
    fetch('/api/fp-notes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(noteData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.message) {
            // Add note to the UI
            const noteDiv = document.createElement('div');
            noteDiv.style.padding = '10px';
            noteDiv.style.marginBottom = '10px';
            noteDiv.style.backgroundColor = '#f8f9fa';
            noteDiv.style.borderRadius = '5px';
            noteDiv.style.border = '1px solid #dee2e6';
            
            noteDiv.innerHTML = `
                <div style="border-bottom: 1px solid #eee; padding: 5px;">
    <strong>${now.toLocaleString()}</strong><br>
    ${notesTextarea.value}
</div>
`;
            
            notesList.insertBefore(noteDiv, notesList.firstChild);
            notesTextarea.value = '';
            
            showNotification('Note saved successfully', 'success');
        } else {
            showNotification('Error saving note: ' + (result.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error saving note:', error);
        showNotification('Error saving note', 'error');
    });
}


    // Load notes for the current address
function loadFpNotes() {
    const streetAddress = document.getElementById('streetAddress').value;
    const notesList = document.getElementById('fpPreviousNotes');
    
    if (!streetAddress) {
        console.log('No street address available to load notes');
        return;
    }
    
    console.log('Loading FP notes for address:', streetAddress);
    
    // Clear existing notes
    notesList.innerHTML = '';
    
    // Fetch notes from server
    fetch(`/api/fp-notes/${encodeURIComponent(streetAddress)}`)
        .then(response => response.json())
        .then(notes => {
            if (notes.length === 0) {
                notesList.innerHTML = '<div style="padding: 10px; color: #666;">No notes found for this address.</div>';
                return;
            }
            
            // Add each note to the UI
            notes.forEach(note => {
                const noteDate = new Date(note.fpTimestamp);
                const noteDiv = document.createElement('div');
                noteDiv.style.padding = '10px';
                noteDiv.style.marginBottom = '10px';
                noteDiv.style.backgroundColor = '#f8f9fa';
                noteDiv.style.borderRadius = '5px';
                noteDiv.style.border = '1px solid #dee2e6';
                
                noteDiv.innerHTML = `
                    <div style="border-bottom: 1px solid #eee; padding: 5px;">
                    <strong>${new Date(note.fpTimestamp).toLocaleString()}</strong><br>
                    ${note.fpNote}
                </div>

                `;
                
                notesList.appendChild(noteDiv);
            });
        })
        .catch(error => {
            console.error('Error loading notes:', error);
            notesList.innerHTML = '<div style="padding: 10px; color: red;">Error loading notes. Please try again.</div>';
        });
}

    
    // Upload files
    function uploadFiles() {
        const fileUpload = document.getElementById('fileUpload');
        const filesList = document.getElementById('filesList');
        
        if (fileUpload.files.length === 0) {
            showNotification('Please select files to upload', 'error');
            return;
        }
        
        // In a real application, you would upload the files to a server
        // For this example, we'll just display the file names
        for (let i = 0; i < fileUpload.files.length; i++) {
            const file = fileUpload.files[i];
            
            const fileDiv = document.createElement('div');
            fileDiv.style.padding = '10px';
            fileDiv.style.marginBottom = '10px';
            fileDiv.style.backgroundColor = '#f8f9fa';
            fileDiv.style.borderRadius = '5px';
            fileDiv.style.border = '1px solid #dee2e6';
            fileDiv.style.display = 'flex';
            fileDiv.style.justifyContent = 'space-between';
            fileDiv.style.alignItems = 'center';
            
            // Determine file type icon
            let fileIcon = 'ðŸ“„';
            if (file.type.startsWith('image/')) {
                fileIcon = 'ðŸ–¼ï¸';
            } else if (file.type.startsWith('video/')) {
                fileIcon = 'ðŸŽ¬';
            } else if (file.type.startsWith('audio/')) {
                fileIcon = 'ðŸ”Š';
            }
            
            fileDiv.innerHTML = `
                <div>
                    <span style="margin-right: 10px;">${fileIcon}</span>
                    <span>${file.name}</span>
                </div>
                <button type="button" class="btn btn-sm btn-danger" onclick="this.parentNode.remove()">Remove</button>
            `;
            
            filesList.appendChild(fileDiv);
        }
        
        // Clear the file input
        fileUpload.value = '';
        
        showNotification('Files uploaded successfully', 'success');
    }

// Add this function to fencePaintingSection.html
function getFencePaintingData() {
  // Log that we're collecting data to help with debugging
  console.log('Getting all fence/painting data including fp fields');
  
  // Create the data object with all fields
  const data = {
    fenceType: document.getElementById('fenceType')?.value || '',
    fenceMaterial: document.getElementById('fenceMaterial')?.value || '',
    fenceHeight: document.getElementById('fenceHeight')?.value || '',
    fenceColor: document.getElementById('fenceColor')?.value || '',
    fenceStyle: document.getElementById('fenceStyle')?.value || '',
    fenceOwnerStatus: document.getElementById('fenceOwnerStatus')?.value || '',
    fenceInstallDate: document.getElementById('fenceInstallDate')?.value || '',
    fenceWarrantyExp: document.getElementById('fenceWarrantyExp')?.value || '',
    fenceSalesRep: document.getElementById('fenceSalesRep')?.value === 'other' 
      ? document.getElementById('fenceSalesRepOther')?.value || ''
      : document.getElementById('fenceSalesRep')?.value || '',
    
    paintingType: document.getElementById('paintingType')?.value || '',
    paintingColor: document.getElementById('paintingColor')?.value || '',
    paintingBrand: document.getElementById('paintingBrand')?.value || '',
    paintingFinish: document.getElementById('paintingFinish')?.value || '',
    paintingAreaPainted: document.getElementById('paintingAreaPainted')?.value || '',
    paintingOwnerStatus: document.getElementById('paintingOwnerStatus')?.value || '',
    paintingDate: document.getElementById('paintingDate')?.value || '',
    paintingWarrantyExp: document.getElementById('paintingWarrantyExp')?.value || '',
    paintingSalesRep: document.getElementById('paintingSalesRep')?.value === 'other'
      ? document.getElementById('paintingSalesRepOther')?.value || ''
      : document.getElementById('paintingSalesRep')?.value || '',

    // Explicitly include the fp fields with proper error handling
    fpFirstName: document.getElementById('fpFirstName')?.value || '',
    fpLastName: document.getElementById('fpLastName')?.value || '',
    fpPhoneNumber: document.getElementById('fpPhoneNumber')?.value || '',
    fpEmail: document.getElementById('fpEmail')?.value || ''
  };
  
  // Log the fp fields specifically to verify they're being collected
  console.log('FP fields being collected:', {
    fpFirstName: data.fpFirstName,
    fpLastName: data.fpLastName,
    fpPhoneNumber: data.fpPhoneNumber,
    fpEmail: data.fpEmail
  });
  
  return data;
}

// Make this function accessible globally
window.getFencePaintingData = getFencePaintingData;


    // Add this function to fencePaintingSection.html
    function setFencePaintingData(data) {
      console.log('Setting fence/painting data:', data);
      console.log('Fence type from data:', data.fenceType);
      console.log('Paint type from data:', data.paintingType);

      // IMPORTANT: Add this check to ensure data is available
  if (!data) {
    console.warn('No data provided to setFencePaintingData');
    return;
  }
      
      // Helper function to safely set field values
      const setFieldValue = (id, value) => {
        const element = document.getElementById(id);
        if (!element) {
          console.warn(`Element with ID '${id}' not found.`);
          return;
        }
        
        // For select elements, use the special helper
        if (element.tagName === 'SELECT') {
          setSelectValue(element, value);
        } else {
          // For other elements (like input), just set the value directly
          element.value = value || '';
        }
      };

      // Set fence fields
      setFieldValue('fenceType', data.fenceType);
      setFieldValue('fenceMaterial', data.fenceMaterial);
      setFieldValue('fenceHeight', data.fenceHeight);
      setFieldValue('fenceColor', data.fenceColor);
      setFieldValue('fenceStyle', data.fenceStyle);
      setFieldValue('fenceOwnerStatus', data.fenceOwnerStatus);
      setFieldValue('fenceInstallDate', data.fenceInstallDate);
      setFieldValue('fenceWarrantyExp', data.fenceWarrantyExp);
      
      // Handle fence sales rep with "other" option
      const fenceSalesSelect = document.getElementById('fenceSalesRep');
      const fenceSalesOther = document.getElementById('fenceSalesRepOther');
      
      if (data.fenceSalesRep && fenceSalesSelect) {
        // Check if value exists in dropdown
        let valueExists = false;
        for (let i = 0; i < fenceSalesSelect.options.length; i++) {
          if (fenceSalesSelect.options[i].value === data.fenceSalesRep) {
            fenceSalesSelect.value = data.fenceSalesRep;
            valueExists = true;
            break;
          }
        }
        
        // If not in dropdown, use "other"
        if (!valueExists) {
          fenceSalesSelect.value = 'other';
          if (fenceSalesOther) {
            fenceSalesOther.value = data.fenceSalesRep;
            fenceSalesOther.style.display = 'block';
          }
        } else if (fenceSalesOther) {
          fenceSalesOther.style.display = 'none';
        }
      } else if (fenceSalesSelect) {
        fenceSalesSelect.value = '';
        if (fenceSalesOther) {
          fenceSalesOther.style.display = 'none';
        }
      }
      
      // Set painting fields - note the ID mismatches between HTML and database fields
      setFieldValue('paintingType', data.paintingType);
      setFieldValue('paintingColor', data.paintingColor);
      setFieldValue('paintingBrand', data.paintingBrand);
      setFieldValue('paintingFinish', data.paintingFinish);
      setFieldValue('paintingAreaPainted', data.paintingAreaPainted);
      setFieldValue('paintingOwnerStatus', data.paintingOwnerStatus);
      setFieldValue('paintingDate', data.paintingDate);
      setFieldValue('paintingWarrantyExp', data.paintingWarrantyExp);
      
      // Handle painting sales rep with "other" option
      const paintingSalesSelect = document.getElementById('paintingSalesRep');
      const paintingSalesOther = document.getElementById('paintingSalesRepOther');
      
      if (data.paintingSalesRep && paintingSalesSelect) {
        // Check if value exists in dropdown
        let valueExists = false;
        for (let i = 0; i < paintingSalesSelect.options.length; i++) {
          if (paintingSalesSelect.options[i].value === data.paintingSalesRep) {
            paintingSalesSelect.value = data.paintingSalesRep;
            valueExists = true;
            break;
          }
        }
        
        // If not in dropdown, use "other"
        if (!valueExists) {
          paintingSalesSelect.value = 'other';
          if (paintingSalesOther) {
            paintingSalesOther.value = data.paintingSalesRep;
            paintingSalesOther.style.display = 'block';
          }
        } else if (paintingSalesOther) {
          paintingSalesOther.style.display = 'none';
        }
      } else if (paintingSalesSelect) {
        paintingSalesSelect.value = '';
        if (paintingSalesOther) {
          paintingSalesOther.style.display = 'none';
        }
      }
      
      // Set referral fields
      setFieldValue('fpFirstName', data.fpFirstName);
      setFieldValue('fpLastName', data.fpLastName);
      setFieldValue('fpPhoneNumber', data.fpPhoneNumber);
      setFieldValue('fpEmail', data.fpEmail);

      loadFpNotes();
      console.log('FP First Name after setting:', document.getElementById('fpFirstName'));
      console.log('FP Last Name after setting:', document.getElementById('fpLastName'));

      console.log('Fence type element after setting:', document.getElementById('fenceType'));
      console.log('Fence type value after setting:', document.getElementById('fenceType').value);
    }

function setSelectValue(selectElement, value) {
  if (!selectElement) return;
  
  // If no value provided, just set to empty and return
  if (!value) {
    selectElement.value = '';
    return;
  }
  
  // Try to find if the value exists in the options
  let optionFound = false;
  for (let i = 0; i < selectElement.options.length; i++) {
    if (selectElement.options[i].value === value) {
      selectElement.value = value;
      optionFound = true;
      break;
    }
  }
  
  // If not found and value is non-empty, add new option
  if (!optionFound && value) {
    console.log('Adding new option for value:', value);
    let newOption = document.createElement('option');
    newOption.value = value;
    newOption.text = value;
    selectElement.add(newOption);
    
    // Force set the value after adding the option
    setTimeout(() => {
      selectElement.value = value;
      console.log('Value after setting:', selectElement.value);
    }, 0);
  }
}


    // Make this function accessible globally
    window.setFencePaintingData = setFencePaintingData;

    // Add event listener for the Add Note button
    document.getElementById('fpAddNote').addEventListener('click', addFpNote);

// Current customer media data
let fpCurrentCustomerMedia = {
  docs: [],
  images: [],
  videos: []
};

// Open the upload modal
function openFpUploadModal() {
  console.log('Testing upload click');
  resetFpUploadForm();
  document.getElementById('fpUploadModal').style.display = 'flex';
}

// Close the upload modal
function closeFpUploadModal() {
  document.getElementById('fpUploadModal').style.display = 'none';
}

// Reset the upload form
function resetFpUploadForm() {
  document.getElementById('fpFileInput').value = '';
  document.getElementById('fpTopicSelect').value = '';
  document.getElementById('fpMediaTypeSelect').value = '';
  document.getElementById('fpMediaDescription').value = '';
  document.getElementById('fpCustomerViewCheck').checked = false;
  document.getElementById('fpInternalViewCheck').checked = true;
  document.getElementById('fpUploadStatus').style.display = 'none';
}

// Submit the upload form
function submitFpUpload() {
  // Get form values
  const fileInput = document.getElementById('fpFileInput');
  const topic = document.getElementById('fpTopicSelect').value;
  const mediaType = document.getElementById('fpMediaTypeSelect').value;
  const description = document.getElementById('fpMediaDescription').value;
  const customerView = document.getElementById('fpCustomerViewCheck').checked ? 1 : 0;
  const internalView = document.getElementById('fpInternalViewCheck').checked ? 1 : 0;
  
  // Validate inputs
  if (!fileInput.files || fileInput.files.length === 0) {
    showFpUploadStatus('Please select a file to upload', 'error');
    return;
  }
  
  if (!topic) {
    showFpUploadStatus('Please select a topic (Fence or Paint)', 'error');
    return;
  }
  
  if (!mediaType) {
    showFpUploadStatus('Please select a media type (Document, Image, or Video)', 'error');
    return;
  }
  
  // Create FormData object for file upload
  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  formData.append('topic', topic);
  formData.append('mediaType', mediaType);
  formData.append('description', description);
  formData.append('customerView', customerView);
  formData.append('internalView', internalView);
  formData.append('customerNumber', document.getElementById('customerNumber').value);
  
  // Show uploading status
  showFpUploadStatus('Uploading, please wait...', 'info');
  
  // Send the upload request
  fetch('/api/fp-upload-media', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showFpUploadStatus('File uploaded successfully!', 'success');
      // Reset form after successful upload
      // resetFpUploadForm(); // Uncomment if you want to reset the form after upload
    } else {
      showFpUploadStatus(`Error: ${data.error}`, 'error');
    }
  })
  .catch(error => {
    showFpUploadStatus(`Upload failed: ${error.message}`, 'error');
  });
}

// Show upload status message
function showFpUploadStatus(message, type) {
  const statusElement = document.getElementById('fpUploadStatus');
  statusElement.textContent = message;
  statusElement.style.display = 'block';
  
  // Reset all styles
  statusElement.style.backgroundColor = '';
  statusElement.style.color = '';
  statusElement.style.padding = '10px';
  statusElement.style.borderRadius = '4px';
  statusElement.style.marginTop = '15px';
  statusElement.style.marginBottom = '15px';
  
  // Set color based on message type
  if (type === 'error') {
    statusElement.style.backgroundColor = '#f8d7da';
    statusElement.style.color = '#721c24';
  } else if (type === 'success') {
    statusElement.style.backgroundColor = '#e8f5e9';
    statusElement.style.color = '#155724';
  } else {
    statusElement.style.backgroundColor = '#f8f9fa';
    statusElement.style.color = '#0c5460';
  }
}

// Open the view/download modal
function viewDownloadFpMedia() {
  const customerNumber = document.getElementById('customerNumber').value;
  if (!customerNumber) {
    showNotification('Please enter a customer number', 'error');
    return;
  }
  
  // Helper function to safely set checkbox state
  const safeSetChecked = (id, value) => {
    const element = document.getElementById(id);
    if (element) element.checked = value === true || value === 1 || value === '1';
  };
  
  // Reset filters to checked state
  safeSetChecked('fpFilterDocs', true);
  safeSetChecked('fpFilterImages', true);
  safeSetChecked('fpFilterVideos', true);
  safeSetChecked('fpFilterFence', true);
  safeSetChecked('fpFilterPaint', true);
  
  // Clear previous data
  document.getElementById('fpDocumentsList').innerHTML = '<p class="loading-message">Loading documents...</p>';
  document.getElementById('fpImagesList').innerHTML = '<p class="loading-message">Loading images...</p>';
  document.getElementById('fpVideosList').innerHTML = '<p class="loading-message">Loading videos...</p>';
  
  // Show the modal
  document.getElementById('fpViewDownloadModal').style.display = 'flex';
  
  // Try to get customer info from existing data
  const firstName = document.getElementById('firstName')?.value || '';
  const lastName = document.getElementById('lastName')?.value || '';
  
  // Update the modal header with customer info
  const modalHeader = document.querySelector('#fpViewDownloadModal h3');
  if (modalHeader) {
    if (firstName && lastName) {
      modalHeader.innerHTML = `Fence/Painting Media Files <span style="font-weight: normal;">(${firstName} ${lastName}, Customer# ${customerNumber})</span>`;
    } else {
      modalHeader.innerHTML = `Fence/Painting Media Files <span style="font-weight: normal;">(Customer# - ${customerNumber})</span>`;
    }
  }
  
  // Fetch customer media
  fetchFpCustomerMedia(customerNumber);
}

// Close the view/download modal
function closeFpViewDownloadModal() {
  document.getElementById('fpViewDownloadModal').style.display = 'none';
}

// Fetch customer media files
function fetchFpCustomerMedia(customerNumber) {
  console.log('Fetching FP media for customer:', customerNumber);
  
  // Validate customer number
  if (!customerNumber) {
    showNotification('Customer number is required', 'error');
    return;
  }
  
  // Clear previous data
  fpCurrentCustomerMedia = {
    docs: [],
    images: [],
    videos: []
  };
  
  // Set loading indicators
  document.getElementById('fpDocumentsList').innerHTML = '<p class="no-items-message">Loading documents...</p>';
  document.getElementById('fpImagesList').innerHTML = '<p class="no-items-message">Loading images...</p>';
  document.getElementById('fpVideosList').innerHTML = '<p class="no-items-message">Loading videos...</p>';
  
  // Fetch documents
  fetch(`/api/fp-customer-docs/${customerNumber}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      fpCurrentCustomerMedia.docs = data.docs || [];
      displayFpMediaItems('docs');
    })
    .catch(error => {
      console.error('Error fetching FP documents:', error);
      document.getElementById('fpDocumentsList').innerHTML = 
        `<p class="no-items-message">Error loading documents: ${error.message}</p>`;
    });
  
  // Fetch images
  fetch(`/api/fp-customer-images/${customerNumber}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      fpCurrentCustomerMedia.images = data.images || [];
      displayFpMediaItems('images');
    })
    .catch(error => {
      console.error('Error fetching FP images:', error);
      document.getElementById('fpImagesList').innerHTML = 
        `<p class="no-items-message">Error loading images: ${error.message}</p>`;
    });
  
  // Fetch videos
  fetch(`/api/fp-customer-videos/${customerNumber}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      fpCurrentCustomerMedia.videos = data.videos || [];
      displayFpMediaItems('videos');
    })
    .catch(error => {
      console.error('Error fetching FP videos:', error);
      document.getElementById('fpVideosList').innerHTML = 
        `<p class="no-items-message">Error loading videos: ${error.message}</p>`;
    });
}

// Display media items
function displayFpMediaItems(mediaType) {
  const items = fpCurrentCustomerMedia[mediaType];
  const containerId = mediaType === 'docs' ? 'fpDocumentsList' : 
                      mediaType === 'images' ? 'fpImagesList' : 'fpVideosList';
  const container = document.getElementById(containerId);
  const customerNumber = document.getElementById('customerNumber').value;
  
  if (!items || items.length === 0) {
    container.innerHTML = `<p class="no-items-message">No ${mediaType} found</p>`;
    return;
  }

  // Group items by category
  const groupedItems = {
    Fence: [],
    Paint: []
  };

  items.forEach(item => {
    if (groupedItems[item.category]) {
      groupedItems[item.category].push(item);
    }
  });

  let html = '';
  
  // Create containers for each category
  for (const [category, categoryItems] of Object.entries(groupedItems)) {
    if (categoryItems.length === 0) continue;

    html += `
      <div class="media-category-container" style="margin-bottom: 30px; border: 2px solid black; padding: 10px;">
        <h4 class="media-type-title" style="background-color: #b3e0e5; border-bottom: 4px solid #000; padding-bottom: 5px;">
          ${category} ${mediaType.charAt(0).toUpperCase() + mediaType.slice(1)}
        </h4>
    `;

    categoryItems.forEach(item => {
      // Convert mediaType to server-expected format
      const serverMediaType = 
        mediaType === 'docs' ? 'Document' : 
        mediaType === 'images' ? 'Image' : 
        mediaType === 'videos' ? 'Video' : mediaType;

      // Add data-type and data-category attributes for filtering
      html += `
        <div class="media-item" style="margin: 10px 0; padding: 10px; border: 1px solid #eee;" 
             data-category="${item.category}" data-type="${mediaType === 'docs' ? 'doc' : mediaType.slice(0, -1)}">
          <div style="font-weight: bold;">${item.filename}</div>
          <div style="color: #666; font-size: 0.9em;">${item.description}</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <button onclick="downloadFpMedia('${serverMediaType}', '${item.category}', '${customerNumber}')" 
                      class="btn btn-primary btn-sm">
                Download
              </button>
              <button onclick="deleteFpMedia('${serverMediaType}', '${item.category}', '${customerNumber}', '${item.filename}')" 
                      class="btn btn-danger btn-sm">
                Delete
              </button>
            </div>
            <div class="view-settings" style="display: flex; gap: 10px; align-items: center; background-color: #f8f9fa; padding: 5px 10px; border-radius: 4px;">
              <label style="margin-bottom: 0; display: flex; align-items: center; font-size: 0.9em; cursor: pointer;">
                <input type="checkbox" ${item.customerView == "1" ? 'checked' : ''} 
                       onchange="updateFpFileViewSetting('${serverMediaType}', '${item.category}', '${item.id}', 'customer', this.checked, '${item.filename}')" 
                       style="margin-right: 5px;">
                Customer View
              </label>
              <label style="margin-bottom: 0; display: flex; align-items: center; font-size: 0.9em; cursor: pointer;">
                <input type="checkbox" ${item.internalView == "1" ? 'checked' : ''} 
                       onchange="updateFpFileViewSetting('${serverMediaType}', '${item.category}', '${item.id}', 'internal', this.checked, '${item.filename}')" 
                       style="margin-right: 5px;">
                Internal View
              </label>
            </div>
          </div>
        </div>
      `;
    });

    html += `</div>`; // Close media-category-container
  }
  
  container.innerHTML = html || `<p class="no-items-message">No ${mediaType} found in any category</p>`;
}

// Download media file
function downloadFpMedia(mediaType, category, customerNumber) {
  // Validate mediaType casing (Document/Image/Video)
  const normalizedMediaType = mediaType === 'docs' ? 'Document' : 
                             mediaType === 'images' ? 'Image' :
                             mediaType === 'videos' ? 'Video' : mediaType;

  // Encode category to handle spaces/special characters
  const encodedCategory = encodeURIComponent(category);
  
  console.log(`Downloading FP: type=${mediaType}, category=${category}, customer=${customerNumber}`);
  const url = `/api/fp-download-media/${normalizedMediaType}/${encodedCategory}/${customerNumber}`;
  console.log('Download URL:', url);
  window.open(url, '_blank');
}

// Update file view setting
function updateFpFileViewSetting(mediaType, category, fileId, viewType, isChecked, filename) {
  const customerNumber = document.getElementById('customerNumber').value;
  if (!customerNumber) {
    showNotification('Customer number is required', 'error');
    return;
  }

  // Convert boolean to integer for database storage
  const viewValue = isChecked ? 1 : 0;
  
  // Prepare the data for the API call
  const updateData = {
    mediaType,
    category,
    fileId,
    customerNumber,
    viewType, // 'customer' or 'internal'
    value: viewValue,
    filename // Add filename to identify the correct row
  };
  
  // Send update to server
  fetch('/api/fp-update-file-view', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(updateData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the local data to match the server
      updateFpLocalMediaViewSetting(mediaType, category, fileId, viewType, viewValue);
      showNotification(`${viewType.charAt(0).toUpperCase() + viewType.slice(1)} view setting updated`, 'success');
    } else {
      showNotification(`Error updating view setting: ${data.error}`, 'error');
      // Revert the checkbox state
      event.target.checked = !isChecked;
    }
  })
  .catch(error => {
    console.error('Error updating view setting:', error);
    showNotification('Failed to update view setting', 'error');
    // Revert the checkbox state
    event.target.checked = !isChecked;
  });
}

// Update local media view setting
function updateFpLocalMediaViewSetting(mediaType, category, fileId, viewType, value) {
  const mediaTypeKey = mediaType === 'Document' ? 'docs' : 
                      mediaType === 'Image' ? 'images' : 'videos';
  
  if (fpCurrentCustomerMedia[mediaTypeKey]) {
    fpCurrentCustomerMedia[mediaTypeKey].forEach(item => {
      if (item.id === fileId && item.category === category) {
        if (viewType === 'customer') {
          item.customerView = value;
        } else if (viewType === 'internal') {
          item.internalView = value;
        }
      }
    });
  }
}

// Apply media filters
function applyFpMediaFilters() {
  console.log("Applying FP media filters...");
  
  // Get Type filter values
  const showDocs = document.getElementById('fpFilterDocs').checked;
  const showImages = document.getElementById('fpFilterImages').checked;
  const showVideos = document.getElementById('fpFilterVideos').checked;
  
  // Get Category filter values
  const showFence = document.getElementById('fpFilterFence').checked;
  const showPaint = document.getElementById('fpFilterPaint').checked;
  
  console.log("Filter settings:", { 
    types: { docs: showDocs, images: showImages, videos: showVideos },
    categories: { fence: showFence, paint: showPaint }
  });
  
  // Show/hide the document sections based on type filters
  document.getElementById('fpDocumentsSection').style.display = showDocs ? 'block' : 'none';
  document.getElementById('fpImagesSection').style.display = showImages ? 'block' : 'none';
  document.getElementById('fpVideosSection').style.display = showVideos ? 'block' : 'none';
  
  // Filter the actual media items by category
  const allMediaItems = document.querySelectorAll('.media-item');
  console.log(`Found ${allMediaItems.length} media items to filter`);
  
  allMediaItems.forEach(item => {
    const category = item.getAttribute('data-category');
    const mediaType = item.getAttribute('data-type');
    
    console.log(`Item: category=${category}, type=${mediaType}`);
    
    // Check if this item's type is selected
    let typeSelected = false;
    if (mediaType === 'doc' && showDocs) typeSelected = true;
    if (mediaType === 'image' && showImages) typeSelected = true;
    if (mediaType === 'video' && showVideos) typeSelected = true;
    
    // Check if this item's category is selected
    let categorySelected = false;
    if (category === 'Fence' && showFence) categorySelected = true;
    if (category === 'Paint' && showPaint) categorySelected = true;
    
    // Show the item only if both type and category are selected
    const shouldDisplay = (typeSelected && categorySelected);
    console.log(`Should display ${category} ${mediaType}: ${shouldDisplay}`);
    
    // Find the parent container (media-category-container) and check if it has any visible items
    const parentContainer = item.closest('.media-category-container');
    item.style.display = shouldDisplay ? 'block' : 'none';
    
    // After hiding/showing items, check if the category container has any visible items
    if (parentContainer) {
      setTimeout(() => {
        const visibleItems = parentContainer.querySelectorAll('.media-item[style*="display: block"]');
        parentContainer.style.display = visibleItems.length > 0 ? 'block' : 'none';
      }, 0);
    }
  });
  
  // Update the "no items" messages
  updateFpNoItemsMessages();
}

// Update "no items" messages
function updateFpNoItemsMessages() {
  // For each section, check if there are any visible items
  const sections = ['fpDocuments', 'fpImages', 'fpVideos'];
  
  sections.forEach(section => {
    const container = document.getElementById(`${section}List`);
    if (!container) return;
    
    const visibleItems = container.querySelectorAll('.media-item[style*="display: block"]');
    const noItemsMessage = container.querySelector('.no-items-message');
    
    if (visibleItems.length === 0) {
      // If no message exists, create one
      if (!noItemsMessage) {
        const message = document.createElement('p');
        message.className = 'no-items-message';
        message.textContent = `No ${section.replace('fp', '').toLowerCase()} found matching the selected filters`;
        container.appendChild(message);
      } else {
        noItemsMessage.style.display = 'block';
      }
    } else if (noItemsMessage) {
      noItemsMessage.style.display = 'none';
    }
  });
}

// Show confirmation dialog
function showFpConfirmationDialog(message, onConfirm) {
  const dialog = document.getElementById('fpConfirmationDialog');
  const messageElement = document.getElementById('fpConfirmationMessage');
  const yesButton = document.getElementById('fpConfirmYes');
  const noButton = document.getElementById('fpConfirmNo');
  
  messageElement.textContent = message;
  dialog.style.display = 'flex';
  
  // Remove any existing event listeners
  const newYesButton = yesButton.cloneNode(true);
  const newNoButton = noButton.cloneNode(true);
  yesButton.parentNode.replaceChild(newYesButton, yesButton);
  noButton.parentNode.replaceChild(newNoButton, noButton);
  
  // Add new event listeners
  newYesButton.addEventListener('click', () => {
    dialog.style.display = 'none';
    onConfirm();
  });
  
  newNoButton.addEventListener('click', () => {
    dialog.style.display = 'none';
  });
}

// Delete media file
function deleteFpMedia(mediaType, category, customerNumber, filename) {
  showFpConfirmationDialog(`Are you sure you want to delete this ${mediaType.toLowerCase()}?`, () => {
    // This code runs only if user confirms
    fetch(`/api/fp-delete-media/${mediaType}/${category}/${customerNumber}/${encodeURIComponent(filename)}`, {
      method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(`${mediaType} deleted successfully`, 'success');
        fetchFpCustomerMedia(customerNumber);
      } else {
        showNotification(`Error deleting ${mediaType}: ${data.error}`, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification(`Failed to delete ${mediaType}`, 'error');
    });
  });
}

document.getElementById('fpAddNote').addEventListener('click', addFpNote);


function resetFencePaintingFields() {
    // Fencing fields
    [
        'fenceType', 'fenceMaterial', 'fenceHeight', 'fenceColor',
        'fenceStyle', 'fenceOwnerStatus', 'fenceInstallDate', 'fenceWarrantyExp', 'fenceSalesRep'
    ].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            if (el.tagName === 'SELECT') el.selectedIndex = 0;
            else el.value = '';
        }
    });
    // Hide and clear "Other" sales rep
    const fenceSalesRepOther = document.getElementById('fenceSalesRepOther');
    if (fenceSalesRepOther) {
        fenceSalesRepOther.value = '';
        fenceSalesRepOther.style.display = 'none';
    }

    // Painting fields
    [
        'paintingType', 'paintingColor', 'paintingBrand', 'paintingFinish',
        'paintingAreaPainted', 'paintingOwnerStatus', 'paintingDate', 'paintingWarrantyExp', 'paintingSalesRep'
    ].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            if (el.tagName === 'SELECT') el.selectedIndex = 0;
            else el.value = '';
        }
    });
    // Hide and clear "Other" sales rep
    const paintingSalesRepOther = document.getElementById('paintingSalesRepOther');
    if (paintingSalesRepOther) {
        paintingSalesRepOther.value = '';
        paintingSalesRepOther.style.display = 'none';
    }

    // Referral fields
    ['fpFirstName', 'fpLastName', 'fpPhoneNumber', 'fpEmail'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });

    // Notes and files
    const fpNotes = document.getElementById('fpNotes');
    if (fpNotes) fpNotes.value = '';

    const fpPreviousNotes = document.getElementById('fpPreviousNotes');
    if (fpPreviousNotes) fpPreviousNotes.innerHTML = '';

    const filesList = document.getElementById('filesList');
    if (filesList) filesList.innerHTML = '';

    // Refresh notes display to show "No notes found" or clear state
    if (typeof loadFpNotes === 'function') {
        loadFpNotes();
    }
}

// Make it globally accessible
window.resetFencePaintingFields = resetFencePaintingFields;



    </script>

<!-- Media Upload Modal -->
<div id="fpUploadModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="width: 500px; max-width: 90%; text-align: center;">
    <h3 style="margin-bottom: 20px;">Upload Media</h3>
    
    <form id="fpUploadForm" enctype="multipart/form-data">
      <div style="margin-bottom: 15px; text-align: center;">
        <label for="fpFileInput" style="display: block; margin-bottom: 5px;">Select File:</label>
        <input type="file" id="fpFileInput" name="file" required style="margin: 0 auto;">
      </div>
      
      <div style="margin-bottom: 15px; display: flex; justify-content: center; align-items: center;">
        <label for="fpTopicSelect" style="width: 100px; text-align: right; margin-right: 10px;">Topic:</label>
        <select id="fpTopicSelect" name="topic" required style="width: 200px; padding: 5px;">
          <option value="">Select</option>
          <option value="Fence">Fence</option>
          <option value="Paint">Paint</option>
        </select>
      </div>
      
      <div style="margin-bottom: 15px; display: flex; justify-content: center; align-items: center;">
        <label for="fpMediaTypeSelect" style="width: 100px; text-align: right; margin-right: 10px;">Media Type:</label>
        <select id="fpMediaTypeSelect" name="mediaType" required style="width: 200px; padding: 5px;">
          <option value="">Select</option>
          <option value="Document">Document</option>
          <option value="Image">Image</option>
          <option value="Video">Video</option>
        </select>
      </div>
      
      <div style="margin-bottom: 15px; text-align: center;">
        <label for="fpMediaDescription" style="display: block; margin-bottom: 5px;">Description:</label>
        <textarea id="fpMediaDescription" name="description" style="width: 90%; height: 80px; padding: 5px;" placeholder="Enter a description for this file..."></textarea>
      </div>
      
      <div style="margin-bottom: 15px; text-align: center;">
        <label style="display: block; margin-bottom: 10px;">Viewing Options:</label>
        <div style="display: flex; justify-content: center; gap: 50px;">
          <div>
            <input type="checkbox" id="fpCustomerViewCheck" name="customerView">
            <label for="fpCustomerViewCheck">Customer</label>
          </div>
          <div>
            <input type="checkbox" id="fpInternalViewCheck" name="internalView" checked>
            <label for="fpInternalViewCheck">Internal Use</label>
          </div>
        </div>
      </div>
      
      <div id="fpUploadStatus" style="margin: 15px 0; display: none;"></div>
      
      <div style="margin-top: 20px; text-align: right;">
        <button type="button" class="btn" onclick="submitFpUpload()">Submit</button>
        <button type="button" class="btn" onclick="resetFpUploadForm()">New Upload</button>
        <button type="button" class="btn" onclick="closeFpUploadModal()">Finish</button>
      </div>
    </form>
  </div>
</div>

<!-- Media View/Download Modal -->
<div id="fpViewDownloadModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="width: 80%; max-width: 900px; max-height: 80vh; overflow-y: auto;">
    <span onclick="closeFpViewDownloadModal()" style="position: absolute; top: 10px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa;">&times;</span>
    <h3 style="text-align: center; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">Fence/Painting Files</h3>
    
    <!-- Filter Section -->
    <table style="width: 100%; background-color: #f5f5f5; border-collapse: collapse;">
      <tr>
        <td style="width: 80px; padding: 10px; font-weight: bold; vertical-align: middle;">Type:</td>
        <td style="padding: 10px; text-align: center;">
          <div>Docs</div>
          <input type="checkbox" id="fpFilterDocs" checked>
        </td>
        <td style="padding: 10px; text-align: center;">
          <div>Images</div>
          <input type="checkbox" id="fpFilterImages" checked>
        </td>
        <td style="padding: 10px; text-align: center;">
          <div>Videos</div>
          <input type="checkbox" id="fpFilterVideos" checked>
        </td>
        <td style="padding: 10px; text-align: right;">
          <button onclick="applyFpMediaFilters()" class="btn btn-primary">Apply Filters</button>
        </td>
      </tr>
      <tr style="background-color: #eee;">
        <td style="width: 80px; padding: 10px; font-weight: bold; vertical-align: middle;">Area:</td>
        <td style="padding: 10px; text-align: center;">
          <div>Fence</div>
          <input type="checkbox" id="fpFilterFence" checked>
        </td>
        <td style="padding: 10px; text-align: center;">
          <div>Paint</div>
          <input type="checkbox" id="fpFilterPaint" checked>
        </td>
        <td colspan="2"></td>
      </tr>
    </table>
    
    <h4 style="margin-top: 20px; text-align: center; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Documents</h4>
    
    <div id="fpMediaContent" style="display: flex; flex-direction: column; gap: 30px;">
      <div id="fpDocumentsSection">
        <div id="fpDocumentsList" style="margin-top: 15px;">
          <p class="loading-message">Loading documents...</p>
        </div>
      </div>
      
      <div id="fpImagesSection">
        <h4 style="border-bottom: 1px solid #ddd; padding-bottom: 5px; text-align: center;">Images</h4>
        <div id="fpImagesList" style="margin-top: 15px;">
          <p class="loading-message">Loading images...</p>
        </div>
      </div>
      
      <div id="fpVideosSection">
        <h4 style="border-bottom: 1px solid #ddd; padding-bottom: 5px; text-align: center;">Videos</h4>
        <div id="fpVideosList" style="margin-top: 15px;">
          <p class="loading-message">Loading videos...</p>
        </div>
      </div>
    </div>
    
    <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
  <button type="button" class="btn btn-primary" onclick="submitFpUpload()">Save</button>
  <button onclick="goToSearch()" class="btn btn-info">Search</button>
  <button type="button" class="btn" onclick="closeFpViewDownloadModal()">Finish</button>
</div>

  </div>
</div>




<!-- Confirmation Dialog -->
<div id="fpConfirmationDialog" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="width: 400px; max-width: 90%;">
    <h4>Confirm Action</h4>
    <p id="fpConfirmationMessage" style="margin: 20px 0;"></p>
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button type="button" class="btn" id="fpConfirmNo">No</button>
      <button type="button" class="btn btn-danger" id="fpConfirmYes">Yes</button>
    </div>
  </div>
</div>


</div>
