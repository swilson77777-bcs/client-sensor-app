<!DOCTYPE html>
<html>
<head>
    <title>Client Profile Entry</title>
<style>
    body {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family: Arial, sans-serif;
        background-color: #f0f2f5;
    }

    h2 {
        color: #1a365d;
        text-align: center;
        padding: 15px;
        background-color: #e3f2fd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

   .btn-primary.rounded {
    border-radius: 20px !important; /* Increased border radius for more pronounced rounding */
    background-color: #FF69B4 !important;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 15px; /* Added padding for better button proportions */
    transition: background-color 0.3s ease; /* Smooth color transition */
}

.btn-primary.rounded:hover {
    background-color: #FF1493 !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Optional: add subtle shadow on hover */
}   
 
  .generate-code-btn, 
.copy-code-btn {
    background-color: #FFB6C1 !important;
    border-radius: 25px !important;
    height: 30px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 10px 15px !important;
    transition: all 0.3s ease !important;
    
}


.generate-code-btn:hover, .copy-code-btn:hover {
    background-color: #FF1493 !important;  /* Slightly darker pink for hover state */
}

    .input-group-append {
    display: flex !important;
    gap: 10px !important;
    padding: 5px !important;
}    

    .next-user-btn {
    background-color: #6FEC1B !important;
    align-items: center;
    border-radius: 4px;
    margin-top: -32px; /* Move button up 3px */
    #6FEC1B
    margin-left: -150px !important;
    justify-content: center;
    transition: background-color 0.3s ease;
}

.next-user-btn:hover {
    background-color: darkgreen;
}   

    div.search-section {
        background-color: #b3e0ff !important;
        padding: 25px;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .form-group {
        margin-bottom: 15px;
    }

    label {
        display: inline-block;
        width: 150px;
        color: #2d3748;
        font-weight: 500;
    }

    input, select, textarea {
        padding: 8px;
        border: 1px solid #cbd5e0;
        border-radius: 4px;
        transition: border-color 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #4299e1;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .button-group {
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .button-group button {
        background-color: #4299e1;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
        transition: background-color 0.3s ease;
    }

    .button-group button:hover {
        background-color: #3182ce;
    }

    .button-group button:disabled {
        background-color: #cbd5e0;
        cursor: not-allowed;
    }

.category-container {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
  }
  
  .media-item {
    transition: transform 0.2s;
  }
  
  .media-item:hover {
    transform: translateX(5px);
  }

  .media-category-container {
    border: 2px solid black;
    padding: 10px;
    margin-bottom: 20px;
  }

  .media-type-title {
    background-color: #b3e0e5;
    font-size: 1.5em;  /* Increase font size */
    font-weight: bold;
    border-bottom: 3px solid black;  /* Thick black underline */
    padding-bottom: 5px;
    margin-bottom: 15px;
  }

  .category-title {
    font-size: 1.2em;
    font-weight: bold;
    margin-bottom: 10px;
  }  

    #recordCounter {
        margin-left: 10px;
        font-weight: bold;
        color: #4a5568;
    }

    .wide-input {
        width: 200px;
    }

    .device-section {
        background-color: #e6e6fa;
        padding: 25px;
        margin-top: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #notesList {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e2e8f0;
        padding: 10px;
        border-radius: 4px;
        background-color: #fce4ec;
    }

    #clientForm {
        background-color: #A9CCE3;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h3 {
        color: #2d3748;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 10px;
        margin-bottom: 20px;
        width: 100% !important;
    }
    
    /* Login Modal Styles */
    .modal-overlay {
        display: flex;
        justify-content: center;
        align-items: center;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
    }

    .modal-content {
        background-color: white;
        padding: 2.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        text-align: center;
        max-width: 400px;
        width: 100%;
        animation-name: animatetop;
        animation-duration: 0.4s;
    }
    
    .custom-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #4299e1;
    color: white;
    padding: 15px 25px;
    border-radius: 5px;
    z-index: 2000;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    animation: fadeInOut 3s forwards;
    text-align: center;
    max-width: 80%;
}

.custom-notification.success {
    background-color: #48bb78;
}

.custom-notification.error {
    background-color: #f56565;
}

/* Upload Modal Styles */
#uploadModal .modal-content {
  padding: 30px;
  max-height: 80vh;
  overflow-y: auto;
}

#uploadModal h2 {
  margin-top: 0;
  margin-bottom: 20px;
}

#uploadModal .form-group {
  margin-bottom: 20px;
}

#uploadModal textarea {
  resize: vertical;
}

#uploadStatus {
  padding: 10px;
  border-radius: 4px;
  background-color: rgba(0,0,0,0.05);
}


@keyframes fadeInOut {
    0% { opacity: 0; }
    10% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; }
}

    @keyframes animatetop {
        from {top: -300px; opacity: 0}
        to {top: 0; opacity: 1}
    }

    .modal-content h2 {
        color: #1a365d;
        margin-bottom: 0.75rem;
        font-size: 1.75rem;
        background-color: transparent;
        box-shadow: none;
    }

    .modal-content p {
        color: #666;
        margin-bottom: 1.5rem;
        font-size: 0.95rem;
    }

    .modal-content input {
        width: 100%;
        padding: 0.85rem;
        margin-bottom: 1.25rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
    }

    .modal-content input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .submit-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 0.85rem 1.75rem;
        font-size: 1rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        width: 150px;
    }

    .submit-btn:hover {
        background-color: #0056b3;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    #authError {
        color: #dc3545;
        margin-top: 5px;
        font-size: 0.9rem;
    }
    
    #authAttempts {
        color: #666;
        margin-top: 8px;
        font-size: 0.85rem;
    }
    
    .logo {
        max-width: 120px;
        margin-bottom: 0.5rem;
    }
</style>


</head>
<body>
    <div style="text-align: center; margin-bottom: 20px;">
        <img src="bcs1.png" alt="BCS Company Logo" style="max-width: 300px; height: auto;">
    </div> 

 <div id="loginModal" class="modal-overlay">
  <div class="modal-content">
    <img src="bcs1.png" alt="Company Logo" class="logo">
    <h2>Enter Company Number</h2>
    <p>Please enter your unique company identifier to access the system.</p>
    <input type="text" id="companyNumberInput" placeholder="Company Number" required>
    <button onclick="validateCompanyNumber()" class="submit-btn"><strong>Submit</strong></button>
  </div>
</div>

    <div style="position: fixed; top: 20px; right: 20px; z-index: 1000; cursor: pointer;">
    <svg onclick="openCompanyProfile()" width="30" height="30" viewBox="0 0 20 20" fill="#1a365d">
        <path d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"/>
    </svg>
</div>

<!-- Company Profile Modal -->
<div id="companyProfileModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1001; overflow-y: auto;">
    <div style="position: relative; width: 600px; margin: 40px auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto;">
        <span onclick="closeCompanyProfile()" style="position: absolute; top: 10px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa;">&times;</span>
        
        <h3 style="margin-top: 0; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">Company Profile</h3>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
            <div class="form-group">
                <label for="companyName">Company Name:</label>
                <input type="text" id="companyName" class="wide-input" value="Examp Testing Industries">
            </div>

            <div class="form-group">
                <label for="companyNumber">Company Number:</label>
                <input type="text" id="companyNumber" class="wide-input" readonly>
            </div>
            
            <div class="form-group">
                <label for="companyStreet">Street Address:</label>
                <input type="text" id="companyStreet" class="wide-input">
            </div>
            
            <div class="form-group">
                <label for="companyCity">City:</label>
                <input type="text" id="companyCity" class="wide-input">
            </div>
            
            <div class="form-group">
                <label for="companyState">State:</label>
                <select id="companyState" style="width: 64px;">
                    <option value="TX" selected>TX</option>
                    <option value="AL">AL</option>
                    <option value="AK">AK</option>
                    <option value="AZ">AZ</option>
                    <option value="AR">AR</option>
                    <option value="CA">CA</option>
                    <option value="CO">CO</option>
                    <option value="CT">CT</option>
                    <option value="DE">DE</option>
                    <option value="FL">FL</option>
                    <option value="GA">GA</option>
                    <option value="HI">HI</option>
                    <option value="ID">ID</option>
                    <option value="IL">IL</option>
                    <option value="IN">IN</option>
                    <option value="IA">IA</option>
                    <option value="KS">KS</option>
                    <option value="KY">KY</option>
                    <option value="LA">LA</option>
                    <option value="ME">ME</option>
                    <option value="MD">MD</option>
                    <option value="MA">MA</option>
                    <option value="MI">MI</option>
                    <option value="MN">MN</option>
                    <option value="MS">MS</option>
                    <option value="MO">MO</option>
                    <option value="MT">MT</option>
                    <option value="NE">NE</option>
                    <option value="NV">NV</option>
                    <option value="NH">NH</option>
                    <option value="NJ">NJ</option>
                    <option value="NM">NM</option>
                    <option value="NY">NY</option>
                    <option value="NC">NC</option>
                    <option value="ND">ND</option>
                    <option value="OH">OH</option>
                    <option value="OK">OK</option>
                    <option value="OR">OR</option>
                    <option value="PA">PA</option>
                    <option value="RI">RI</option>
                    <option value="SC">SC</option>
                    <option value="SD">SD</option>
                    <option value="TN">TN</option>
                    <option value="UT">UT</option>
                    <option value="VT">VT</option>
                    <option value="VA">VA</option>
                    <option value="WA">WA</option>
                    <option value="WV">WV</option>
                    <option value="WI">WI</option>
                    <option value="WY">WY</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="companyZip">Zip Code:</label>
                <input type="text" id="companyZip" class="wide-input" pattern="[0-9]{5}" placeholder="ex. 75001">
            </div>
            <h4 style="margin-top: 15px; margin-bottom: 10px; color: #1a365d;">Contact Information</h4>
            <div class="form-group">
                <label for="contactFirstName">First Name:</label>
                <input type="text" id="contactFirstName" class="wide-input">
            </div>
            
            <div class="form-group">
                <label for="contactLastName">Last Name:</label>
                <input type="text" id="contactLastName" class="wide-input">
            </div>
            
            <div class="form-group">
                <label for="companyPhone">Phone Number:</label>
                <input type="tel" id="companyPhone" class="wide-input" placeholder="(xxx) xxx-xxxx" onkeyup="formatPhoneNumber(this)">
            </div>
            <div class="form-group">
                <label for="companyEmail">Email:</label>
                <input type="email" id="companyEmail" class="wide-input">
            </div>


        </div>

        <div class="form-group" id="companyKeysSection">
    <h4 style="margin-top: 15px; margin-bottom: 10px; color: #1a365d;">License Keys</h4>
    <div class="form-group">
        <label for="companyKeyInput">Enter License Key:</label>
        <div class="input-group">
            <input type="text" id="companyKeyInput" class="form-control" style="width: 260px;">
            <div class="input-group-append">
                <button type="button" class="btn btn-primary" onclick="validateCompanyKey()">Validate Key</button>
            </div>
        </div>
    </div>
    <div id="companyActiveKeys" style="margin-top: 10px; padding: 10px; background-color: #f0f8ff; border-radius: 5px;">
        <h5>Active Licenses:</h5>
        <div id="activeKeysList"></div>
    </div>
</div>
        <div style="margin-top: 20px; text-align: right;">
            <button type="button" class="btn btn-primary" onclick="saveCompanyProfile()">Save</button>
            <button type="button" class="btn" onclick="closeCompanyProfile()" style="margin-left: 10px;">Cancel</button>
        </div>
    </div>
</div>


    <h2>Client Profile</h2>

     <div class="form-group" id="subscriptionSection" style="display: none;">
    <label for="subscriptionNumber">Subscription Number:</label>
    <div class="input-group">
        <input type="text" id="subscriptionNumber" class="form-control" style="width: 260px;">
        <div class="input-group-append">
            <button type="button" class="btn btn-primary" onclick="validateSubscription()">Validate Subscription</button>
        </div>
    </div>
    <div id="subscriptionStatus" style="margin-top: 5px; font-size: 0.9em;"></div>
</div>

    
    <div class="search-section">
    <h3>Search Criteria</h3>
    <form id="searchForm" onsubmit="event.preventDefault(); searchRecord();">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Column 1 -->
        <div>
            <div class="form-group">
                <label for="searchFirstName">First Name:</label>
                <input type="text" id="searchFirstName" class="wide-input">
            </div>
            <div class="form-group">
                <label for="searchAddress">Address:</label>
                <input type="text" id="searchAddress" class="wide-input">
            </div>
    <div class="form-group">
        <label for="searchState">State:</label>
        <select id="searchState" style="width: 64px;">
            <option value="" selected></option>
	    <option value="TX">TX</option>
            <option value="AL">AL</option>
            <option value="AK">AK</option>
            <option value="AZ">AZ</option>
            <option value="AR">AR</option>
            <option value="CA">CA</option>
            <option value="CO">CO</option>
            <option value="CT">CT</option>
            <option value="DE">DE</option>
            <option value="FL">FL</option>
            <option value="GA">GA</option>
            <option value="HI">HI</option>
            <option value="ID">ID</option>
            <option value="IL">IL</option>
            <option value="IN">IN</option>
            <option value="IA">IA</option>
            <option value="KS">KS</option>
            <option value="KY">KY</option>
            <option value="LA">LA</option>
            <option value="ME">ME</option>
            <option value="MD">MD</option>
            <option value="MA">MA</option>
            <option value="MI">MI</option>
            <option value="MN">MN</option>
            <option value="MS">MS</option>
            <option value="MO">MO</option>
            <option value="MT">MT</option>
            <option value="NE">NE</option>
            <option value="NV">NV</option>
            <option value="NH">NH</option>
            <option value="NJ">NJ</option>
            <option value="NM">NM</option>
            <option value="NY">NY</option>
            <option value="NC">NC</option>
            <option value="ND">ND</option>
            <option value="OH">OH</option>
            <option value="OK">OK</option>
            <option value="OR">OR</option>
            <option value="PA">PA</option>
            <option value="RI">RI</option>
            <option value="SC">SC</option>
            <option value="SD">SD</option>
            <option value="TN">TN</option>
            <option value="UT">UT</option>
            <option value="VT">VT</option>
            <option value="VA">VA</option>
            <option value="WA">WA</option>
            <option value="WV">WV</option>
            <option value="WI">WI</option>
            <option value="WY">WY</option>
        </select>
    </div>
    <div class="form-group">
                <label for="searchPhone">Phone:</label>
                <input type="tel" id="searchPhone" class="wide-input" placeholder="(xxx) xxx-xxxx">
            </div>
    <div class="form-group">
                <label for="customerNumber">Customer #:</label>
                <input type="text" id="searchcustomerNumber" class="wide-input">
            </div>

        </div>

<!-- Column 2 -->
        <div>
            <div class="form-group">
                <label for="searchLastName">Last Name:</label>
                <input type="text" id="searchLastName" class="wide-input">
            </div>
            <div class="form-group">
                <label for="searchCity">City:</label>
                <input type="text" id="searchCity" class="wide-input">
            </div>
            <div class="form-group">
                <label for="searchZipCode">Zip Code:</label>
                <input type="text" id="searchZipCode" placeholder="ex. 75001" class="wide-input">
            </div>
            <div class="form-group">
                <label for="searchEmail">Email:</label>
                <input type="text" id="searchEmail" class="wide-input">
            </div>
            <div>
    <div style="height: 20px;"></div>
    <h4>Referral Information:</h4>
    <div class="form-group">
        <label for="searchReferralFirstName">First Name:</label>
        <input type="text" id="searchReferralFirstName" class="wide-input">
    </div>
    <div class="form-group">
        <label for="searchReferralLastName">Last Name:</label>
        <input type="text" id="searchReferralLastName" class="wide-input">
    </div>
    <div class="form-group">
        <label for="searchReferralPhone">Phone:</label>
        <input type="tel" id="searchReferralPhone" class="wide-input" placeholder="(xxx) xxx-xxxx">
    </div>
    <div class="form-group">
        <label for="searchReferralEmail">Email:</label>
        <input type="email" id="searchReferralEmail" class="wide-input">
    </div>
</div> 
        </div>
    </div>
    
    <div class="button-group">
    <button type="submit">Search</button>
    <button type="button" id="prevButton" onclick="previousRecord()" disabled>Previous</button>
    <button type="button" id="nextButton" onclick="nextRecord()" disabled>Next</button>
    <button type="button" id="resetSearchBtn" onclick="resetSearchCriteria()" style="background-color: #6FEC1B; color:black;">Reset</button>
    <span id="recordCounter"></span>
</div>

  </form>
</div>



 
        


<form id="clientForm">
    <input type="hidden" id="recordId" name="recordId">    
    <h3>User Data</h3>
        
<div class="button-group">
    <button type="button" class="btn btn-success ml-2" onclick="prepareNextUser()" style="background-color: #6FEC1B; color:black;">New Record</button>
    <button type="submit" class="btn btn-primary">Submit</button>
    <button type="button" class="btn btn-danger ml-2" id="deleteRecordBtn2" onclick="deleteRecord()" style="background-color: #FF0000; color:white; display: none;">Delete Record</button>
</div>


        <div class="form-group">
            <label for="customerNumber">Customer #:</label>
            <input type="text" id="customerNumber" required class="wide-input">
        </div>



        <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" id="username" required class="wide-input">
        </div>
        <div class="form-group">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" required class="wide-input">
        </div>
        <div class="form-group">
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" required class="wide-input">
        </div>
        <div class="form-group">
            <label for="streetAddress">Street Address:</label>
            <input type="text" id="streetAddress" required class="wide-input">
        </div>

        <div class="form-group">
    <label for="city">City:</label>
    <input type="text" id="city" required class="wide-input">
</div>
<div class="form-group">
    <label for="state">State:</label>
    <select id="state" required style="width: 64px;">
        <option value="TX" selected>TX</option>
        <option value="AL">AL</option>
        <option value="AK">AK</option>
        <option value="AZ">AZ</option>
        <option value="AR">AR</option>
        <option value="CA">CA</option>
        <option value="CO">CO</option>
        <option value="CT">CT</option>
        <option value="DE">DE</option>
        <option value="FL">FL</option>
        <option value="GA">GA</option>
        <option value="HI">HI</option>
        <option value="ID">ID</option>
        <option value="IL">IL</option>
        <option value="IN">IN</option>
        <option value="IA">IA</option>
        <option value="KS">KS</option>
        <option value="KY">KY</option>
        <option value="LA">LA</option>
        <option value="ME">ME</option>
        <option value="MD">MD</option>
        <option value="MA">MA</option>
        <option value="MI">MI</option>
        <option value="MN">MN</option>
        <option value="MS">MS</option>
        <option value="MO">MO</option>
        <option value="MT">MT</option>
        <option value="NE">NE</option>
        <option value="NV">NV</option>
        <option value="NH">NH</option>
        <option value="NJ">NJ</option>
        <option value="NM">NM</option>
        <option value="NY">NY</option>
        <option value="NC">NC</option>
        <option value="ND">ND</option>
        <option value="OH">OH</option>
        <option value="OK">OK</option>
        <option value="OR">OR</option>
        <option value="PA">PA</option>
        <option value="RI">RI</option>
        <option value="SC">SC</option>
        <option value="SD">SD</option>
        <option value="TN">TN</option>
        <option value="UT">UT</option>
        <option value="VT">VT</option>
        <option value="VA">VA</option>
        <option value="WA">WA</option>
        <option value="WV">WV</option>
        <option value="WI">WI</option>
        <option value="WY">WY</option>
    </select>
</div>

<div class="form-group">
    <label for="zipCode">Zip Code:</label>
    <input type="text" id="zipCode" required class="wide-input" pattern="[0-9]{5}" placeholder=" ex. 75001">
</div>

        <div class="form-group">
            <label for="phoneNumber">Phone Number:</label>
            <input type="tel" id="phoneNumber" required class="wide-input" placeholder="(xxx) xxx-xxxx">
        </div>
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" class="wide-input">
        </div>
        <div class="form-group">
    <label for="customerurl">Customer URL:</label>
    <input type="text" id="customerurl" class="wide-input">
</div>
        <div class="form-group">
    <label for="mobileAppAccess">Mobile App Access:</label>
    <select id="mobileAppAccess" onchange="handleMobileAccessChange()">
        <option value="No" selected>No</option>
        <option value="Yes">Yes</option>
    </select>
</div>
<div class="form-group" id="mobileAccessCodeGroup" style="display: none;">
    <label for="mobileAccessCode">Mobile Access Code:</label>
    <div class="input-group">
        <input type="text" id="mobileAccessCode" readonly class="form-control" style="width: 260px;">
        <div class="input-group-append">
            <button type="button" class="generate-code-btn" onclick="generateNewAccessCode()">Generate Code</button>
            <button type="button" class="copy-code-btn" onclick="copyToClipboard()">Copy Code</button>
        </div>
    </div>
</div>



<div class="button-group" style="display: flex; justify-content: center; flex-wrap: wrap;">
    <button type="button" onclick="checkSectionAccess('RGA')" style="background-color: #4ee6d6; color: black; font-weight: bold; margin: 5px;">Roof/Gutters/Attic</button>
    <button type="button" onclick="checkSectionAccess('FP')" style="background-color: #4ee6d6; color: black; font-weight: bold; margin: 5px;">Fencing/Painting</button>
    <button type="button" onclick="checkSectionAccess('PH')" style="background-color: #4ee6d6; color: black; font-weight: bold; margin: 5px;">Plumbing/Handyman</button>
    <button type="button" onclick="checkSectionAccess('LP')" style="background-color: #4ee6d6; color: black; font-weight: bold; margin: 5px;">Landscaping/Pool Service</button>
    <button type="button" onclick="checkSectionAccess('REM')" style="background-color: #4ee6d6; color: black; font-weight: bold; margin: 5px;">Remodeling</button>
    <button type="button" onclick="checkSectionAccess('TA')" style="background-color: #4ee6d6; color: black; font-weight: bold; margin: 5px;">Tech/Audio</button>
</div>
    </form>

<div id="roofGuttersAtticSection" style="display: none;">
    <!-- Existing Roof and Gutter sections --><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; margin-bottom: 10px;">
    

<!-- Container for Roof Section -->
    <div class="container" style="background-color: #e3f2fd; padding: 20px; border-radius: 8px;">
        <h3 style="margin-top: 0; border-bottom: 4px solid #000;"><strong>Roof Information</strong></h3>

        <!-- Roof Fields (Single Column) -->
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div class="form-group">
                <label for="roofMaterial">Roof Material:</label>
                <select id="roofMaterial"></select>
            </div>
            <div class="form-group">
                <label for="manufacturer">Manufacturer:</label>
                <select id="manufacturer"></select>
            </div>
            <div class="form-group">
                <label for="roofType">Roof Type:</label>
                <select id="roofType"></select>
            </div>
            <div class="form-group">
                <label for="modelOfMaterial">Model:</label>
                <select id="modelOfMaterial"></select>
            </div>
            <div class="form-group">
                <label for="color">Color:</label>
                <select id="color"></select>
            </div>
            <div class="form-group">
                <label for="ventType">Vent Type:</label>
                <select id="ventType"></select>
            </div>
            <!-- Install Date and Warranty Expiration -->
            <div class="form-group">
                <label for="installDate">Install Date:</label>
                <input type="date" id="installDate" onchange="calculateWarrantyDate()">
            </div>
            <div class="form-group">
                <label for="bcsWarrantyExpiration">Warranty Expiration:</label>
                <input type="date" id="bcsWarrantyExpiration" readonly>
            </div>
        </div>
    </div>

    <!-- Container for Gutter Section -->
    <div class="container" style="background-color: #e3f2fd; padding: 20px; border-radius: 8px;">
        <h3 style="margin-top: 0; border-bottom: 4px solid #000;"><strong>Gutter Information</strong></h3>

        <!-- Gutter Fields (Single Column) -->
        <div style="display: flex; flex-direction: column; gap: 15px;">
             <div class="form-group">
        <label for="gutterSize">Gutter Size:</label>
        <select id="gutterSize" name="gutterSize">
            <option value="" selected>Select</option>
            <option value="5 inch">5 inch</option>
            <option value="6 inch">6 inch</option>
            <option value="Other">Other</option>
        </select>
    </div>
            <div class="form-group">
                <label for="gutterColor">Color:</label>
                <select id="gutterColor">
                    <option value="" selected>Select</option>
                    <option value="Beige">Beige</option>
                    <option value="Black">Black</option>
                    <option value="Blue">Blue</option>
                    <option value="Brown">Brown</option>
                    <option value="Charcoal Gray">Charcoal Gray</option>
                    <option value="Clay">Clay</option>
                    <option value="Copper">Copper</option>
                    <option value="Cream">Cream</option>
                    <option value="Dark Bronze">Dark Bronze</option>
                    <option value="Gray">Gray</option>
                    <option value="Green">Green</option>
                    <option value="Ivory">Ivory</option>
                    <option value="Navy Blue">Navy Blue</option>
                    <option value="Red">Red</option>
                    <option value="White">White</option>
                    <option value="Other">Other</option>
               </select>
            </div>
            <!-- Brand and Owner Status -->
            <div class="form-group">
                <label for="gutterBrand">Brand:</label>
                <select id="gutterBrand">
                    <option value="" selected>Select</option>
                    <option value="ABC Seamless">ABC Seamless</option>
                    <option value="All American Gutter Protection">All American Gutter Protection</option>
                    <option value="Alside">Alside</option>
                    <option value="Alumasc">Alumasc</option>
                    <option value="Amerimax Home Product">Amerimax Home Product</option>
                    <option value="Ballew's Aluminum Products, Inc.">Ballew's Aluminum Products, Inc.</option>
                    <option value="Brett Martin">Brett Martin</option>
                    <option value="Cascade">Cascade</option>
                    <option value="Champion Gutter Guard">Champion Gutter Guard</option>
                    <option value="Drainage Superstore">Drainage Superstore</option>
                    <option value="EVERBUILD">EVERBUILD</option>
                    <option value="FiberTite">FiberTite</option>
                    <option value="FlexxPoint">FlexxPoint</option>
                    <option value="FloPlast">FloPlast</option>
                    <option value="Freefoam">Freefoam</option>
                    <option value="Gutter Helmet">Gutter Helmet</option>
                    <option value="Gutterglove">Gutterglove</option>
                    <option value="HomeCraft Gutter Protection">HomeCraft Gutter Protection</option>
                    <option value="Johns Manville Roofing System">Johns Manville Roofing System</option>
                    <option value="Leaf X">Leaf X</option>
                    <option value="LeafFilter">LeafFilter</option>
                    <option value="Leafguard">Leafguard</option>
                    <option value="MasterShield Gutter Protection">MasterShield Gutter Protection</option>
                    <option value="Mastic by Ply Gem">Mastic by Ply Gem</option>
                    <option value="MITTEN Building Products">MITTEN Building Products</option>
                    <option value="Mule-Hide Products Co., Inc.">Mule-Hide Products Co., Inc.</option>
                    <option value="Petersen Aluminum Corp.">Petersen Aluminum Corp.</option>
                    <option value="Quality Edge">Quality Edge</option>
                    <option value="Spectra Gutter Systems">Spectra Gutter Systems</option>
                    <option value= "Westlake Royal Roofing Solutions">Westlake Royal Roofing Solutions</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="gutterClientType">Owner Status:</label>
                <select id="gutterClientType">
                    <option value="" selected>Select</option>
                    <option value="Primary">Primary</option>
                    <option value="Secondary">Secondary</option>
                    <option value="Tertiary">Tertiary</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <!-- Install Date and Warranty Expiration -->
            <div class="form-group">
                <label for="gutterInstallDate">Install Date:</label>
                <input type="date" id="gutterInstallDate">
            </div>
            <div class="form-group">
                <label for="gutterWarrantyExpiration">Warranty Expiration:</label>
                <input type="date" id="gutterWarrantyExpiration">
            </div>
        </div>
    </div>

</div> <!-- End of Grid Layout -->

<div class="referral-container" style="background-color: #f0f8ff; padding: 20px; border-radius: 8px; margin-top: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">

<!-- Referral Section -->
<div style="margin-top: 20px; margin-bottom: 20px;">
    <h3>Referral</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
            <label for="referralFirstName">First Name:</label>
            <input type="text" id="referralFirstName" class="wide-input">
        </div>
        <div class="form-group">
            <label for="referralLastName">Last Name:</label>
            <input type="text" id="referralLastName" class="wide-input">
        </div>
        <div class="form-group">
            <label for="referralPhone">Phone:</label>
            <input type="tel" id="referralPhone" class="wide-input" placeholder="(xxx) xxx-xxxx" onkeyup="formatPhoneNumber(this)">
        </div>
        <div class="form-group">
            <label for="referralEmail">Email:</label>
            <input type="email" id="referralEmail" class="wide-input">
        </div>
    </div>
</div> 
</div> 

<div style="display: flex; gap: 20px; align-items: flex-start;">
    <div style="flex: 1;">
        <div class="form-group">
            <label for="notes">Notes:</label>
            <textarea id="notes" rows="4" style="width: 900px;" placeholder="Enter notes here..."></textarea>
            <button type="button" onclick="addNote()">Add Note</button>
        </div>
        <div class="form-group">
            <label>Previous Notes:</label>
            <div id="notesList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
        </div>        
    </div>    
    
   

    <div style="padding-top: 30px;">
        <div class="button-group" style="display: flex; flex-direction: column; gap: 10px;">
            <button type="button" class="form-submit-btn btn btn-primary" style="width: 150px;">Submit</button>
            <button type="button" class="btn btn-success" onclick="prepareNextUser()" style="background-color: #6FEC1B; color:black; width: 150px;">New Record</button>
        </div>
    </div>
</div>

<!-- Documents/Images/Videos in its own container -->
<div style="margin-top: 20px; background-color: #f0f8ff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div class="form-group">
        <label><strong style="font-size: larger;">Documents/Images/Videos</strong></label>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button type="button" class="btn btn-primary" onclick="uploadMedia()" style="padding: 10px 20px; font-size: 16px;">        Upload</button>
            <button type="button" class="btn btn-info" onclick="viewDownloadMedia()" style="padding: 10px 20px; font-size: 16px;">View/Download</button>
        </div>
    </div>
</div>



   <div class="device-section">

    <h3>Device Information</h3>
    <!-- Device Names and MACs in rows -->
    <div style="display: grid; gap: 10px;">
        <!-- Row 1 -->
        <div style="display: grid; grid-template-columns: 250px 400px 200px; gap: 20px; align-items: center;">
            <div class="form-group">
                <label for="deviceName1">Device Name 1:</label>
                <input type="text" id="deviceName1" style="width: 140px;">
            </div>
            <div class="form-group">
                <label for="deviceMac1">Device 1 MAC:</label>
                <input type="text" id="deviceMac1" 
                       pattern="([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}|([0-9a-fA-F]{2}:){7}[0-9a-fA-F]{2}" 
                       placeholder="00:11:22:33:44:55 or 00:11:22:33:44:55:66:77"
                       style="width: 270px;">
            </div>
            <div class="form-group">
                <label for="deviceSku1">SKU 1:</label>
                <input type="text" id="deviceSku1" style="width: 140px;">
            </div>
        </div>
        
        <!-- Row 2 -->
        <div style="display: grid; grid-template-columns: 250px 400px 200px; gap: 20px; align-items: center;">
            <div class="form-group">
                <label for="deviceName2">Device Name 2:</label>
                <input type="text" id="deviceName2" style="width: 140px;">
            </div>
            <div class="form-group">
                <label for="deviceMac2">Device 2 MAC:</label>
                <input type="text" id="deviceMac2" 
                       pattern="([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}|([0-9a-fA-F]{2}:){7}[0-9a-fA-F]{2}" 
                       placeholder="00:11:22:33:44:55 or 00:11:22:33:44:55:66:77"
                       style="width: 270px;">
            </div>
            <div class="form-group">
                <label for="deviceSku2">SKU 2:</label>
                <input type="text" id="deviceSku2" style="width: 140px;">
            </div>
        </div>


        <!-- Continue pattern for rows 3-10 -->
        <!-- Row 3 -->
        <div style="display: grid; grid-template-columns: 250px 400px 200px; gap: 20px; align-items: center;">
            <div class="form-group">
                <label for="deviceName3">Device Name 3:</label>
                <input type="text" id="deviceName3" style="width: 140px;">
            </div>
            <div class="form-group">
                <label for="deviceMac3">Device 3 MAC:</label>
                <input type="text" id="deviceMac3" 
                       pattern="([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}|([0-9a-fA-F]{2}:){7}[0-9a-fA-F]{2}" 
                       placeholder="00:11:22:33:44:55 or 00:11:22:33:44:55:66:77"
                       style="width: 270px;">
            </div>
            <div class="form-group">
                <label for="deviceSku3">SKU 3:</label>
                <input type="text" id="deviceSku3" style="width: 140px;">
            </div>
        </div>


        <!-- Row 4 -->
        <div style="display: grid; grid-template-columns: 250px 400px 200px; gap: 20px; align-items: center;">
            <div class="form-group">
                <label for="deviceName4">Device Name 4:</label>
                <input type="text" id="deviceName4" style="width: 140px;">
            </div>
            <div class="form-group">
                <label for="deviceMac4">Device 4 MAC:</label>
                <input type="text" id="deviceMac4" 
                       pattern="([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}|([0-9a-fA-F]{2}:){7}[0-9a-fA-F]{2}" 
                       placeholder="00:11:22:33:44:55 or 00:11:22:33:44:55:66:77"
                       style="width: 270px;">
            </div>
            <div class="form-group">
                <label for="deviceSku4">SKU 4:</label>
                <input type="text" id="deviceSku4" style="width: 140px;">
            </div>
        </div>


        <!-- Row 5 -->
        <div style="display: grid; grid-template-columns: 250px 400px 200px; gap: 20px; align-items: center;">
            <div class="form-group">
                <label for="deviceName5">Device Name 5:</label>
                <input type="text" id="deviceName5" style="width: 140px;">
            </div>
            <div class="form-group">
                <label for="deviceMac5">Device 5 MAC:</label>
                <input type="text" id="deviceMac5" 
                       pattern="([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}|([0-9a-fA-F]{2}:){7}[0-9a-fA-F]{2}" 
                       placeholder="00:11:22:33:44:55 or 00:11:22:33:44:55:66:77"
                       style="width: 270px;">
            </div>
            <div class="form-group">
                <label for="deviceSku5">SKU 5:</label>
                <input type="text" id="deviceSku5" style="width: 140px;">
            </div>
        </div>


        <!-- Row 6 -->
        <div style="display: grid; grid-template-columns: 250px 400px 200px; gap: 20px; align-items: center;">
            <div class="form-group">
                <label for="deviceName6">Device Name 6:</label>
                <input type="text" id="deviceName6" style="width: 140px;">
            </div>
            <div class="form-group">
                <label for="deviceMac6">Device 6 MAC:</label>
                <input type="text" id="deviceMac6" 
                       pattern="([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}|([0-9a-fA-F]{2}:){7}[0-9a-fA-F]{2}" 
                       placeholder="00:11:22:33:44:55 or 00:11:22:33:44:55:66:77"
                       style="width: 270px;">
            </div>
            <div class="form-group">
                <label for="deviceSku6">SKU 6:</label>
                <input type="text" id="deviceSku6" style="width: 140px;">
            </div>
        </div>


        <!-- Row 7 -->
        <div style="display: grid; grid-template-columns: 250px 400px 200px; gap: 20px; align-items: center;">
            <div class="form-group">
                <label for="deviceName7">Device Name 7:</label>
                <input type="text" id="deviceName7" style="width: 140px;">
            </div>
            <div class="form-group">
                <label for="deviceMac7">Device 7 MAC:</label>
                <input type="text" id="deviceMac7" 
                       pattern="([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}|([0-9a-fA-F]{2}:){7}[0-9a-fA-F]{2}" 
                       placeholder="00:11:22:33:44:55 or 00:11:22:33:44:55:66:77"
                       style="width: 270px;">
            </div>
            <div class="form-group">
                <label for="deviceSku7">SKU 7:</label>
                <input type="text" id="deviceSku7" style="width: 140px;">
            </div>
        </div>


        <!-- Row 8 -->
        <div style="display: grid; grid-template-columns: 250px 400px 200px; gap: 20px; align-items: center;">
            <div class="form-group">
                <label for="deviceName8">Device Name 8:</label>
                <input type="text" id="deviceName8" style="width: 140px;">
            </div>
            <div class="form-group">
                <label for="deviceMac8">Device 8 MAC:</label>
                <input type="text" id="deviceMac8" 
                       pattern="([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}|([0-9a-fA-F]{2}:){7}[0-9a-fA-F]{2}" 
                       placeholder="00:11:22:33:44:55 or 00:11:22:33:44:55:66:77"
                       style="width: 270px;">
            </div>
            <div class="form-group">
                <label for="deviceSku8">SKU 8:</label>
                <input type="text" id="deviceSku8" style="width: 140px;">
            </div>
        </div>


        <!-- Row 9 -->
        <div style="display: grid; grid-template-columns: 250px 400px 200px; gap: 20px; align-items: center;">
            <div class="form-group">
                <label for="deviceName9">Device Name 9:</label>
                <input type="text" id="deviceName9" style="width: 140px;">
            </div>
            <div class="form-group">
                <label for="deviceMac9">Device 9 MAC:</label>
                <input type="text" id="deviceMac9" 
                       pattern="([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}|([0-9a-fA-F]{2}:){7}[0-9a-fA-F]{2}" 
                       placeholder="00:11:22:33:44:55 or 00:11:22:33:44:55:66:77"
                       style="width: 270px;">
            </div>
            <div class="form-group">
                <label for="deviceSku9">SKU 9:</label>
                <input type="text" id="deviceSku9" style="width: 140px;">
            </div>
        </div>


        <!-- Row 10 -->
        <div style="display: grid; grid-template-columns: 250px 400px 200px; gap: 20px; align-items: center;">
            <div class="form-group">
                <label for="deviceName10">Device Name 10:</label>
                <input type="text" id="deviceName10" style="width: 140px;">
            </div>
            <div class="form-group">
                <label for="deviceMac10">Device 10 MAC:</label>
                <input type="text" id="deviceMac10" 
                       pattern="([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}|([0-9a-fA-F]{2}:){7}[0-9a-fA-F]{2}" 
                       placeholder="00:11:22:33:44:55 or 00:11:22:33:44:55:66:77"
                       style="width: 270px;">
            </div>
            <div class="form-group">
                <label for="deviceSku10">SKU 10:</label>
                <input type="text" id="deviceSku10" style="width: 140px;">
            </div>
        </div>

    </div>
</div>




  <div class="button-group">
    <button type="button" class="form-submit-btn btn btn-primary">Submit</button>

    <button type="button" class="btn btn-success ml-2" onclick="prepareNextUser()" style="background-color: #6FEC1B; color:black;">New Record</button>
    <button type="button" class="btn btn-danger ml-2" id="deleteRecordBtn" onclick="deleteRecord()" style="background-color: #FF0000; color:white; display: none;">Delete Record</button>
</div>
</div>

<!-- Subscription message container -->
<div id="subscriptionMessageContainer" style="display: none; margin-top: 20px; padding: 20px; background-color: #f8d7da; border-radius: 8px; text-align: center; tabindex="-1">
    <h3>Subscription Required</h3>
    <p>This feature requires an additional subscription. Please contact sales for assistance.</p>
    <button type="button" class="btn btn-primary" onclick="hideSubscriptionMessage()">Close</button>
</div>



    </form>

<div id="confirmationDialog" class="modal-overlay" style="display: none; z-index: 7000">
   <div class="modal-content" style="max-width: 400px;">
     <h3 id="confirmationMessage">Are you sure?</h3>
     <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
       <button id="confirmYes" class="btn btn-danger">Yes, Delete</button>
       <button id="confirmNo" class="btn">Cancel</button>
     </div>
   </div>
 </div>

    <script>
     // Force immediate scroll to top when script loads
window.scrollTo(0, 0);

// Prevent browsers from restoring scroll position
if ('scrollRestoration' in history) {
    history.scrollRestoration = 'manual';
}

// Handle page load
window.addEventListener('load', function() {
    // Force scroll to top when page is fully loaded
    window.scrollTo({
        top: 0,
        left: 0,
        behavior: 'auto'
    });
});

function validateCompanyNumber() {
  const companyNumber = document.getElementById('companyNumberInput').value;
  fetch('/api/validate-company', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ companyNumber })
  })
  .then(response => response.json())
  .then(data => {
    if (data.valid) {
      document.getElementById('loginModal').style.display = 'none';
      loadCompanyProfile(companyNumber);
      loadActiveKeys(companyNumber);
    } else {
      showNotification('Invalid company number. Please try again.', 'error');      
    }
  })
  .catch(error => console.error('Error:', error));
}

function loadCompanyProfile() {
    // Only load from server
    fetch('/api/company-profile')
    .then(response => response.json())
    .then(data => {
        if (data && !data.error) {
            // Populate form fields from server data
            document.getElementById('companyName').value = data.companyName || '';
            document.getElementById('companyNumber').value = data.companyNumber || '';
            document.getElementById('companyStreet').value = data.companyAddress || '';
            document.getElementById('companyCity').value = data.companyCity || '';
            document.getElementById('companyState').value = data.companyState || 'TX';
            document.getElementById('companyZip').value = data.CompanyZipCode || '';
            document.getElementById('contactFirstName').value = data.companyFirstName || '';
            document.getElementById('contactLastName').value = data.companyLastName || '';
            document.getElementById('companyPhone').value = data.companyPhoneNumber || '';
            document.getElementById('companyEmail').value = data.companyEmail || '';
            
            const companyNumber = data.companyNumber;
            if (companyNumber) {
                loadActiveKeys(companyNumber);
                // Store only the company number in localStorage for reference
                localStorage.setItem('companyNumber', companyNumber);
            }
        } else {
            // Clear form if no data available
            document.getElementById('companyName').value = '';
            document.getElementById('companyNumber').value = '';
            document.getElementById('companyStreet').value = '';
            document.getElementById('companyCity').value = '';
            document.getElementById('companyState').value = 'TX';
            document.getElementById('companyZip').value = '';
            document.getElementById('contactFirstName').value = '';
            document.getElementById('contactLastName').value = '';
            document.getElementById('companyPhone').value = '';
            document.getElementById('companyEmail').value = '';
        }
    })
    .catch(error => {
        console.error('Error loading company profile:', error);
        // Clear form on error instead of falling back to localStorage
        document.getElementById('companyName').value = '';
        document.getElementById('companyNumber').value = '';
        document.getElementById('companyStreet').value = '';
        document.getElementById('companyCity').value = '';
        document.getElementById('companyState').value = 'TX';
        document.getElementById('companyZip').value = '';
        document.getElementById('contactFirstName').value = '';
        document.getElementById('contactLastName').value = '';
        document.getElementById('companyPhone').value = '';
        document.getElementById('companyEmail').value = '';
    });
}


function setDefaultDropdownValues() {
    // Get all the gutter dropdowns
    const gutterSize = document.getElementById('gutterSize');
    const gutterColor = document.getElementById('gutterColor');
    const gutterBrand = document.getElementById('gutterBrand');
    const gutterClientType = document.getElementById('gutterClientType');
    
    // Set their values to empty string (which corresponds to the "Select" option)
    if (gutterSize) gutterSize.value = "";
    if (gutterColor) gutterColor.value = "";
    if (gutterBrand) gutterBrand.value = "";
    if (gutterClientType) gutterClientType.value = "";
    resetGutterDropdowns();
}

// Call this function after your page loads and after any dynamic content is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Wait a short time to ensure any dynamic content is loaded
    setTimeout(setDefaultDropdownValues, 500);
});
// Add this code to track checkbox state changes
document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners to track checkbox state changes
  document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'modalcustomerViewCheck') {
      console.log('Customer view checkbox clicked, new state:', e.target.checked);
    }
    if (e.target && e.target.id === 'modalinternalViewCheck') {
      console.log('Internal view checkbox clicked, new state:', e.target.checked);
    }
  }, true);
});


document.addEventListener('DOMContentLoaded', function() {
    // Get all submit buttons with the form-submit-btn class
    const submitButtons = document.querySelectorAll('.form-submit-btn');
    
    // Add click event listener to each button
    submitButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Trigger the form submission
            const form = document.getElementById('clientForm');
            const submitEvent = new Event('submit', {
                bubbles: true,
                cancelable: true
            });
            form.dispatchEvent(submitEvent);
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners to track checkbox state changes
  const customerViewCheck = document.getElementById('customerViewCheck');
  const internalViewCheck = document.getElementById('internalViewCheck');
  
  if (customerViewCheck) {
    customerViewCheck.addEventListener('change', function() {
      console.log('Customer view checkbox changed to:', this.checked);
    });
  }
  
  if (internalViewCheck) {
    internalViewCheck.addEventListener('change', function() {
      console.log('Internal view checkbox changed to:', this.checked);
    });
  }
});

// Company Profile Functions
function openCompanyProfile() {
    // Show the modal without trying to access subscription elements
    document.getElementById('companyProfileModal').style.display = 'block';
    
    // Load saved company data if available
    loadCompanyProfile();
}


function closeCompanyProfile() {
    document.getElementById('companyProfileModal').style.display = 'none';
}

function saveCompanyProfile() {
    // Get all company profile data
    const companyData = {
        companyName: document.getElementById('companyName').value,
        companyNumber: document.getElementById('companyNumber').value,
        companyAddress: document.getElementById('companyStreet').value,
        companyCity: document.getElementById('companyCity').value,
        CompanyZipCode: document.getElementById('companyZip').value,
        companyFirstName: document.getElementById('contactFirstName').value,
        companyLastName: document.getElementById('contactLastName').value,
        companyPhoneNumber: document.getElementById('companyPhone').value,
        companyEmail: document.getElementById('companyEmail').value
    };
    
    // Send data to server only
    fetch('/api/company-profile', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(companyData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification('Error: ' + error.message, 'error');
        } else {
            // Store only the company number in localStorage for reference
            if (data.companyNumber) {
                localStorage.setItem('companyNumber', data.companyNumber);
            }
            
            // Close the modal
            closeCompanyProfile();
            
            // Show confirmation
            showNotification('Company Profile saved successfully', 'success');
        }
    })
    .catch(error => {
        console.error('Error saving company profile:', error);
        showNotification('Error saving company profile. Please try again.', 'error');        
    });
}

function loadCompanyProfile() {
    // Only load from server
    fetch('/api/company-profile')
    .then(response => response.json())
    .then(data => {
        if (data && !data.error) {
            // Populate form fields from server data
            document.getElementById('companyName').value = data.companyName || '';
            document.getElementById('companyNumber').value = data.companyNumber || '';
            document.getElementById('companyStreet').value = data.companyAddress || '';
            document.getElementById('companyCity').value = data.companyCity || '';
            document.getElementById('companyState').value = data.companyState || 'TX';
            document.getElementById('companyZip').value = data.CompanyZipCode || '';
            document.getElementById('contactFirstName').value = data.companyFirstName || '';
            document.getElementById('contactLastName').value = data.companyLastName || '';
            document.getElementById('companyPhone').value = data.companyPhoneNumber || '';
            document.getElementById('companyEmail').value = data.companyEmail || '';
            
            const companyNumber = data.companyNumber;
            if (companyNumber) {
                loadActiveKeys(companyNumber);
                // Store only the company number in localStorage for reference
                localStorage.setItem('companyNumber', companyNumber);
            }
        } else {
            // Clear form if no data available
            document.getElementById('companyName').value = '';
            document.getElementById('companyNumber').value = '';
            document.getElementById('companyStreet').value = '';
            document.getElementById('companyCity').value = '';
            document.getElementById('companyState').value = 'TX';
            document.getElementById('companyZip').value = '';
            document.getElementById('contactFirstName').value = '';
            document.getElementById('contactLastName').value = '';
            document.getElementById('companyPhone').value = '';
            document.getElementById('companyEmail').value = '';
        }
    })
    .catch(error => {
        console.error('Error loading company profile:', error);
        // Clear form on error instead of falling back to localStorage
        document.getElementById('companyName').value = '';
        document.getElementById('companyNumber').value = '';
        document.getElementById('companyStreet').value = '';
        document.getElementById('companyCity').value = '';
        document.getElementById('companyState').value = 'TX';
        document.getElementById('companyZip').value = '';
        document.getElementById('contactFirstName').value = '';
        document.getElementById('contactLastName').value = '';
        document.getElementById('companyPhone').value = '';
        document.getElementById('companyEmail').value = '';
    });
}

// Move this function outside of loadCompanyProfile
function validateCompanyKey() {
    const keyToValidate = document.getElementById('companyKeyInput').value.trim();
    const companyNumber = document.getElementById('companyNumber').value.trim();
    
    if (!keyToValidate) {
        showNotification('Please enter a license key', 'success');        
        return;
    }
    
    if (!companyNumber) {
        showNotification('Company number is required. Please save the company profile first..', 'error');        
        return;
    }
    
    fetch('/api/validate-company-key', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ companyNumber, keyToValidate })
    })
    .then(response => response.json())
    .then(data => {
        if (data.valid) {
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.left = '50%';
            alertDiv.style.transform = 'translateX(-50%)';
            alertDiv.style.backgroundColor = 'green';
            alertDiv.style.color = 'white';
            alertDiv.style.padding = '10px';
            alertDiv.style.zIndex = '1000';
            alertDiv.style.borderRadius = '5px';
            alertDiv.textContent = data.message;
            
            document.body.appendChild(alertDiv);
            
            // Remove alert after 3 seconds
            setTimeout(() => {
                document.body.removeChild(alertDiv);
            }, 3000);
            
            // Clear the input field
            document.getElementById('companyKeyInput').value = '';
            
            // Refresh the active keys list
            loadActiveKeys(companyNumber);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error validating key:', error);
        showNotification('Error validating key. Please try again.', 'error');        
    });
}

// Load active keys for the company
function loadActiveKeys(companyNumber) {
    if (!companyNumber) return;
    
    fetch(`/api/company-active-keys/${companyNumber}`)
    .then(response => response.json())
    .then(data => {
        const activeKeysList = document.getElementById('activeKeysList');
        
        if (data.error) {
            activeKeysList.innerHTML = `<p>No active licenses found</p>`;
            return;
        }
        
        if (data.activeModules && data.activeModules.length > 0) {
            activeKeysList.innerHTML = data.activeModules.map(module => 
                `<div style="color: green; margin: 5px 0;"><i class="fas fa-check-circle"></i> ${module} - Active</div>`
            ).join('');
        } else {
            activeKeysList.innerHTML = `<p>No active licenses found</p>`;
        }
    })
    .catch(error => {
        console.error('Error loading active keys:', error);
    });
}

// Check section access before showing
function checkSectionAccess(sectionPrefix) {
    const companyNumber = localStorage.getItem('companyNumber');
    
    if (!companyNumber) {
        showSubscriptionMessage();
        return;
    }
    
    fetch(`/api/company-active-keys/${companyNumber}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showSubscriptionMessage();
            return;
        }
        
        const activeModules = data.activeModules || [];
        let hasAccess = false;
        
        // Check if any active module matches the section prefix
        switch(sectionPrefix) {
            case 'RGA':
                hasAccess = activeModules.some(module => module.includes('Roof/Gutters/Attic'));
                if (hasAccess) {
                    showSection('roofGuttersAttic');
                } else {
                    showSubscriptionMessage();
                }
                break;
                
            case 'FP':
            case 'PH':
            case 'LP':
            case 'REM':
            case 'TA':
                // Check if module exists but show coming soon
                hasAccess = activeModules.some(module => {
                    if (sectionPrefix === 'FP' && module.includes('Fencing/Painting')) return true;
                    if (sectionPrefix === 'PH' && module.includes('Plumbing/Handyman')) return true;
                    if (sectionPrefix === 'LP' && module.includes('Landscaping/Pool Service')) return true;
                    if (sectionPrefix === 'REM' && module.includes('Remodeling')) return true;
                    if (sectionPrefix === 'TA' && module.includes('Tech/Audio')) return true;
                    return false;
                });
                
                if (hasAccess) {
                    showComingSoonMessage();
                } else {
                    showSubscriptionMessage();
                }
                break;
                
            default:
                showSubscriptionMessage();
        }
    })
    .catch(error => {
        console.error('Error checking section access:', error);
        showSubscriptionMessage();
    });
}

// Show coming soon message
function showComingSoonMessage() {
    // Hide any other sections that might be visible
    document.getElementById('roofGuttersAtticSection').style.display = 'none';
    document.getElementById('subscriptionMessageContainer').style.display = 'none';
    
    // Create or update coming soon container
    let comingSoonContainer = document.getElementById('comingSoonMessageContainer');
    
    if (!comingSoonContainer) {
        comingSoonContainer = document.createElement('div');
        comingSoonContainer.id = 'comingSoonMessageContainer';
        comingSoonContainer.style.display = 'block';
        comingSoonContainer.style.margin = '20px';
        comingSoonContainer.style.padding = '20px';
        comingSoonContainer.style.backgroundColor = '#fff3cd';
        comingSoonContainer.style.borderRadius = '8px';
        comingSoonContainer.style.textAlign = 'center';
        comingSoonContainer.tabIndex = '-1';
        
        comingSoonContainer.innerHTML = `
            <h3>Coming Soon!</h3>
            <p>This feature is coming soon. Your license key is valid, but the feature is still in development.</p>
            <button type="button" class="btn btn-primary" onclick="hideComingSoonMessage()">Close</button>
        `;
        
        document.body.appendChild(comingSoonContainer);
    } else {
        comingSoonContainer.style.display = 'block';
    }
    
    // Scroll to the message container
    comingSoonContainer.scrollIntoView({ behavior: 'smooth' });
}

// Hide coming soon message
function hideComingSoonMessage() {
    const container = document.getElementById('comingSoonMessageContainer');
    if (container) {
        container.style.display = 'none';
    }
}

    function loadFromLocalStorage() {
    const savedData = localStorage.getItem('companyProfile');
    if (savedData) {
        const companyData = JSON.parse(savedData);
        
        // Safely set values only if elements exist
        const setValueIfExists = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
                element.value = value || '';
            }
        };
        
        // Populate form fields
        setValueIfExists('companyName', companyData.companyName || 'Examp Testing Industries');
            
            // Populate form fields
            document.getElementById('companyName').value = companyData.companyName || '';
            document.getElementById('companyStreet').value = companyData.companyAddress || '';
            document.getElementById('companyCity').value = companyData.companyCity || '';
            document.getElementById('companyState').value = companyData.companyState || 'TX';
            document.getElementById('companyZip').value = companyData.CompanyZipCode || '';
            document.getElementById('contactFirstName').value = companyData.companyFirstName || '';
            document.getElementById('contactLastName').value = companyData.companyLastName || '';
            document.getElementById('companyPhone').value = companyData.companyPhoneNumber || '';
            document.getElementById('companyEmail').value = companyData.companyEmail || '';            
        }
    }




    function prepareNextUser() {
    // Reset all input fields in the form
    const form = document.getElementById('clientForm');
    form.reset();
    document.getElementById('deleteRecordBtn').style.display = 'none';
    document.getElementById('deleteRecordBtn2').style.display = 'none'; 

     // Explicitly clear the recordId field
    document.getElementById('recordId').value = '';

    // Clear dependent dropdowns
    document.getElementById('roofType').innerHTML = '<option value="">Select...</option>';
    document.getElementById('modelOfMaterial').innerHTML = '<option value="">Select...</option>';
    document.getElementById('color').innerHTML = '<option value="">Select...</option>';

    // Reset mobile access code group
    document.getElementById('mobileAccessCodeGroup').style.display = 'none';
    document.getElementById('mobileAccessCode').value = '';

    // Also reset the form fields
    document.getElementById('referralFirstName').value = '';
    document.getElementById('referralLastName').value = '';
    document.getElementById('referralPhone').value = '';
    document.getElementById('referralEmail').value = '';

    // Clear notes list
    document.getElementById('notesList').innerHTML = '';
    document.getElementById('notes').value = '';

    // Reset device fields
    for (let i = 1; i <= 10; i++) {
        document.getElementById(`deviceName${i}`).value = '';
        document.getElementById(`deviceMac${i}`).value = '';
        document.getElementById(`deviceSku${i}`).value = '';
    }

    // Set focus to customerNumber input
    document.getElementById('customerNumber').focus();
}

   function formatPhoneNumber(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length > 0) {
        if (value.length <= 3) {
            value = `(${value}`;
        } else if (value.length <= 6) {
            value = `(${value.slice(0,3)}) ${value.slice(3)}`;
        } else {
            value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6,10)}`;
        }
    }
    input.value = value;
}
 // Hide delete buttons when creating a new record
    document.getElementById('deleteRecordBtn').style.display = 'none';
    document.getElementById('deleteRecordBtn2').style.display = 'none';
// Add event listeners to both phone inputs
document.getElementById('phoneNumber').addEventListener('input', function(e) {
    formatPhoneNumber(this);
});

document.getElementById('searchPhone').addEventListener('input', function(e) {
    formatPhoneNumber(this);
});


   function handleDeviceMacChange() {
    const selectedMac = document.getElementById('searchDeviceMac').value;
    console.log('Selected MAC:', selectedMac);
}


    function generateAccessCode() {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%&';
    const specialChars = '!@#$%&';
    let code;
    do {
        code = Array(32).fill()
            .map(() => {
                const randArray = new Uint32Array(1);
                crypto.getRandomValues(randArray);
                return characters.charAt(randArray[0] % characters.length);
            })
            .join('');
    } while (
        !/[A-Z]/.test(code) || 
        (code.match(/[a-z]/g) || []).length < 6 || 
        (code.match(/[!@#$%&]/g) || []).length < 4
    );
    return code;
}

function copyToClipboard() {
    const codeInput = document.getElementById('mobileAccessCode');
    
    // Select the text
    codeInput.select();
    codeInput.setSelectionRange(0, 99999); // For mobile devices
    
    // Copy to clipboard
    navigator.clipboard.writeText(codeInput.value).then(() => {
        // Create a more visible alert
        const alertDiv = document.createElement('div');
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.left = '50%';
        alertDiv.style.transform = 'translateX(-50%)';
        alertDiv.style.backgroundColor = 'green';
        alertDiv.style.color = 'white';
        alertDiv.style.padding = '10px';
        alertDiv.style.zIndex = '1000';
        alertDiv.style.borderRadius = '5px';
        alertDiv.textContent = 'Code copied to clipboard';
        
        document.body.appendChild(alertDiv);
        
        // Remove alert after 2 seconds
        setTimeout(() => {
            document.body.removeChild(alertDiv);
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

function handleMobileAccessChange() {
    const mobileAccess = document.getElementById('mobileAppAccess').value;
    const codeGroup = document.getElementById('mobileAccessCodeGroup');
    const codeInput = document.getElementById('mobileAccessCode');
    
    if (mobileAccess === 'Yes') {
        codeGroup.style.display = 'block';
        if (!codeInput.value) {
            codeInput.value = generateAccessCode();
        }
    } else {
        codeGroup.style.display = 'none';
        
    }
    
}

function generateNewAccessCode() {
    document.getElementById('mobileAccessCode').value = generateAccessCode();
}

function validateSubscription() {
    const subscriptionNumber = document.getElementById('subscriptionNumber').value.trim();
    const statusElement = document.getElementById('subscriptionStatus');
    const currentSubscriptionElement = document.getElementById('currentSubscription');
    
    if (!subscriptionNumber) {
        statusElement.textContent = 'Please enter a subscription number';
        statusElement.style.color = 'red';
        return;
    }
    
    // Here you would typically make an API call to validate the subscription
    // For now, we'll use a simple check with hardcoded valid subscription numbers
    const validSubscriptions = ['ROOF123', 'PREMIUM456', 'FULL789'];
    
    if (validSubscriptions.includes(subscriptionNumber)) {
        statusElement.textContent = 'Subscription valid! You have access to Roof/Gutters/Attic section.';
        statusElement.style.color = 'green';
        localStorage.setItem('subscriptionNumber', subscriptionNumber);
        
        // Update the current subscription display
        currentSubscriptionElement.textContent = ' (Roof/Gutters/Attic - valid)';
    } else {
        statusElement.textContent = 'Invalid subscription number. Please contact sales.';
        statusElement.style.color = 'red';
    }
}

// In the DOMContentLoaded event listener, add:
const subscription = localStorage.getItem('subscriptionNumber');
if (subscription) {
    // Don't set the value in the input field
    // document.getElementById('subscriptionNumber').value = subscription;
    
    // Just update the status
    document.getElementById('subscriptionStatus').textContent = 'Subscription valid! You have access to Roof/Gutters/Attic section.';
    document.getElementById('subscriptionStatus').style.color = 'green';
}
// Check if user has a valid subscription
function hasValidSubscription() {
    const subscription = localStorage.getItem('subscriptionNumber');
    const validSubscriptions = ['ROOF123', 'PREMIUM456', 'FULL789'];
    return subscription && validSubscriptions.includes(subscription);
}

// Show a specific section if subscription is valid
function showSection(sectionId) {
    if (hasValidSubscription()) {
        // Hide all sections first
        document.getElementById('subscriptionMessageContainer').style.display = 'none';
        
        // Show the requested section
        const section = document.getElementById(`${sectionId}Section`);
        section.style.display = 'block';
         
        // Reset gutter dropdowns if showing the roofGuttersAttic section
        if (sectionId === 'roofGuttersAttic') {
            resetGutterDropdowns();
        }        

        // Scroll to the section
        section.scrollIntoView({ behavior: 'smooth' });
    } else {
        showSubscriptionMessage();
    }
}

function resetGutterDropdowns() {
    const gutterDropdowns = ['gutterSize', 'gutterColor', 'gutterBrand', 'gutterClientType'];
    gutterDropdowns.forEach(id => {
        const dropdown = document.getElementById(id);
        if (dropdown) {
            dropdown.value = "";
        }
    });
}

// Show subscription required message
function showSubscriptionMessage() {
    // Hide any other sections that might be visible
    document.getElementById('roofGuttersAtticSection').style.display = 'none';
    
    // Show the subscription message container
    const subscriptionContainer = document.getElementById('subscriptionMessageContainer');
    subscriptionContainer.style.display = 'block';
    
    // Scroll to the subscription message container
    subscriptionContainer.scrollIntoView({ behavior: 'smooth' });
}


// Hide subscription message
function hideSubscriptionMessage() {
    document.getElementById('subscriptionMessageContainer').style.display = 'none';
}

    let searchResults = [];
    let currentResultIndex = 0;

    // Populate dropdowns on page load
document.addEventListener('DOMContentLoaded', async () => {
    // Load initial dropdowns
    await loadDropdownOptions('roofMaterial');
    await loadDropdownOptions('manufacturer');
    await loadDropdownOptions('ventType');
    await loadDropdownOptions('clientType');
    await populateDeviceMacDropdown();
    

    // Add change event listeners
    document.getElementById('manufacturer').addEventListener('change', handleManufacturerChange);
    document.getElementById('modelOfMaterial').addEventListener('change', handleModelChange);
    document.getElementById('searchDeviceMac').addEventListener('change', handleDeviceMacChange);
    // Setup gutter dropdown listeners
    
    
    document.getElementById('username').addEventListener('blur', async function() {
        const username = this.value.trim();
        if (!username) return;
        
        const recordId = document.getElementById('recordId').value;
        const result = await checkUsernameAvailability(username, recordId);
        
        // Remove any existing validation message
        const existingMessage = document.getElementById('username-validation-message');
        if (existingMessage) existingMessage.remove();
        
        // Add validation message if username is not available
        if (!result.available) {
            const messageElement = document.createElement('div');
            messageElement.id = 'username-validation-message';
            messageElement.style.color = 'red';
            messageElement.style.fontSize = '0.8rem';
            messageElement.textContent = result.message;
            this.parentNode.appendChild(messageElement);
        }
        
});
    
    // Add this at the end of your DOMContentLoaded event listener
document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        // Check if any search field is focused
        const searchFieldIds = ['searchFirstName', 'searchLastName', 'searchAddress', 
            'searchCity', 'searchState', 'searchZipCode', 
            'searchPhone', 'searchEmail', 'searchcustomerNumber'];
        
        const focusedElement = document.activeElement;
        if (searchFieldIds.includes(focusedElement.id)) {
            event.preventDefault();
            document.querySelector('.button-group button').click(); // Click the search button
        }
    }
});



});

    async function loadDropdownOptions(listType) {
        try {
            const response = await fetch(`/api/dropdowns/${listType}`);
            const items = await response.json();
            const select = document.getElementById(listType);
             // Log before setting innerHTML
        console.log(`${listType} before:`, select.innerHTML);

            select.innerHTML = '<option value="">Select...</option>' +
                items.map(item => `<option value="${item}">${item}</option>`).join('');
                console.log(`${listType} after:`, select.innerHTML);
               
        } catch (error) {
            console.error(`Error loading ${listType} options:`, error);
        }
    }

    function calculateWarrantyDate() {
        const installDate = new Date(document.getElementById('installDate').value);
        const warrantyDate = new Date(installDate);
        warrantyDate.setFullYear(warrantyDate.getFullYear() + 5);
        document.getElementById('bcsWarrantyExpiration').valueAsDate = warrantyDate;
    }

    async function handleManufacturerChange() {
    const manufacturer = document.getElementById('manufacturer').value;
    const roofTypeSelect = document.getElementById('roofType');
    const modelSelect = document.getElementById('modelOfMaterial');
    const colorSelect = document.getElementById('color');
    
    // Clear dependent dropdowns
    roofTypeSelect.innerHTML = '<option value="">Select...</option>';
    modelSelect.innerHTML = '<option value="">Select...</option>';
    colorSelect.innerHTML = '<option value="">Select...</option>';

        
    console.log('Manufacturer selected:', manufacturer);  // First message here   

    if (manufacturer) {
        // Roof Types logic
        let models;
        let roofTypes;
    switch(manufacturer) {
        case 'Owens Corning':
            roofTypes = [
                'Impact Resistant Class 3',
                'Impact Resistant Class 4',
                'Designer',
                'Laminated Composition Shingles',
                'Other'
            ];
            roofTypeSelect.innerHTML = '<option value="">Select...</option>' + 
                roofTypes.map(type => `<option value="${type}">${type}</option>`).join('');
            
            console.log('Roof Types:', roofTypes); // Debug
            console.log('RoofType Select HTML:', roofTypeSelect.innerHTML); // Debug

                models = [
                'Oakridge',
                'TruDef-Oakridge',
                'Duration True-Def',
                'Duration Designer',
                'Duration Storm',
                'Duration Storm Flex',
                'Woodcrest',
                'Other'
            ];
            
            modelSelect.innerHTML = '<option value="">Select...</option>' + 
                models.map(model => `<option value="${model}">${model}</option>`).join('');
                
            console.log('Models:', models); // Debug
            console.log('Model Select HTML:', modelSelect.innerHTML); // Debug

            // Add event listener for model changes to handle colors
            modelSelect.addEventListener('change', function() {
                const model = this.value;
                
                // Clear and reset color dropdown
                colorSelect.innerHTML = '<option value="">Select...</option>';
                
                if (model && model !== 'Other') {
                    const colorMap = {
                        'Oakridge': ['Brownwood', 'Desert Tan', 'Driftwood', 'Estate Gray', 'Onyx Black', 'Teak'],
                        'TruDef-Oakridge': ['Brownwood', 'Desert Tan', 'Driftwood', 'Estate Gray', 'Onyx Black', 'Teak', 'Williamsburg Gray'],
                        'Duration True-Def': [
                            'Amber', 'Brownwood', 'Chateau Green', 'Colonial Slate', 'Desert Rose', 
                            'Driftwood', 'Estate Gray', 'Harbor Blue', 'Midnight Plum', 'Onyx Black', 
                            'Peppercorn', 'Shasta White', 'Sierra Gray', 'Teak', 'Terra Cotta', 'Williamsburg Gray'
                        ],
                        'Duration Designer': [
                            'Aged Copper', 'Black Sable', 'Bourbon', 'Merlot', 
                            'Pacific Wave', 'Sand Dune', 'Sedona Canyon', 'Storm Cloud', 'Summer Harvest'
                        ],
                        'Duration Storm': ['Antique Silver', 'Brownwood', 'Desert Tan', 'Driftwood', 'Estate Gray', 'Onyx Black', 'Teak'],
                        'Duration Storm Flex': [
                            'Black Sable', 'Brownwood', 'Driftwood', 'Estate Gray', 
                            'Onyx Black', 'Sand Dune', 'Storm Cloud', 'Summer Harvest', 'Teak'
                        ],
                        'Woodcrest': ['Carbon', 'Chestnut', 'Granite', 'Mesquite', 'Sycamore', 'Timber']
                    };

                    const colors = colorMap[model] || [];
                    colorSelect.innerHTML += colors.map(color => 
                        `<option value="${color}">${color}</option>`
                    ).join('');
                }
            });
            break;

case 'IKO':
    roofTypes = [
        'Impact Resistant Class 4',
        'Laminated Architectural',
        'Premium Designer',
        'Other'
    ];
    roofTypeSelect.innerHTML = '<option value="">Select...</option>' + 
        roofTypes.map(type => `<option value="${type}">${type}</option>`).join('');
    
    models = [
        'Designer Armourshake',
        'Designer Crowne Slate',
        'Designer Royal Estate',
        'Performance Dynasty (Class 3)',
        'Performance Nordic (Class 4)',
        'Architectural Cambridge',
        'Traditional 3-Tab',
        'Other'
    ];
    
    modelSelect.innerHTML = '<option value="">Select...</option>' + 
        models.map(model => `<option value="${model}">${model}</option>`).join('');

    modelSelect.addEventListener('change', function() {
        const model = this.value;
        colorSelect.innerHTML = '<option value="">Select...</option>';
        
        if (model && model !== 'Other') {
            const colorMap = {
                'Designer Armourshake': [
                    'Shadow Black', 'Western Redwood', 'Weatherwood',
                    'Greystone', 'Castle Grey'
                ],
                'Designer Crowne Slate': [
                    'Dual Black', 'Dual Grey', 'Royal Granite',
                    'Shadow Brown', 'Weatherwood'
                ],
                'Designer Royal Estate': [
                    'Harvest Slate', 'Mountain Slate', 'Shadow Slate',
                    'Taupe Slate', 'Vintage Green'
                ],
                'Performance Dynasty (Class 3)': [
                    'Appalachian', 'Atlantic Blue', 'Biscayne', 'Castle Grey',
                    'Glacier', 'Monaco Red', 'Pacific Rim', 'Shadow Slate', 'Sedona'
                ],
                'Performance Nordic (Class 4)': [
                    'Dual Black', 'Dual Brown', 'Dual Grey', 'Frostone Grey',
                    'Glacier', 'National Blue', 'Riviera Red', 'Shadow Brown'
                ],
                'Architectural Cambridge': [
                    'Charcoal Grey', 'Driftwood', 'Dual Black', 'Dual Grey',
                    'Dual Brown', 'Earthtone Cedar', 'Harvard Slate', 'Weatherwood'
                ],
                'Traditional 3-Tab': [
                    'Dual Black', 'Dual Brown', 'Dual Grey', 'Weatherwood'
                ]
            };

            const colors = colorMap[model] || [];
            colorSelect.innerHTML += colors.map(color => 
                `<option value="${color}">${color}</option>`
            ).join('');
        }
    });
    break;

    


            case 'GAF':
                roofTypes = [
                    'Composition Laminate Shingle',
                    'Impact Resistant Shingles',
                    'Lifetime Designer',
                    'Timberline Lifetime Shingles',
                    'Other'
                ];
                // Add GAF Models
                modelSelect.innerHTML = '<option value="">Select...</option>' + [
                    'Timberline HDZ',
                    'Timberline UHDZ',
                    'Timberline NS',
                    'Timberline AS II',
                    'Camelot II',
                    'Woodland',
                    'Slateline',
                    'Grand Sequoia',
                    'Grand Sequoia AS',
                    'Royal Sovereign',
                    'Other'
                ].map(model => `<option value="${model}">${model}</option>`).join('');
                break;

            default:
                roofTypes = [
                    'Class 3 Impact Resistant Shingles',
                    'Class 4 Impact Resistant Shingles',
                    'Laminated Composition Shingles',
                    'Clay',
                    'Concrete',
                    'Metal',
                    'Modified Bitumen',
                    'Other'
                ];
                // Add Other option for manual entry
                modelSelect.innerHTML = `
                    <option value="">Select...</option>
                    <option value="Other">Other</option>
                `;
        }
        
        roofTypeSelect.innerHTML = '<option value="">Select...</option>' +
            roofTypes.map(type => `<option value="${type}">${type}</option>`).join('');

        // Add event listener for Other selection in roofType
        roofTypeSelect.addEventListener('change', function() {
            if (this.value === 'Other') {
                const customValue = prompt('Enter custom roof type:');
                if (customValue) {
                    const newOption = new Option(customValue, customValue);
                    this.add(newOption);
                    this.value = customValue;
                } else {
                    this.value = '';
                }
            }
        });

        // Add event listener for Other selection in model
modelSelect.addEventListener('change', function() {
    if (this.value === 'Other') {
        const customValue = prompt('Enter custom model:');
        if (customValue) {
            const newOption = new Option(customValue, customValue);
            this.add(newOption);
            this.value = customValue;
            return true; // Allow navigation only if value provided
        } else {
            this.value = ''; // Reset to empty if cancelled
            return false; // Prevent navigation if cancelled
        }
    }
});


    }
}


    async function handleModelChange() {
    const model = document.getElementById('modelOfMaterial').value;
    const colorSelect = document.getElementById('color');
    
    
    // Clear current color options and remove existing event listeners
    colorSelect.innerHTML = '<option value="">Select...</option>';
    const oldColorSelect = colorSelect.cloneNode(true);
    colorSelect.parentNode.replaceChild(oldColorSelect, colorSelect);

    if (model && model !== 'Other') {
        const colorMap = {
            'Oakridge': ['Brownwood', 'Desert Tan', 'Driftwood', 'Estate Gray', 'Onyx Black', 'Teak'],
            'TruDef-Oakridge': ['Brownwood', 'Desert Tan', 'Driftwood', 'Estate Gray', 'Onyx Black', 'Teak', 'Williamsburg Gray'],
            'Duration True-Def': [
                'Amber', 'Brownwood', 'Chateau Green', 'Colonial Slate', 'Desert Rose', 'Driftwood', 
                'Estate Gray', 'Harbor Blue', 'Midnight Plum', 'Onyx Black', 'Peppercorn', 'Shasta White', 
                'Sierra Gray', 'Teak', 'Terra Cotta', 'Williamsburg Gray'
            ],
            'Duration Designer': [
                'Aged Copper', 'Black Sable', 'Bourbon', 'Merlot', 'Pacific Wave', 
                'Sand Dune', 'Sedona Canyon', 'Storm Cloud', 'Summer Harvest'
            ],
            'Duration Storm': ['Antique Silver', 'Brownwood', 'Desert Tan', 'Driftwood', 'Estate Gray', 'Onyx Black', 'Teak'],
            'Duration Storm Flex': [
                'Black Sable', 'Brownwood', 'Driftwood', 'Estate Gray', 'Onyx Black', 
                'Sand Dune', 'Storm Cloud', 'Summer Harvest', 'Teak'
            ],
            'Woodcrest': ['Carbon', 'Chestnut', 'Granite', 'Mesquite', 'Sycamore', 'Timber'],
            
            // IKO colors
            'Designer Armourshake': ['Shadow Black', 'Western Redwood', 'Weatherwood', 'Greystone', 'Castle Grey'],
            'Designer Crowne Slate': ['Dual Black', 'Dual Grey', 'Royal Granite', 'Shadow Brown', 'Weatherwood'],
            'Designer Royal Estate': ['Harvest Slate', 'Mountain Slate', 'Shadow Slate', 'Taupe Slate', 'Vintage Green'],
            'Performance Dynasty (Class 3)': [
                'Appalachian', 'Atlantic Blue', 'Biscayne', 'Castle Grey', 'Glacier', 
                'Monaco Red', 'Pacific Rim', 'Shadow Slate', 'Sedona'
            ],
            'Performance Nordic (Class 4)': [
                'Dual Black', 'Dual Brown', 'Dual Grey', 'Frostone Grey', 'Glacier', 
                'National Blue', 'Riviera Red', 'Shadow Brown'
            ],
            'Architectural Cambridge': [
                'Charcoal Grey', 'Driftwood', 'Dual Black', 'Dual Grey', 'Dual Brown', 
                'Earthtone Cedar', 'Harvard Slate', 'Weatherwood'
            ],
            'Traditional 3-Tab': ['Dual Black', 'Dual Brown', 'Dual Grey', 'Weatherwood'],

   
            //GAF Colors
            'Timberline HDZ': [
    'Charcoal', 'Copper', 'Driftwood', 'Hickory', 'Hunter Green', 
    'Mission Brown', 'Oyster Gray', 'Pewter Gray', 'Shakewood', 
    'Slate', 'Weathered Gray', 'Weathered Wood'
],
'Timberline UHDZ': [
    'Charcoal', 'Copper', 'Driftwood', 'Hickory', 'Hunter Green', 
    'Mission Brown', 'Oyster Gray', 'Pewter Gray', 'Shakewood', 
    'Slate', 'Weathered Gray', 'Weathered Wood'
],
'Timberline NS': [
    'Charcoal', 'Driftwood', 'Hickory', 'Hunter Green', 
    'Mission Brown', 'Oyster Gray', 'Pewter Gray', 'Slate'
],
'Timberline AS II': [
    'Antique Slate', 'Barkwood', 'Charcoal', 'Driftwood', 
    'Hickory', 'Mission Brown', 'Oyster Gray', 'Pewter Gray', 'Slate'
],
'Camelot II': [
    'Castle Gray', 'English Gray', 'Rustic Slate', 'Weathered Slate'
],
'Woodland': [
    'Cedar', 'Forest', 'Harvest', 'Timber'
],
'Slateline': [
    'Antique Slate', 'Autumn Harvest', 'Birchwood', 'Charcoal', 
    'Driftwood', 'Slate'
],
'Grand Sequoia': [
    'Aged Cedar', 'Barkwood', 'Cedar', 'Hickory', 'Rustic Slate'
],
'Grand Sequoia AS': [
    'Aged Cedar', 'Barkwood', 'Cedar', 'Hickory', 'Rustic Slate'
],
'Royal Sovereign': [
    'Charcoal', 'Driftwood', 'Hickory', 'Slate'
]

        };
        
       const colors = colorMap[model] || [];
oldColorSelect.innerHTML += colors.map(color => `<option value="${color}">${color}</option>`).join('');

// Add Other option to all color selections
oldColorSelect.innerHTML += '<option value="Other">Other</option>';

// Add event listener for Other selection
oldColorSelect.addEventListener('change', function() {
    if (this.value === 'Other') {
        const customValue = prompt('Enter custom color:');
        if (customValue) {
            const newOption = new Option(customValue, customValue);
            this.add(newOption);
            this.value = customValue;
        } else {
            this.value = '';
        }
    }
});
} else if (model === 'Other' && !recordPopulation) {
    const customValue = prompt('Enter custom model:');
    if (customValue) {
        const modelSelect = document.getElementById('modelOfMaterial');
        const newOption = new Option(customValue, customValue);
        modelSelect.add(newOption);
        modelSelect.value = customValue;
        
        // Add Other option for color when custom model is entered
        oldColorSelect.innerHTML = `
            <option value="">Select...</option>
            <option value="Other">Other</option>
        `;
        
        // Add event listener for Other selection in color
        oldColorSelect.addEventListener('change', function() {
            if (this.value === 'Other') {
                const customColor = prompt('Enter custom color:');
                if (customColor) {
                    const newOption = new Option(customColor, customColor);
                    this.add(newOption);
                    this.value = customColor;
                } else {
                    this.value = '';
                }
            }
        });
    } else {
        document.getElementById('modelOfMaterial').value = '';
    }
}

// Add event listeners for gutter dropdowns
const gutterDropdowns = ['gutterSize', 'gutterColor', 'gutterBrand'];
gutterDropdowns.forEach(id => {
    const select = document.getElementById(id);
    select.addEventListener('change', function() {
        if (this.value === 'Other') {
            console.log('Other selected');
            const customValue = prompt(`Enter custom ${id.replace('gutter', '').toLowerCase()}:`);
            if (customValue) {
                console.log(`Custom value entered: ${customValue}`);
                const newOption = new Option(customValue, customValue);
                this.add(newOption);
                this.value = customValue;
            } else {
                this.value = '';
            }
        }
    });
});
}






    async function addNote() {
        const noteText = document.getElementById('notes').value;
        const streetAddress = document.getElementById('streetAddress').value;
        
        if (!noteText || !streetAddress) {
            showNotification('Please enter both a note and street address. Please try again.', 'error');            
            return;
        }

        try {
            const response = await fetch('/api/notes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    streetAddress: streetAddress,
                    note: noteText,
                    timestamp: new Date().toISOString()
                })
            });

            if (!response.ok) throw new Error('Failed to save note');
            
            document.getElementById('notes').value = '';
            loadNotes(streetAddress);
            showNotification('Note added successfully', 'success');            
        } catch (error) {
            showNotification('Error saving note', 'error');            
            console.error('Error:', error);
        }
    }

    async function loadNotes(streetAddress) {
        if (!streetAddress) return;
        
        try {
            const response = await fetch(`/api/notes/${encodeURIComponent(streetAddress)}`);
            const notes = await response.json();
            
            const notesList = document.getElementById('notesList');
            notesList.innerHTML = notes.map(note => `
                <div style="border-bottom: 1px solid #eee; padding: 5px;">
                    <strong>${new Date(note.timestamp).toLocaleString()}</strong><br>
                    ${note.note}
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading notes:', error);
        }
    }

    async function searchRecord() {
        // First initialize all fields in the user data section
    document.getElementById('clientForm').reset();
    
    // Clear dependent dropdowns
    document.getElementById('roofType').innerHTML = '<option value="">Select...</option>';
    document.getElementById('modelOfMaterial').innerHTML = '<option value="">Select...</option>';
    document.getElementById('color').innerHTML = '<option value="">Select...</option>';
    
    // Reset mobile access code group
    document.getElementById('mobileAccessCodeGroup').style.display = 'none';
    document.getElementById('mobileAccessCode').value = '';
    
    // Clear notes list
    document.getElementById('notesList').innerHTML = '';
    
    // Reset device fields
    for (let i = 1; i <= 10; i++) {
        document.getElementById(`deviceName${i}`).value = '';
        document.getElementById(`deviceMac${i}`).value = '';
        document.getElementById(`deviceSku${i}`).value = '';
    }
        const searchParams = {
            firstName: document.getElementById('searchFirstName').value,
            lastName: document.getElementById('searchLastName').value,
            streetAddress: document.getElementById('searchAddress').value,
            city: document.getElementById('searchCity').value,
            state: document.getElementById('searchState').value,
            zipCode: document.getElementById('searchZipCode').value,
            phoneNumber: document.getElementById('searchPhone').value,
            email: document.getElementById('searchEmail').value,
            customerNumber: document.getElementById('searchcustomerNumber').value,
            referralFirstName: document.getElementById('searchReferralFirstName').value,
            referralLastName: document.getElementById('searchReferralLastName').value,
            referralPhone: document.getElementById('searchReferralPhone').value,
            referralEmail: document.getElementById('searchReferralEmail').value
        };

        // Remove empty search parameters
        Object.keys(searchParams).forEach(key => {
            if (!searchParams[key]) delete searchParams[key];
        });

        if (Object.keys(searchParams).length === 0) {
            showNotification('Please enter at least one search criterion', 'error');            
            return;
        }

        try {
            const queryString = new URLSearchParams(searchParams).toString();
            const response = await fetch(`/api/search?${queryString}`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error('Search failed');
            }
            
            searchResults = data;
            
            if (searchResults.length === 0) {
                showNotification('No matching records found', 'error');                
                return;
            }

            currentResultIndex = 0;
            displayCurrentRecord();
            updateNavigationButtons();
            
        } catch (error) {
        console.error('Search error:', error);
        showNotification('Error performing search: ' + error.message, 'error');        
        }
    }

    function updateNavigationButtons() {
    document.getElementById('prevButton').disabled = currentResultIndex === 0;
    document.getElementById('nextButton').disabled = currentResultIndex === searchResults.length - 1;
}

async function deleteRecord() {
    const recordId = document.getElementById('recordId').value;
    
    if (!recordId) {
        showNotification('No record selected for deletion', 'error');        
        return;
    }
    
    if (!confirm('Are you sure you want to delete this record? This will also delete all associated notes.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/client/${recordId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Error deleting record');
        }
        showNotification('Record and associated notes deleted successfully', 'success');
        
        // Reset form and search results
        searchResults = [];
        currentResultIndex = 0;
        document.getElementById('recordCounter').textContent = '';
        document.getElementById('prevButton').disabled = true;
        document.getElementById('nextButton').disabled = true;
        prepareNextUser();
        document.getElementById('deleteRecordBtn').style.display = 'none';
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
        console.error('Delete error:', error);
    }
}

    
function displayCurrentRecord() {
    const data = searchResults[currentResultIndex];
    console.log('Record data:', data);

    // Show delete buttons when displaying a record
    document.getElementById('deleteRecordBtn').style.display = 'inline-block';
    document.getElementById('deleteRecordBtn2').style.display = 'inline-block';

    // Store the record ID for update operations
    document.getElementById('recordId').value = data.rowid || '';

    // Safely populate fields only if they exist
    const setFieldValue = (id, value) => {
        const element = document.getElementById(id);
        if (element) {
            element.value = value || '';
        } else {
            console.warn(`Element with ID '${id}' not found.`);
        }
    };

    // Populate fields
    setFieldValue('customerNumber', data.customerNumber);
    setFieldValue('username', data.username);
    setFieldValue('firstName', data.firstName);
    setFieldValue('lastName', data.lastName);
    setFieldValue('streetAddress', data.streetAddress);
    setFieldValue('city', data.city);
    setFieldValue('state', data.state);
    setFieldValue('zipCode', data.zipCode);
    setFieldValue('phoneNumber', data.phoneNumber);
    setFieldValue('email', data.email);
    setFieldValue('customerurl', data.customerurl);
    setFieldValue('referralFirstName', data.referralFirstName);
    setFieldValue('referralLastName', data.referralLastName);
    setFieldValue('referralPhone', data.referralPhone);
    setFieldValue('referralEmail', data.referralEmail);

    // Handle mobile access
    const mobileAppAccessElement = document.getElementById('mobileAppAccess');
    if (mobileAppAccessElement) {
        mobileAppAccessElement.value = data.mobileAppAccess === 1 ? 'Yes' : 'No';
        handleMobileAccessChange();
    }

    setFieldValue('mobileAccessCode', data.mobileAccessCode);

    // Populate roof-related fields
    setFieldValue('roofMaterial', data.roofMaterial);
    setFieldValue('manufacturer', data.manufacturer);

    handleManufacturerChange().then(() => {
        const roofTypeSelect = document.getElementById('roofType');
        if (roofTypeSelect && data.roofType) {
            if (!Array.from(roofTypeSelect.options).some(opt => opt.value === data.roofType)) {
                roofTypeSelect.innerHTML += `<option value="${data.roofType}">${data.roofType}</option>`;
            }
            roofTypeSelect.value = data.roofType;
        }

        const modelSelect = document.getElementById('modelOfMaterial');
        if (modelSelect && data.modelOfMaterial) {
            if (!Array.from(modelSelect.options).some(opt => opt.value === data.modelOfMaterial)) {
                modelSelect.innerHTML += `<option value="${data.modelOfMaterial}">${data.modelOfMaterial}</option>`;
            }
            modelSelect.value = data.modelOfMaterial;

            handleModelChange(true).then(() => {
                const colorSelect = document.getElementById('color');
                if (colorSelect && data.color) {
                    if (!Array.from(colorSelect.options).some(opt => opt.value === data.color)) {
                        colorSelect.innerHTML += `<option value="${data.color}">${data.color}</option>`;
                    }
                    colorSelect.value = data.color;
                }
            });
        }
    });

    // Populate gutter-related fields
    ['gutterSize', 'gutterColor', 'gutterBrand', 'gutterClientType'].forEach(field => {
        setFieldValue(field, data[field]);
        const dropdown = document.getElementById(field);
        if (dropdown && data[field] && !Array.from(dropdown.options).some(opt => opt.value === data[field])) {
            dropdown.innerHTML += `<option value="${data[field]}">${data[field]}</option>`;
        }
    });

    setFieldValue('gutterInstallDate', data.gutterInstallDate);
    setFieldValue('gutterWarrantyExpiration', data.gutterWarrantyExpiration);

    // Handle dates
    if (data.installDate) {
        const installDateElement = document.getElementById('installDate');
        if (installDateElement) installDateElement.value = data.installDate.split('T')[0];
        calculateWarrantyDate();
    }

    if (data.bcsWarrantyExpiration) {
        const warrantyExpirationElement = document.getElementById('bcsWarrantyExpiration');
        if (warrantyExpirationElement) warrantyExpirationElement.value = data.bcsWarrantyExpiration.split('T')[0];
    }

    // Load notes
    loadNotes(data.streetAddress);

    // Handle device fields
    for (let i = 1; i <= 10; i++) {
        setFieldValue(`deviceName${i}`, data[`deviceName${i}`]);
        setFieldValue(`deviceMac${i}`, data[`deviceMac${i}`]);
        setFieldValue(`deviceSku${i}`, data[`deviceSku${i}`]);
    }

    // Update record counter
    const recordCounterElement = document.getElementById('recordCounter');
    if (recordCounterElement) {
        recordCounterElement.textContent = `Record ${currentResultIndex + 1} of ${searchResults.length}`;
    }
}

function showNotification(message, type = 'info') {
    // Remove any existing notifications
    const existingNotifications = document.querySelectorAll('.custom-notification');
    existingNotifications.forEach(notification => notification.remove());
    
    // Create new notification
    const notification = document.createElement('div');
    notification.className = `custom-notification ${type}`;
    notification.textContent = message;
    
    // Add to document
    document.body.appendChild(notification);
    
    // Remove after animation completes
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}



    function nextRecord() {
        if (currentResultIndex < searchResults.length - 1) {
            currentResultIndex++;
            displayCurrentRecord();
            updateNavigationButtons();
        }
    }

    function previousRecord() {
        if (currentResultIndex > 0) {
            currentResultIndex--;
            displayCurrentRecord();
            updateNavigationButtons();
        }
    }

document.getElementById('clientForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const username = document.getElementById('username').value;
    const recordId = document.getElementById('recordId').value;

    console.log('Form submission - recordId:', recordId); // Add this line
    console.log('Form submission - username:', username); // Add this line
    console.log('Form submission - streetAddress:', document.getElementById('streetAddress').value); 
    if (!recordId) {
        console.error('Record ID is missing. This may be a new record.');
    }
    // Check username availability before submitting
    const usernameCheck = await checkUsernameAvailability(username, recordId);
    if (!usernameCheck.available) {
        showNotification('Error: ' + usernameCheck.message + '. Please choose a different username.', 'error');
        document.getElementById('username').focus();
        return;
    }
    
    console.log('CustomerNumber input value:', document.getElementById('customerNumber').value);
    console.log('CustomerNumber input type:', typeof document.getElementById('customerNumber').value);
    console.log('CustomerNumber input length:', document.getElementById('customerNumber').value.length);
   
    const getValue = (id) => {
        const element = document.getElementById(id);
        return element ? element.value : '';
    };
        
    const formData = {
        recordId: getValue('recordId'),
        customerNumber: getValue('customerNumber'),
        username: getValue('username'),
        firstName: getValue('firstName'),
        lastName: getValue('lastName'),
        streetAddress: getValue('streetAddress'),
        city: getValue('city'),
        state: getValue('state'),
        zipCode: getValue('zipCode'),
        phoneNumber: getValue('phoneNumber'),
        email: getValue('email'),
        customerurl: getValue('customerurl'),
        mobileAppAccess: document.getElementById('mobileAppAccess').value === 'Yes' ? 1 : 0,
        mobileAccessCode: getValue('mobileAccessCode'),
        roofMaterial: getValue('roofMaterial'),
        manufacturer: getValue('manufacturer'),
        roofType: getValue('roofType'),
        modelOfMaterial: getValue('modelOfMaterial'),
        color: getValue('color'),
        ventType: getValue('ventType'),
        clientType: getValue('clientType'),
        installDate: getValue('installDate'),
        bcsWarrantyExpiration: getValue('bcsWarrantyExpiration'),
        // Add new gutter fields
        gutterSize: getValue('gutterSize'),
        gutterColor: getValue('gutterColor'),
        gutterBrand: getValue('gutterBrand'),
        gutterClientType: getValue('gutterClientType'),
        gutterInstallDate: getValue('gutterInstallDate'),
        gutterWarrantyExpiration: getValue('gutterWarrantyExpiration'),
        referralFirstName: getValue('referralFirstName'),
        referralLastName: getValue('referralLastName'),
        referralPhone: getValue('referralPhone'),
        referralEmail: getValue('referralEmail'),
    
    };

    console.log('Form Data:', JSON.stringify(formData, null, 2));
    console.log('Mobile App Access Value:', formData.mobileAppAccess);
    console.log('Mobile Access Code:', formData.mobileAccessCode);

    // Add device fields using direct DOM access to match the pattern above
    for (let i = 1; i <= 10; i++) {
    formData[`deviceSku${i}`] = getValue(`deviceSku${i}`);
    formData[`deviceName${i}`] = getValue(`deviceName${i}`);
    formData[`deviceMac${i}`] = getValue(`deviceMac${i}`);
}


    try {
        const response = await fetch('/api/client', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const responseData = await response.json();
        
        if (!response.ok) {
            // Handle specific error for username conflict
            if (response.status === 409 && responseData.field === 'username') {
                showNotification('Error: ' + responseData.error + '. Please choose a different username.', 'error');                
                document.getElementById('username').focus();
                return;
            }
            
            throw new Error(responseData.error || 'Error saving record');
        }
        
        showNotification('Record saved successfully', 'success');
        document.getElementById('notes').value = '';
        document.getElementById('notesList').innerHTML = '';
        if (!searchResults.length) {
            document.getElementById('clientForm').reset();
        }
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
        console.error('Save error:', error);
    }
});


function resetSearchCriteria() {
    // Reset search fields
    document.getElementById('searchFirstName').value = '';
    document.getElementById('searchAddress').value = '';
    document.getElementById('searchPhone').value = '';
    document.getElementById('searchLastName').value = '';
    document.getElementById('searchCity').value = '';
    document.getElementById('searchZipCode').value = '';
    document.getElementById('searchEmail').value = '';
    document.getElementById('searchcustomerNumber').value = '';
    document.getElementById('searchState').selectedIndex = 0;
    document.getElementById('searchReferralFirstName').value = '';
    document.getElementById('searchReferralLastName').value = '';
    document.getElementById('searchReferralPhone').value = '';
    document.getElementById('searchReferralEmail').value = '';

    // Reset user data fields
    document.getElementById('clientForm').reset();

    // Clear dependent dropdowns
    document.getElementById('roofType').innerHTML = '<option value="">Select...</option>';
    document.getElementById('modelOfMaterial').innerHTML = '<option value="">Select...</option>';
    document.getElementById('color').innerHTML = '<option value="">Select...</option>';

    // Reset mobile access code group
    document.getElementById('mobileAccessCodeGroup').style.display = 'none';
    document.getElementById('mobileAccessCode').value = '';

    // Clear notes list
    document.getElementById('notesList').innerHTML = '';
    
    // Reset gutter fields
    document.getElementById('gutterSize').selectedIndex = 0;
    document.getElementById('gutterColor').selectedIndex = 0;
    document.getElementById('gutterBrand').selectedIndex = 0;


    // Reset device fields
    for (let i = 1; i <= 10; i++) {
        document.getElementById(`deviceName${i}`).value = '';
        document.getElementById(`deviceMac${i}`).value = '';
        document.getElementById(`deviceSku${i}`).value = '';
    }

    // Clear search results and update UI
    searchResults = [];
    currentResultIndex = 0;
    document.getElementById('recordCounter').textContent = '';
    document.getElementById('prevButton').disabled = true;
    document.getElementById('nextButton').disabled = true;

    // Hide delete buttons
    document.getElementById('deleteRecordBtn').style.display = 'none';
    document.getElementById('deleteRecordBtn2').style.display = 'none';
    }

document.addEventListener('DOMContentLoaded', function() {
    const gutterDropdowns = ['gutterSize', 'gutterColor', 'gutterBrand'];
    
    gutterDropdowns.forEach(id => {
        const dropdown = document.getElementById(id);
        dropdown.addEventListener('change', handleGutterDropdownChange);
        document.getElementById('gutterClientType').addEventListener('change', handleGutterDropdownChange);
    });

    // Mutation observer to handle dynamically added options
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList' && mutation.target.tagName === 'SELECT') {
                const dropdown = mutation.target;
                if (gutterDropdowns.includes(dropdown.id)) {
                    dropdown.removeEventListener('change', handleGutterDropdownChange);
                    dropdown.addEventListener('change', handleGutterDropdownChange);
                }
            }
        });
    });

    gutterDropdowns.forEach(id => {
        const dropdown = document.getElementById(id);
        observer.observe(dropdown, { childList: true });
    });
});

function handleGutterDropdownChange(event) {
    if (event.target.value === 'Other') {
        let promptMessage;
        switch(event.target.id) {
            case 'gutterSize':
                promptMessage = 'Enter custom gutter size:';
                break;
            case 'gutterColor':
                promptMessage = 'Enter custom gutter color:';
                break;
            case 'gutterBrand':
                promptMessage = 'Enter custom gutter brand:';
                break;
            case 'gutterClientType':
                promptMessage = 'Enter custom owner status:';
                break;
            default:
                promptMessage = 'Enter custom value:';
        }
        const customValue = prompt(promptMessage);
        if (customValue) {
            const newOption = new Option(customValue, customValue);
            event.target.add(newOption);
            event.target.value = customValue;
        } else {
            event.target.value = '';
        }
    }
}

   
function populateDeviceMacDropdown() {
  fetch('/api/dropdowns/deviceMac')
    .then(response => response.json())
    .then(macs => {
      const dropdown = document.getElementById('deviceMacDropdown');
      dropdown.innerHTML = ''; // Clear existing options
      macs.forEach(mac => {
        const option = document.createElement('option');
        option.value = mac;
        option.textContent = mac;
        dropdown.appendChild(option);
      });
    })
    .catch(error => console.error('Error fetching MAC addresses:', error));
}

async function checkUsernameAvailability(username, recordId = null) {
    try {
        const params = new URLSearchParams({ username });
        if (recordId) {
            params.append('excludeId', recordId);
        }
        
        const response = await fetch(`/api/check-username?${params}`);
        const data = await response.json();
        
        return data;
    } catch (error) {
        console.error('Error checking username:', error);
        return { available: true, message: 'Error checking username availability' };
    }
}

function manualPopulateDropdown() {
  console.log('Attempting to populate dropdown');
  
  const dropdown = document.getElementById('devicemacdropdown');
  console.log('Dropdown element:', dropdown);

  if (!dropdown) {
    console.error('Dropdown not found. Check HTML ID.');
    return;
  }

  fetch('/api/dropdowns/devicemacdropdown')
    .then(response => {
      console.log('Fetch response:', response);
      return response.json();
    })
    .then(macs => {
      console.log('Retrieved MAC addresses:', macs);
      
      dropdown.innerHTML = ''; // Clear existing options
      
      // Add default option
      const defaultOption = document.createElement('option');
      defaultOption.textContent = 'Select MAC Address...';
      defaultOption.value = '';
      dropdown.appendChild(defaultOption);

      // Populate MAC addresses
      macs.forEach(mac => {
        const option = document.createElement('option');
        option.value = mac;
        option.textContent = mac;
        dropdown.appendChild(option);
      });
    })
    .catch(error => console.error('Manual population error:', error));
}

function uploadMedia() {
    // Implementation for uploading documents/images/videos
    alert('Upload functionality will be implemented here');
}


// Upload Modal Functions
function uploadMedia() {
  document.getElementById('uploadModal').style.display = 'flex';
  resetUploadForm();
}

function closeUploadModal() {
  document.getElementById('uploadModal').style.display = 'none';
}

function resetUploadForm() {
  document.getElementById('fileInput').value = '';
  document.getElementById('topicSelect').value = '';
  document.getElementById('mediaTypeSelect').value = '';
  document.getElementById('mediaDescription').value = '';
  document.getElementById('customerViewCheck').checked = false;
  document.getElementById('internalViewCheck').checked = true;
  document.getElementById('uploadStatus').style.display = 'none';
}

function submitUpload() {
  // Get form values
  const fileInput = document.getElementById('fileInput');
  const topic = document.getElementById('topicSelect').value;
  const mediaType = document.getElementById('mediaTypeSelect').value;
  const description = document.getElementById('mediaDescription').value;
  const customerView = document.getElementById('customerViewCheck').checked ? 1 : 0;
  const internalView = document.getElementById('internalViewCheck').checked ? 1 : 0;
  const statusElement = document.getElementById('uploadStatus');
  
  // Validate inputs
  if (!fileInput.files || fileInput.files.length === 0) {
    showUploadStatus('Please select a file to upload', 'error');
    return;
  }
  
  if (!topic) {
    showUploadStatus('Please select a topic (Roof, Gutter, or Attic)', 'error');
    return;
  }
  
  if (!mediaType) {
    showUploadStatus('Please select a media type (Document, Image, or Video)', 'error');
    return;
  }
  
  // Create FormData object for file upload
  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  formData.append('topic', topic);
  formData.append('mediaType', mediaType);
  formData.append('description', description);
  formData.append('customerView', customerView);
  formData.append('internalView', internalView);
  formData.append('customerNumber', document.getElementById('customerNumber').value);
  
  // Show uploading status
  showUploadStatus('Uploading, please wait...', 'info');
  
  // Send the upload request
  fetch('/api/upload-media', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      showUploadStatus(`Error: ${data.error}`, 'error');
    } else {
      showUploadStatus('File uploaded successfully!', 'success');
      // Reset form after successful upload if needed
      // resetUploadForm();
    }
  })
  .catch(error => {
    showUploadStatus(`Upload failed: ${error.message}`, 'error');
  });
}

function showUploadStatus(message, type) {
  const statusElement = document.getElementById('uploadStatus');
  statusElement.textContent = message;
  statusElement.style.display = 'block';
  
  // Set color based on message type
  if (type === 'error') {
    statusElement.style.color = '#dc3545';
  } else if (type === 'success') {
    statusElement.style.color = '#28a745';
  } else {
    statusElement.style.color = '#007bff';
  }
}

let currentCustomerMedia = {
  docs: [],
  images: [],
  videos: []
};

function updateFileViewSetting(mediaType, category, fileId, viewType, isChecked) {
  const customerNumber = document.getElementById('customerNumber').value;
  if (!customerNumber) {
    showNotification('Customer number is required', 'error');
    return;
  }

  // Get the filename from the DOM (assuming it's in the parent container of the checkbox)
  const checkbox = event.target;
  const mediaItem = checkbox.closest('.media-item');
  const filename = mediaItem.querySelector('div:first-child').textContent;

  // Convert boolean to integer for database storage
  const viewValue = isChecked ? 1 : 0;
  
  // Prepare the data for the API call
  const updateData = {
    mediaType,
    category,
    fileId,
    customerNumber,
    viewType, // 'customer' or 'internal'
    value: viewValue,
    filename // Add filename to identify the correct row
  };
  
  // Send update to server
  fetch('/api/update-file-view', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(updateData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the local data to match the server
      updateLocalMediaViewSetting(mediaType, category, fileId, viewType, viewValue);
      showNotification(`${viewType.charAt(0).toUpperCase() + viewType.slice(1)} view setting updated`, 'success');
    } else {
      showNotification(`Error updating view setting: ${data.error}`, 'error');
      // Revert the checkbox state
      checkbox.checked = !isChecked;
    }
  })
  .catch(error => {
    console.error('Error updating view setting:', error);
    showNotification('Failed to update view setting', 'error');
    // Revert the checkbox state
    checkbox.checked = !isChecked;
  });
}

// Helper function to update the local data structure
function updateLocalMediaViewSetting(mediaType, category, fileId, viewType, value) {
  const mediaTypeKey = mediaType === 'Document' ? 'docs' : 
                      mediaType === 'Image' ? 'images' : 'videos';
  
  if (currentCustomerMedia[mediaTypeKey]) {
    currentCustomerMedia[mediaTypeKey].forEach(item => {
      if (item.id === fileId && item.category === category) {
        if (viewType === 'customer') {
          item.customerView = value;
        } else if (viewType === 'internal') {
          item.internalView = value;
        }
      }
    });
  }
}


function viewDownloadMedia() {
  console.log('viewDownloadMedia function called');
  const customerNumber = document.getElementById('customerNumber').value;
  
  if (!customerNumber) {
    showNotification('Please select a customer record first', 'error');
    return;
  }
  
  console.log('Customer number:', customerNumber);
  
  // Reset filters
  document.getElementById('filterDocs').checked = true;
  document.getElementById('filterImages').checked = true;
  document.getElementById('filterVideos').checked = true;
  
  // Show the modal
  document.getElementById('viewDownloadModal').style.display = 'flex';
  
  // Fetch customer media data
  fetchCustomerMedia(customerNumber);
}

function downloadMedia(mediaType, category, customerId) {
  const url = `/api/download-media/${mediaType}/${category}/${customerId}`;
  console.log('Download URL:', url);
  window.open(url, '_blank');
}


function fetchCustomerMedia(customerNumber) {
  console.log('Fetching media for customer:', customerNumber);
  
  // Validate customer number
  if (!customerNumber) {
    showNotification('Customer number is required', 'error');
    return;
  }
  
  // Clear previous data
  currentCustomerMedia = {
    docs: [],
    images: [],
    videos: []
  };
  
  // Set loading indicators
  document.getElementById('documentsList').innerHTML = '<p class="no-items-message">Loading documents...</p>';
  document.getElementById('imagesList').innerHTML = '<p class="no-items-message">Loading images...</p>';
  document.getElementById('videosList').innerHTML = '<p class="no-items-message">Loading videos...</p>';
  
  // Fetch documents
  fetch(`/api/customer-docs/${customerNumber}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      currentCustomerMedia.docs = data.docs || [];
      displayMediaItems('docs');
      updateViewCheckboxes();
    })
    .catch(error => {
      console.error('Error fetching documents:', error);
      document.getElementById('documentsList').innerHTML = 
        `<p class="no-items-message">Error loading documents: ${error.message}</p>`;
    });
  
  // Fetch images
  fetch(`/api/customer-images/${customerNumber}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      currentCustomerMedia.images = data.images || [];
      displayMediaItems('images');
      updateViewCheckboxes();
    })
    .catch(error => {
      console.error('Error fetching images:', error);
      document.getElementById('imagesList').innerHTML = 
        `<p class="no-items-message">Error loading images: ${error.message}</p>`;
    });
  
  // Fetch videos
  fetch(`/api/customer-videos/${customerNumber}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      currentCustomerMedia.videos = data.videos || [];
      displayMediaItems('videos');
      updateViewCheckboxes();
    })
    .catch(error => {
      console.error('Error fetching videos:', error);
      document.getElementById('videosList').innerHTML = 
        `<p class="no-items-message">Error loading videos: ${error.message}</p>`;
    });
}

// Helper function to update view checkboxes based on any available media
function updateViewCheckboxes() {
  // Check if we have any media items with view settings
  const allMedia = [
    ...currentCustomerMedia.docs,
    ...currentCustomerMedia.images,
    ...currentCustomerMedia.videos
  ];
  
  if (allMedia.length > 0) {
    // Find first item with view settings
    const itemWithSettings = allMedia.find(item => 
      item.customerView !== undefined || item.internalView !== undefined);
    
    if (itemWithSettings) {
      document.getElementById('customerViewCheck').checked = itemWithSettings.customerView === 1;
      document.getElementById('internalViewCheck').checked = itemWithSettings.internalView === 1;
    }
  }
}

function displayMediaItems(mediaType) {
  const items = currentCustomerMedia[mediaType];
  const containerId = mediaType === 'docs' ? 'documentsList' : 
                      mediaType === 'images' ? 'imagesList' : 'videosList';
  const container = document.getElementById(containerId);
  const customerNumber = document.getElementById('customerNumber').value;
  
  if (!items || items.length === 0) {
    container.innerHTML = `<p class="no-items-message">No ${mediaType} found</p>`;
    return;
  }

  // Group items by category
  const groupedItems = {
    Roof: [],
    Gutter: [],
    Attic: []
  };

  items.forEach(item => {
    if (groupedItems[item.category]) {
      groupedItems[item.category].push(item);
    }
  });

  let html = '';
  
  // Create containers for each category
  for (const [category, categoryItems] of Object.entries(groupedItems)) {
    if (categoryItems.length === 0) continue;

    html += `
      <div class="media-category-container" style="margin-bottom: 30px; border: 2px solid black; padding: 10px;">
        <h4 class="media-type-title" style="background-color: #b3e0e5; border-bottom: 4px solid #000; padding-bottom: 5px;">
          ${category} ${mediaType.charAt(0).toUpperCase() + mediaType.slice(1)}
        </h4>
    `;

    categoryItems.forEach(item => {
      // Convert mediaType to server-expected format
      const serverMediaType = 
        mediaType === 'docs' ? 'Document' : 
        mediaType === 'images' ? 'Image' : 
        mediaType === 'videos' ? 'Video' : mediaType;

      html += `
        <div class="media-item" style="margin: 10px 0; padding: 10px; border: 1px solid #eee; data-category="${item.category}" data-type="${mediaType === 'docs' ? 'doc' : mediaType.slice(0, -1)}">
          <div style="font-weight: bold;">${item.filename}</div>
          <div style="color: #666; font-size: 0.9em;">${item.description}</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <button onclick="downloadMedia('${serverMediaType}', '${item.category}', '${customerNumber}')" 
                      class="btn btn-primary btn-sm">
                Download
              </button>
              <button onclick="deleteMedia('${serverMediaType}', '${item.category}', '${customerNumber}', '${item.filename}')" 
                      class="btn btn-danger btn-sm">
                Delete
              </button>
            </div>
            <div class="view-settings" style="display: flex; gap: 10px; align-items: center; background-color: #f8f9fa; padding: 5px 10px; border-radius: 4px;">
              <label style="margin-bottom: 0; display: flex; align-items: center; font-size: 0.9em; cursor: pointer;">
                <input type="checkbox" ${item.customerView ? 'checked' : ''} 
                       onchange="updateFileViewSetting('${serverMediaType}', '${item.category}', '${item.id}', 'customer', this.checked, '${item.filename}')" 
                       style="margin-right: 5px;">
                Customer View
              </label>
              <label style="margin-bottom: 0; display: flex; align-items: center; font-size: 0.9em; cursor: pointer;">
                <input type="checkbox" ${item.internalView ? 'checked' : ''} 
                       onchange="updateFileViewSetting('${serverMediaType}', '${item.category}', '${item.id}', 'internal', this.checked, '${item.filename}')" 
                       style="margin-right: 5px;">
                Internal View
              </label>
            </div>
          </div>
        </div>
      `;
    });

    html += `</div>`; // Close media-category-container
  }

  container.innerHTML = html || `<p class="no-items-message">No ${mediaType} found in any category</p>`;
}
// Add this function if it doesn't already exist
function downloadMedia(mediaType, category, customerNumber) {
  
  // Validate mediaType casing (Document/Image/Video)
  const normalizedMediaType = mediaType === 'docs' ? 'Document' : 
                             mediaType === 'images' ? 'Image' :
                             mediaType === 'videos' ? 'Video' : mediaType;

  // Encode category to handle spaces/special characters
  const encodedCategory = encodeURIComponent(category);
  
  console.log(`Downloading: type=${mediaType}, category=${category}, customer=${customerNumber}`);
  const url = `/api/download-media/${normalizedMediaType}/${encodedCategory}/${customerNumber}`;
  console.log('Download URL:', url);
  window.open(url, '_blank');
}
  

function applyMediaFilters() {
  // Get Type filter values
  const showDocs = document.getElementById('filterDocs').checked;
  const showImages = document.getElementById('filterImages').checked;
  const showVideos = document.getElementById('filterVideos').checked;
  
  // Get Category filter values
  const showRoof = document.getElementById('filterRoof').checked;
  const showGutter = document.getElementById('filterGutter').checked;
  const showAttic = document.getElementById('filterAttic').checked;
  
  // Show/hide the document sections based on filters
  document.getElementById('documentsSection').style.display = showDocs ? 'block' : 'none';
  document.getElementById('imagesSection').style.display = showImages ? 'block' : 'none';
  document.getElementById('videosSection').style.display = showVideos ? 'block' : 'none';
  
  // Filter the actual media items by category
  const allMediaItems = document.querySelectorAll('.media-item');
  allMediaItems.forEach(item => {
    const category = item.getAttribute('data-category');
    const mediaType = item.getAttribute('data-type');
    
    // Check if this item's type is selected
    let typeSelected = false;
    if (mediaType === 'doc' && showDocs) typeSelected = true;
    if (mediaType === 'image' && showImages) typeSelected = true;
    if (mediaType === 'video' && showVideos) typeSelected = true;
    
    // Check if this item's category is selected
    let categorySelected = false;
    if (category === 'Roof' && showRoof) categorySelected = true;
    if (category === 'Gutter' && showGutter) categorySelected = true;
    if (category === 'Attic' && showAttic) categorySelected = true;
    
    // Show the item only if both type and category are selected
    item.style.display = (typeSelected && categorySelected) ? 'block' : 'none';
  });
  
  // Update the "no items" messages
  updateNoItemsMessages();
}

function updateNoItemsMessages() {
  // For each section, check if there are any visible items
  const sections = ['documents', 'images', 'videos'];
  
  sections.forEach(section => {
    const container = document.getElementById(`${section}List`);
    const items = container.querySelectorAll('.media-item:not([style*="display: none"])');
    const noItemsMessage = container.querySelector('.no-items-message');
    
    if (items.length === 0 && noItemsMessage) {
      noItemsMessage.style.display = 'block';
    } else if (noItemsMessage) {
      noItemsMessage.style.display = 'none';
    }
  });
}


// Ensure category names match server expectations
function downloadMedia(mediaType, category) {
  const customerNumber = document.getElementById('customerNumber').value;
  if (!customerNumber) return;
  
  // Pass category AS-IS (Roof/Gutter/Attic)
  const url = `/api/download-media/${mediaType}/${category}/${customerNumber}`;
  window.open(url, '_blank');
}


function closeMediaViewer() {
  const modal = document.getElementById('mediaViewerModal');
  if (modal) {
    modal.remove();
  }
}

function viewMedia(id, category) {
  const customerNumber = document.getElementById('customerNumber').value;
  window.open(`/api/view-media/${category}/${customerNumber}`, '_blank');
}

function showConfirmationDialog(message, onConfirm) {
  const dialog = document.getElementById('confirmationDialog');
  const messageElement = document.getElementById('confirmationMessage');
  const yesButton = document.getElementById('confirmYes');
  const noButton = document.getElementById('confirmNo');
  
  messageElement.textContent = message;
  dialog.style.display = 'flex';
  
  // Remove any existing event listeners
  const newYesButton = yesButton.cloneNode(true);
  const newNoButton = noButton.cloneNode(true);
  yesButton.parentNode.replaceChild(newYesButton, yesButton);
  noButton.parentNode.replaceChild(newNoButton, noButton);
  
  // Add new event listeners
  newYesButton.addEventListener('click', () => {
    dialog.style.display = 'none';
    onConfirm();
  });
  
  newNoButton.addEventListener('click', () => {
    dialog.style.display = 'none';
  });
}


function deleteMedia(mediaType, category, customerNumber, filename) {
  showConfirmationDialog(`Are you sure you want to delete this ${mediaType.toLowerCase()}?`, () => {
    // This code runs only if user confirms
    fetch(`/api/delete-media/${mediaType}/${category}/${customerNumber}/${encodeURIComponent(filename)}`, {
      method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(`${mediaType} deleted successfully`, 'success');
        fetchCustomerMedia(customerNumber);
      } else {
        showNotification(`Error deleting ${mediaType}: ${data.error}`, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification(`Failed to delete ${mediaType}`, 'error');
    });
  });
}
function saveViewSettings() {
  const customerNumber = document.getElementById('customerNumber').value;
  
  // Force a direct DOM access to get the current state
  const customerViewCheck = document.getElementById('modalcustomerViewCheck');
  const internalViewCheck = document.getElementById('modalinternalViewCheck');
  
  // Log the actual elements and their states for debugging
  console.log('Raw checkbox states:', {
    customerViewChecked: customerViewCheck ? customerViewCheck.checked : null,
    internalViewChecked: internalViewCheck ? internalViewCheck.checked : null
  });
  
  // Convert checkbox states to integers (0 or 1)
  const customerView = customerViewCheck && customerViewCheck.checked ? 1 : 0;
  const internalView = internalViewCheck && internalViewCheck.checked ? 1 : 0;
  
  console.log('Sending values:', {
    customerNumber: customerNumber,
    customerView: customerView,
    internalView: internalView
  });
  
  fetch('/api/update-media-views', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      customerNumber,
      customerView,
      internalView
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('View settings updated successfully', 'success');
      // Refresh the media display to show updated settings
      fetchCustomerMedia(customerNumber);
    } else {
      showNotification(`Error: ${data.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Error updating view settings:', error);
    showNotification('Error updating view settings', 'error');
  });
}

function goToSearch() {
  closeViewDownloadModal();
  // Scroll to search section
  document.querySelector('.search-section').scrollIntoView({ behavior: 'smooth' });
}

function closeViewDownloadModal() {
  document.getElementById('viewDownloadModal').style.display = 'none';
}

function createMediaViewerModal(customerNumber) {
  // Create modal container if it doesn't exist
  let mediaModal = document.getElementById('mediaViewerModal');
  
  if (!mediaModal) {
    mediaModal = document.createElement('div');
    mediaModal.id = 'mediaViewerModal';
    mediaModal.className = 'modal-overlay';
    mediaModal.style.display = 'none';
    document.body.appendChild(mediaModal);
  }
  
  // Set up the modal content with the customer number already known
  mediaModal.innerHTML = `
    <div class="modal-content" style="width: 80%; max-width: 1200px; max-height: 80vh; overflow-y: auto;">
      <h2>View/Download Media</h2>
      
      <div style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
          <label><input type="checkbox" id="roofMediaCheck" checked> Roof</label>
          <label><input type="checkbox" id="gutterMediaCheck"> Gutters</label>
          <label><input type="checkbox" id="atticMediaCheck"> Attic</label>
          <button type="button" class="btn btn-primary" onclick="applyMediaFilters()" style="margin-left: auto;">Apply Filters</button>
        </div>
      </div>
      
      <div id="mediaContent" style="display: grid; grid-template-columns: 1fr; gap: 20px;">
        <!-- Media content will be loaded here -->
        <div id="documentsSection">
          <h3>Documents</h3>
          <div id="documentsContent" class="media-grid"></div>
        </div>
        
        <div id="imagesSection">
          <h3>Images</h3>
          <div id="imagesContent" class="media-grid"></div>
        </div>
        
        <div id="videosSection">
          <h3>Videos</h3>
          <div id="videosContent" class="media-grid"></div>
        </div>
      </div>
      
      <div style="margin-top: 20px; text-align: right;">
        <button type="button" class="btn" onclick="closeMediaViewerModal()">Close</button>
      </div>
    </div>
  `;
  
  // Show the modal
  mediaModal.style.display = 'flex';
  
  // Load media for the customer
  applyMediaFilters();
}

function applyMediaFilters() {
  const showDocs = document.getElementById('filterDocs');
  const showImages = document.getElementById('filterImages');
  const showVideos = document.getElementById('filterVideos');
  
  const docsSection = document.getElementById('documentsSection');
  const imagesSection = document.getElementById('imagesSection');
  const videosSection = document.getElementById('videosSection');
  
  // Check if elements exist before accessing their properties
  if (showDocs && docsSection) {
    docsSection.style.display = showDocs.checked ? 'block' : 'none';
  }
  
  if (showImages && imagesSection) {
    imagesSection.style.display = showImages.checked ? 'block' : 'none';
  }
  
  if (showVideos && videosSection) {
    videosSection.style.display = showVideos.checked ? 'block' : 'none';
  }
}

async function loadCustomerMedia(filters) {
  const customerNumber = document.getElementById('customerNumber').value;
  
  try {
    // Clear existing content
    document.getElementById('documentsContent').innerHTML = '<div class="no-media-message">Loading documents...</div>';
    document.getElementById('imagesContent').innerHTML = '<div class="no-media-message">Loading images...</div>';
    document.getElementById('videosContent').innerHTML = '<div class="no-media-message">Loading videos...</div>';
    
    // Create filter string for API
    const filterParams = new URLSearchParams();
    filterParams.append('customerNumber', customerNumber);
    if (filters.roof) filterParams.append('topics[]', 'Roof');
    if (filters.gutter) filterParams.append('topics[]', 'Gutter');
    if (filters.attic) filterParams.append('topics[]', 'Attic');
    
    // Fetch media data from server
    const response = await fetch(`/api/customer-media?${filterParams.toString()}`);
    const mediaData = await response.json();
    
    if (!response.ok) {
      throw new Error(mediaData.error || 'Error loading media');
    }
    
    // Process and display the media
    displayMediaByType(mediaData);
    
  } catch (error) {
    console.error('Error loading media:', error);
    showNotification('Error loading media: ' + error.message, 'error');
    
    // Show error message in each section
    const errorMessage = '<div class="no-media-message">Error loading media</div>';
    document.getElementById('documentsContent').innerHTML = errorMessage;
    document.getElementById('imagesContent').innerHTML = errorMessage;
    document.getElementById('videosContent').innerHTML = errorMessage;
  }
}

function displayMediaByType(mediaData) {
  // Get container elements
  const documentsContainer = document.getElementById('documentsContent');
  const imagesContainer = document.getElementById('imagesContent');
  const videosContainer = document.getElementById('videosContent');
  
  // Clear containers
  documentsContainer.innerHTML = '';
  imagesContainer.innerHTML = '';
  videosContainer.innerHTML = '';
  
  // Process documents
  if (mediaData.documents && mediaData.documents.length > 0) {
    mediaData.documents.forEach(doc => {
      const docItem = createMediaItemElement(doc, 'document');
      documentsContainer.appendChild(docItem);
    });
  } else {
    documentsContainer.innerHTML = '<div class="no-media-message">No documents found</div>';
  }
  
  // Process images
  if (mediaData.images && mediaData.images.length > 0) {
    mediaData.images.forEach(img => {
      const imgItem = createMediaItemElement(img, 'image');
      imagesContainer.appendChild(imgItem);
    });
  } else {
    imagesContainer.innerHTML = '<div class="no-media-message">No images found</div>';
  }
  
  // Process videos
  if (mediaData.videos && mediaData.videos.length > 0) {
    mediaData.videos.forEach(video => {
      const videoItem = createMediaItemElement(video, 'video');
      videosContainer.appendChild(videoItem);
    });
  } else {
    videosContainer.innerHTML = '<div class="no-media-message">No videos found</div>';
  }
}

function createMediaItemElement(mediaItem, type) {
  const itemDiv = document.createElement('div');
  itemDiv.className = 'media-item';
  
  // Create filename element
  const filenameDiv = document.createElement('div');
  filenameDiv.className = 'media-filename';
  filenameDiv.textContent = mediaItem.filename || 'Unnamed file';
  itemDiv.appendChild(filenameDiv);
  
  // Create media preview based on type
  let mediaElement;
  
  switch (type) {
    case 'document':
      mediaElement = document.createElement('div');
      mediaElement.innerHTML = `
        <svg class="document-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5v10H6V3h7z"/>
        </svg>
      `;
      mediaElement.onclick = () => openMedia(mediaItem.id, type);
      break;
      
    case 'image':
      mediaElement = document.createElement('img');
      mediaElement.src = `/api/media/${type}/${mediaItem.id}?thumbnail=true`;
      mediaElement.alt = mediaItem.description || 'Image';
      mediaElement.onclick = () => openMedia(mediaItem.id, type);
      break;
      
    case 'video':
      mediaElement = document.createElement('div');
      mediaElement.innerHTML = `
        <svg class="document-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
      `;
      mediaElement.onclick = () => openMedia(mediaItem.id, type);
      break;
  }
  
  itemDiv.appendChild(mediaElement);
  
  // Create topic label
  const topicLabel = document.createElement('div');
  topicLabel.style.fontSize = '0.8rem';
  topicLabel.style.fontWeight = 'bold';
  topicLabel.style.color = '#007bff';
  topicLabel.style.marginTop = '5px';
  topicLabel.textContent = mediaItem.topic || '';
  itemDiv.appendChild(topicLabel);
  
  // Create description element
  if (mediaItem.description) {
    const descDiv = document.createElement('div');
    descDiv.className = 'media-description';
    descDiv.textContent = mediaItem.description;
    itemDiv.appendChild(descDiv);
  }
  
  return itemDiv;
}

function openMedia(mediaId, type) {
  const customerNumber = document.getElementById('customerNumber').value;
  // Open the media in a new tab or download it
  window.open(`/api/media/${type}/${mediaId}?customerNumber=${customerNumber}`, '_blank');
}


    </script>

    
<!-- Upload Modal -->
<div id="uploadModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="width: 500px; max-width: 90%;">
    <h2>Upload Media</h2>
    
    <div class="form-group">
      <label for="fileInput"><strong>Select File:</strong></label>
      <input type="file" id="fileInput" class="wide-input">
    </div>
    
    <div class="form-group">
      <label for="topicSelect"><strong>Topic:</strong></label>
      <select id="topicSelect" class="wide-input">
        <option value="" selected>Select</option>
        <option value="Roof">Roof</option>
        <option value="Gutter">Gutter</option>
        <option value="Attic">Attic</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="mediaTypeSelect"><strong>Media Type:</strong></label>
      <select id="mediaTypeSelect" class="wide-input">
        <option value="" selected>Select</option>
        <option value="Document">Document</option>
        <option value="Image">Image</option>
        <option value="Video">Video</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="mediaDescription"><strong>Description:</strong></label>
      <textarea id="mediaDescription" rows="3" class="wide-input" style="width: 100%;" placeholder="Enter a description for this file..."></textarea>
    </div>
    
    <div class="form-group">
      <label><strong>Viewing Options:</strong></label>
      <div style="display: flex; gap: 20px; margin-top: 5px;">
        <div>
          <input type="checkbox" id="customerViewCheck" value="1">
          <label for="customerViewCheck" style="width: auto;">Customer</label>
        </div>
        <div>
          <input type="checkbox" id="internalViewCheck" value="1" checked>
          <label for="internalViewCheck" style="width: auto;">Internal Use</label>
        </div>
      </div>
    </div>
    
    <div id="uploadStatus" style="margin: 10px 0; color: #007bff; display: none;"></div>
    
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
      <button type="button" class="btn btn-primary" onclick="submitUpload()">Submit</button>
      <button type="button" class="btn btn-success" onclick="resetUploadForm()">New Upload</button>
      <button type="button" class="btn" onclick="closeUploadModal()">Finish</button>
    </div>
  </div>
</div>

<!-- View/Download Modal -->
<div id="viewDownloadModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="width: 80%; max-width: 900px; max-height: 80vh; overflow-y: auto;">
    <span onclick="closeViewDownloadModal()" style="position: absolute; top: 10px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa;">&times;</span>
    <h3>Customer Files</h3>
    
    <!-- Filter Section -->
<div style="margin: 15px 0; padding: 10px; background-color: #f5f5f5; border-radius: 5px;">
  <div style="display: flex; gap: 20px; align-items: center;">
    <span style="font-weight: bold;">Type</span>
    <div style="display: flex; flex-direction: column; align-items: center;">
      <label for="filterDocs">Docs</label>
      <input type="checkbox" id="filterDocs" checked style="margin-top: 5px;">
    </div>
    <div style="display: flex; flex-direction: column; align-items: center;">
      <label for="filterImages">Images</label>
      <input type="checkbox" id="filterImages" checked style="margin-top: 5px;">
    </div>
    <div style="display: flex; flex-direction: column; align-items: center;">
      <label for="filterVideos">Videos</label>
      <input type="checkbox" id="filterVideos" checked style="margin-top: 5px;">
    </div>
    <button onclick="applyMediaFilters()" class="btn btn-primary" style="margin-left: auto;">Apply Filters</button>
  </div>
</div>

<!-- Category Filter Section -->
<div style="margin: 15px 0; padding: 10px; background-color: #f5f5f5; border-radius: 5px;">
  <div style="display: flex; gap: 20px; align-items: center;">
    <span style="font-weight: bold;">Category</span>
    <div style="display: flex; flex-direction: column; align-items: center;">
      <label for="filterRoof">Roof</label>
      <input type="checkbox" id="filterRoof" checked style="margin-top: 5px;">
    </div>
    <div style="display: flex; flex-direction: column; align-items: center;">
      <label for="filterGutter">Gutter</label>
      <input type="checkbox" id="filterGutter" checked style="margin-top: 5px;">
    </div>
    <div style="display: flex; flex-direction: column; align-items: center;">
      <label for="filterAttic">Attic</label>
      <input type="checkbox" id="filterAttic" checked style="margin-top: 5px;">
    </div>
  </div>
</div>

    
    <!-- Documents Section -->
    <div id="documentsSection" style="margin-top: 20px;">
      <h3 style="border-bottom: 3px solid #ddd; padding-bottom: 5px;">Documents</h3>
      <div id="documentsList" style="margin-top: 10px;">
        <p class="no-items-message">No documents found</p>
      </div>
    </div>
    
    <!-- Images Section -->
    <div id="imagesSection" style="margin-top: 20px;">
      <h3 style="border-bottom: 3px solid #ddd; padding-bottom: 5px;">Images</h3>
      <div id="imagesList" style="margin-top: 10px;">
        <p class="no-items-message">No images found</p>
      </div>
    </div>
    
    <!-- Videos Section -->
    <div id="videosSection" style="margin-top: 20px;">
      <h3 style="border-bottom: 3px solid #ddd; padding-bottom: 5px;">Videos</h3>
      <div id="videosList" style="margin-top: 10px;">
        <p class="no-items-message">No videos found</p>
      </div>
    </div>
  </div>
</div>
    
    
    
    <!-- Action Buttons -->
    <div style="margin-top: 20px; display: flex; justify-content: center; gap: 15px;">
      <button onclick="saveViewSettings()" class="btn btn-primary">Save</button>
      <button onclick="goToSearch()" class="btn btn-info">Search</button>
      <button onclick="closeViewDownloadModal()" class="btn btn-secondary">Finish</button>
    </div>
  </div>
</div>




</body>
</html>
